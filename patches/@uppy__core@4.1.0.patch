diff --git a/lib/BasePlugin.d.ts b/lib/BasePlugin.d.ts
index c88be59a0b583385082abd82135786aa866dd592..5e5770c6707930406ffdbc9cb59401b51c4e687e 100644
--- a/lib/BasePlugin.d.ts
+++ b/lib/BasePlugin.d.ts
@@ -9,7 +9,7 @@
 import Translator from '@uppy/utils/lib/Translator';
 import type { I18n, Locale, OptionalPluralizeLocale } from '@uppy/utils/lib/Translator';
 import type { Body, Meta } from '@uppy/utils/lib/UppyFile';
-import type { State, UnknownPlugin, Uppy } from './Uppy.js';
+import type { State, UnknownPlugin, Uppy } from './Uppy.ts';
 export type PluginOpts = {
     locale?: Locale;
     id?: string;
diff --git a/lib/BasePlugin.js.map b/lib/BasePlugin.js.map
index 9fe4ad904f8e8bd1c1f8b606902dc61a626e1c6d..df88007ce6432065afe2f094773000450b9800e3 100644
--- a/lib/BasePlugin.js.map
+++ b/lib/BasePlugin.js.map
@@ -1 +1 @@
-{"version":3,"names":["Translator","BasePlugin","constructor","uppy","opts","getPluginState","plugins","getState","id","setPluginState","update","setState","setOptions","newOpts","undefined","i18nInit","translator","defaultLocale","locale","i18n","translate","bind","i18nArray","translateArray","addTarget","plugin","Error","install","uninstall","state","afterUpdate"],"sources":["BasePlugin.ts"],"sourcesContent":["/* eslint-disable class-methods-use-this */\n\n/**\n * Core plugin logic that all plugins share.\n *\n * BasePlugin does not contain DOM rendering so it can be used for plugins\n * without a user interface.\n *\n * See `Plugin` for the extended version with Preact rendering for interfaces.\n */\n\nimport Translator from '@uppy/utils/lib/Translator'\nimport type {\n  I18n,\n  Locale,\n  OptionalPluralizeLocale,\n} from '@uppy/utils/lib/Translator'\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\nimport type { State, UnknownPlugin, Uppy } from './Uppy.js'\n\nexport type PluginOpts = {\n  locale?: Locale\n  id?: string\n}\n\nexport type OnlyOptionals<T> = Pick<\n  T,\n  {\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    [K in keyof T]-?: {} extends Pick<T, K> ? K : never\n  }[keyof T]\n>\n\n/**\n * DefinePluginOpts marks all of the passed AlwaysDefinedKeys as “required” or “always defined”.\n */\nexport type DefinePluginOpts<\n  Opts,\n  AlwaysDefinedKeys extends keyof OnlyOptionals<Opts>,\n> = Opts & Required<Pick<Opts, AlwaysDefinedKeys>>\n\nexport default class BasePlugin<\n  Opts extends PluginOpts,\n  M extends Meta,\n  B extends Body,\n  PluginState extends Record<string, unknown> = Record<string, unknown>,\n> {\n  uppy: Uppy<M, B>\n\n  opts: Opts\n\n  id!: string\n\n  defaultLocale: OptionalPluralizeLocale\n\n  i18n!: I18n\n\n  i18nArray!: Translator['translateArray']\n\n  type!: string\n\n  VERSION!: string\n\n  constructor(uppy: Uppy<M, B>, opts?: Opts) {\n    this.uppy = uppy\n    this.opts = opts ?? ({} as Opts)\n  }\n\n  getPluginState(): PluginState {\n    const { plugins } = this.uppy.getState()\n    return (plugins?.[this.id] || {}) as PluginState\n  }\n\n  setPluginState(update?: Partial<PluginState>): void {\n    const { plugins } = this.uppy.getState()\n\n    this.uppy.setState({\n      plugins: {\n        ...plugins,\n        [this.id]: {\n          ...plugins[this.id],\n          ...update,\n        },\n      },\n    })\n  }\n\n  setOptions(newOpts: Partial<Opts>): void {\n    this.opts = { ...this.opts, ...newOpts }\n    this.setPluginState(undefined) // so that UI re-renders with new options\n    this.i18nInit()\n  }\n\n  i18nInit(): void {\n    const translator = new Translator([\n      this.defaultLocale,\n      this.uppy.locale,\n      this.opts.locale,\n    ])\n    this.i18n = translator.translate.bind(translator)\n    this.i18nArray = translator.translateArray.bind(translator)\n    this.setPluginState(undefined) // so that UI re-renders and we see the updated locale\n  }\n\n  /**\n   * Extendable methods\n   * ==================\n   * These methods are here to serve as an overview of the extendable methods as well as\n   * making them not conditional in use, such as `if (this.afterUpdate)`.\n   */\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  addTarget(plugin: UnknownPlugin<M, B>): HTMLElement | null {\n    throw new Error(\n      \"Extend the addTarget method to add your plugin to another plugin's target\",\n    )\n  }\n\n  install(): void {}\n\n  uninstall(): void {}\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  update(state: Partial<State<M, B>>): void {}\n\n  // Called after every state update, after everything's mounted. Debounced.\n  afterUpdate(): void {}\n}\n"],"mappings":"AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,OAAOA,UAAU,MAAM,4BAA4B;;AAsBnD;AACA;AACA;;AAMA,eAAe,MAAMC,UAAU,CAK7B;EAiBAC,WAAWA,CAACC,IAAgB,EAAEC,IAAW,EAAE;IACzC,IAAI,CAACD,IAAI,GAAGA,IAAI;IAChB,IAAI,CAACC,IAAI,GAAGA,IAAI,WAAJA,IAAI,GAAK,CAAC,CAAU;EAClC;EAEAC,cAAcA,CAAA,EAAgB;IAC5B,MAAM;MAAEC;IAAQ,CAAC,GAAG,IAAI,CAACH,IAAI,CAACI,QAAQ,CAAC,CAAC;IACxC,OAAQ,CAAAD,OAAO,oBAAPA,OAAO,CAAG,IAAI,CAACE,EAAE,CAAC,KAAI,CAAC,CAAC;EAClC;EAEAC,cAAcA,CAACC,MAA6B,EAAQ;IAClD,MAAM;MAAEJ;IAAQ,CAAC,GAAG,IAAI,CAACH,IAAI,CAACI,QAAQ,CAAC,CAAC;IAExC,IAAI,CAACJ,IAAI,CAACQ,QAAQ,CAAC;MACjBL,OAAO,EAAE;QACP,GAAGA,OAAO;QACV,CAAC,IAAI,CAACE,EAAE,GAAG;UACT,GAAGF,OAAO,CAAC,IAAI,CAACE,EAAE,CAAC;UACnB,GAAGE;QACL;MACF;IACF,CAAC,CAAC;EACJ;EAEAE,UAAUA,CAACC,OAAsB,EAAQ;IACvC,IAAI,CAACT,IAAI,GAAG;MAAE,GAAG,IAAI,CAACA,IAAI;MAAE,GAAGS;IAAQ,CAAC;IACxC,IAAI,CAACJ,cAAc,CAACK,SAAS,CAAC,EAAC;IAC/B,IAAI,CAACC,QAAQ,CAAC,CAAC;EACjB;EAEAA,QAAQA,CAAA,EAAS;IACf,MAAMC,UAAU,GAAG,IAAIhB,UAAU,CAAC,CAChC,IAAI,CAACiB,aAAa,EAClB,IAAI,CAACd,IAAI,CAACe,MAAM,EAChB,IAAI,CAACd,IAAI,CAACc,MAAM,CACjB,CAAC;IACF,IAAI,CAACC,IAAI,GAAGH,UAAU,CAACI,SAAS,CAACC,IAAI,CAACL,UAAU,CAAC;IACjD,IAAI,CAACM,SAAS,GAAGN,UAAU,CAACO,cAAc,CAACF,IAAI,CAACL,UAAU,CAAC;IAC3D,IAAI,CAACP,cAAc,CAACK,SAAS,CAAC,EAAC;EACjC;;EAEA;AACF;AACA;AACA;AACA;AACA;;EAEE;EACAU,SAASA,CAACC,MAA2B,EAAsB;IACzD,MAAM,IAAIC,KAAK,CACb,2EACF,CAAC;EACH;EAEAC,OAAOA,CAAA,EAAS,CAAC;EAEjBC,SAASA,CAAA,EAAS,CAAC;;EAEnB;EACAlB,MAAMA,CAACmB,KAA2B,EAAQ,CAAC;;EAE3C;EACAC,WAAWA,CAAA,EAAS,CAAC;AACvB","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["Translator","BasePlugin","constructor","uppy","opts","getPluginState","plugins","getState","id","setPluginState","update","setState","setOptions","newOpts","undefined","i18nInit","translator","defaultLocale","locale","i18n","translate","bind","i18nArray","translateArray","addTarget","plugin","Error","install","uninstall","state","afterUpdate"],"sources":["BasePlugin.ts"],"sourcesContent":["/* eslint-disable class-methods-use-this */\n\n/**\n * Core plugin logic that all plugins share.\n *\n * BasePlugin does not contain DOM rendering so it can be used for plugins\n * without a user interface.\n *\n * See `Plugin` for the extended version with Preact rendering for interfaces.\n */\n\nimport Translator from '@uppy/utils/lib/Translator'\nimport type {\n  I18n,\n  Locale,\n  OptionalPluralizeLocale,\n} from '@uppy/utils/lib/Translator'\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\nimport type { State, UnknownPlugin, Uppy } from './Uppy.ts'\n\nexport type PluginOpts = {\n  locale?: Locale\n  id?: string\n}\n\nexport type OnlyOptionals<T> = Pick<\n  T,\n  {\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    [K in keyof T]-?: {} extends Pick<T, K> ? K : never\n  }[keyof T]\n>\n\n/**\n * DefinePluginOpts marks all of the passed AlwaysDefinedKeys as “required” or “always defined”.\n */\nexport type DefinePluginOpts<\n  Opts,\n  AlwaysDefinedKeys extends keyof OnlyOptionals<Opts>,\n> = Opts & Required<Pick<Opts, AlwaysDefinedKeys>>\n\nexport default class BasePlugin<\n  Opts extends PluginOpts,\n  M extends Meta,\n  B extends Body,\n  PluginState extends Record<string, unknown> = Record<string, unknown>,\n> {\n  uppy: Uppy<M, B>\n\n  opts: Opts\n\n  id!: string\n\n  defaultLocale: OptionalPluralizeLocale\n\n  i18n!: I18n\n\n  i18nArray!: Translator['translateArray']\n\n  type!: string\n\n  VERSION!: string\n\n  constructor(uppy: Uppy<M, B>, opts?: Opts) {\n    this.uppy = uppy\n    this.opts = opts ?? ({} as Opts)\n  }\n\n  getPluginState(): PluginState {\n    const { plugins } = this.uppy.getState()\n    return (plugins?.[this.id] || {}) as PluginState\n  }\n\n  setPluginState(update?: Partial<PluginState>): void {\n    const { plugins } = this.uppy.getState()\n\n    this.uppy.setState({\n      plugins: {\n        ...plugins,\n        [this.id]: {\n          ...plugins[this.id],\n          ...update,\n        },\n      },\n    })\n  }\n\n  setOptions(newOpts: Partial<Opts>): void {\n    this.opts = { ...this.opts, ...newOpts }\n    this.setPluginState(undefined) // so that UI re-renders with new options\n    this.i18nInit()\n  }\n\n  i18nInit(): void {\n    const translator = new Translator([\n      this.defaultLocale,\n      this.uppy.locale,\n      this.opts.locale,\n    ])\n    this.i18n = translator.translate.bind(translator)\n    this.i18nArray = translator.translateArray.bind(translator)\n    this.setPluginState(undefined) // so that UI re-renders and we see the updated locale\n  }\n\n  /**\n   * Extendable methods\n   * ==================\n   * These methods are here to serve as an overview of the extendable methods as well as\n   * making them not conditional in use, such as `if (this.afterUpdate)`.\n   */\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  addTarget(plugin: UnknownPlugin<M, B>): HTMLElement | null {\n    throw new Error(\n      \"Extend the addTarget method to add your plugin to another plugin's target\",\n    )\n  }\n\n  install(): void {}\n\n  uninstall(): void {}\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  update(state: Partial<State<M, B>>): void {}\n\n  // Called after every state update, after everything's mounted. Debounced.\n  afterUpdate(): void {}\n}\n"],"mappings":"AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,OAAOA,UAAU,MAAM,4BAA4B;;AAsBnD;AACA;AACA;;AAMA,eAAe,MAAMC,UAAU,CAK7B;EAiBAC,WAAWA,CAACC,IAAgB,EAAEC,IAAW,EAAE;IACzC,IAAI,CAACD,IAAI,GAAGA,IAAI;IAChB,IAAI,CAACC,IAAI,GAAGA,IAAI,WAAJA,IAAI,GAAK,CAAC,CAAU;EAClC;EAEAC,cAAcA,CAAA,EAAgB;IAC5B,MAAM;MAAEC;IAAQ,CAAC,GAAG,IAAI,CAACH,IAAI,CAACI,QAAQ,CAAC,CAAC;IACxC,OAAQ,CAAAD,OAAO,oBAAPA,OAAO,CAAG,IAAI,CAACE,EAAE,CAAC,KAAI,CAAC,CAAC;EAClC;EAEAC,cAAcA,CAACC,MAA6B,EAAQ;IAClD,MAAM;MAAEJ;IAAQ,CAAC,GAAG,IAAI,CAACH,IAAI,CAACI,QAAQ,CAAC,CAAC;IAExC,IAAI,CAACJ,IAAI,CAACQ,QAAQ,CAAC;MACjBL,OAAO,EAAE;QACP,GAAGA,OAAO;QACV,CAAC,IAAI,CAACE,EAAE,GAAG;UACT,GAAGF,OAAO,CAAC,IAAI,CAACE,EAAE,CAAC;UACnB,GAAGE;QACL;MACF;IACF,CAAC,CAAC;EACJ;EAEAE,UAAUA,CAACC,OAAsB,EAAQ;IACvC,IAAI,CAACT,IAAI,GAAG;MAAE,GAAG,IAAI,CAACA,IAAI;MAAE,GAAGS;IAAQ,CAAC;IACxC,IAAI,CAACJ,cAAc,CAACK,SAAS,CAAC,EAAC;IAC/B,IAAI,CAACC,QAAQ,CAAC,CAAC;EACjB;EAEAA,QAAQA,CAAA,EAAS;IACf,MAAMC,UAAU,GAAG,IAAIhB,UAAU,CAAC,CAChC,IAAI,CAACiB,aAAa,EAClB,IAAI,CAACd,IAAI,CAACe,MAAM,EAChB,IAAI,CAACd,IAAI,CAACc,MAAM,CACjB,CAAC;IACF,IAAI,CAACC,IAAI,GAAGH,UAAU,CAACI,SAAS,CAACC,IAAI,CAACL,UAAU,CAAC;IACjD,IAAI,CAACM,SAAS,GAAGN,UAAU,CAACO,cAAc,CAACF,IAAI,CAACL,UAAU,CAAC;IAC3D,IAAI,CAACP,cAAc,CAACK,SAAS,CAAC,EAAC;EACjC;;EAEA;AACF;AACA;AACA;AACA;AACA;;EAEE;EACAU,SAASA,CAACC,MAA2B,EAAsB;IACzD,MAAM,IAAIC,KAAK,CACb,2EACF,CAAC;EACH;EAEAC,OAAOA,CAAA,EAAS,CAAC;EAEjBC,SAASA,CAAA,EAAS,CAAC;;EAEnB;EACAlB,MAAMA,CAACmB,KAA2B,EAAQ,CAAC;;EAE3C;EACAC,WAAWA,CAAA,EAAS,CAAC;AACvB","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/EventManager.d.ts b/lib/EventManager.d.ts
index 5a55f25308a3129e9f8ef7eaa85df2b4dcb97bf0..e786daad5433bf28e7238cab3ba8031ddb2abd32 100644
--- a/lib/EventManager.d.ts
+++ b/lib/EventManager.d.ts
@@ -1,5 +1,5 @@
 import type { Meta, Body, UppyFile } from '@uppy/utils/lib/UppyFile';
-import type { Uppy, UppyEventMap, _UppyEventMap } from './Uppy.js';
+import type { Uppy, UppyEventMap, _UppyEventMap } from './Uppy.ts';
 /**
  * Create a wrapper around an event emitter with a `remove` method to remove
  * all events that were added using the wrapped emitter.
diff --git a/lib/EventManager.js.map b/lib/EventManager.js.map
index 473526511221357954ceae6486827a0b1c8a0b08..ad51f1d86b0d0a784de048334524ad9bcf0144a8 100644
--- a/lib/EventManager.js.map
+++ b/lib/EventManager.js.map
@@ -1 +1 @@
-{"version":3,"names":["EventManager","constructor","uppy","Object","defineProperty","_uppy","writable","value","_events","_classPrivateFieldLooseBase","on","event","fn","push","remove","splice","off","onFilePause","fileID","cb","file","isPaused","id","onFileRemove","onPause","onRetry","onRetryAll","getFile","onPauseAll","onCancelAll","eventHandler","_this","arguments","onResumeAll"],"sources":["EventManager.ts"],"sourcesContent":["import type { Meta, Body, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport type { Uppy, UppyEventMap, _UppyEventMap } from './Uppy.js'\n\n/**\n * Create a wrapper around an event emitter with a `remove` method to remove\n * all events that were added using the wrapped emitter.\n */\nexport default class EventManager<M extends Meta, B extends Body> {\n  #uppy: Uppy<M, B>\n\n  #events: Array<[keyof UppyEventMap<M, B>, (...args: any[]) => void]> = []\n\n  constructor(uppy: Uppy<M, B>) {\n    this.#uppy = uppy\n  }\n\n  on<K extends keyof _UppyEventMap<M, B>>(\n    event: K,\n    fn: _UppyEventMap<M, B>[K],\n  ): Uppy<M, B>\n\n  on<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    fn: UppyEventMap<M, B>[K],\n  ): Uppy<M, B> {\n    this.#events.push([event, fn])\n    return this.#uppy.on(event as keyof _UppyEventMap<M, B>, fn)\n  }\n\n  remove(): void {\n    for (const [event, fn] of this.#events.splice(0)) {\n      this.#uppy.off(event, fn)\n    }\n  }\n\n  onFilePause(\n    fileID: UppyFile<M, B>['id'],\n    cb: (isPaused: boolean) => void,\n  ): void {\n    this.on('upload-pause', (file, isPaused) => {\n      if (fileID === file?.id) {\n        cb(isPaused)\n      }\n    })\n  }\n\n  onFileRemove(\n    fileID: UppyFile<M, B>['id'],\n    cb: (isPaused: UppyFile<M, B>['id']) => void,\n  ): void {\n    this.on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onPause(fileID: UppyFile<M, B>['id'], cb: (isPaused: boolean) => void): void {\n    this.on('upload-pause', (file, isPaused) => {\n      if (fileID === file?.id) {\n        // const isPaused = this.#uppy.pauseResume(fileID)\n        cb(isPaused)\n      }\n    })\n  }\n\n  onRetry(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('upload-retry', (file) => {\n      if (fileID === file?.id) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('retry-all', () => {\n      if (!this.#uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onPauseAll(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('pause-all', () => {\n      if (!this.#uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll(\n    fileID: UppyFile<M, B>['id'],\n    eventHandler: UppyEventMap<M, B>['cancel-all'],\n  ): void {\n    this.on('cancel-all', (...args) => {\n      if (!this.#uppy.getFile(fileID)) return\n      eventHandler(...args)\n    })\n  }\n\n  onResumeAll(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('resume-all', () => {\n      if (!this.#uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n}\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["EventManager","constructor","uppy","Object","defineProperty","_uppy","writable","value","_events","_classPrivateFieldLooseBase","on","event","fn","push","remove","splice","off","onFilePause","fileID","cb","file","isPaused","id","onFileRemove","onPause","onRetry","onRetryAll","getFile","onPauseAll","onCancelAll","eventHandler","_this","arguments","onResumeAll"],"sources":["EventManager.ts"],"sourcesContent":["import type { Meta, Body, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport type { Uppy, UppyEventMap, _UppyEventMap } from './Uppy.ts'\n\n/**\n * Create a wrapper around an event emitter with a `remove` method to remove\n * all events that were added using the wrapped emitter.\n */\nexport default class EventManager<M extends Meta, B extends Body> {\n  #uppy: Uppy<M, B>\n\n  #events: Array<[keyof UppyEventMap<M, B>, (...args: any[]) => void]> = []\n\n  constructor(uppy: Uppy<M, B>) {\n    this.#uppy = uppy\n  }\n\n  on<K extends keyof _UppyEventMap<M, B>>(\n    event: K,\n    fn: _UppyEventMap<M, B>[K],\n  ): Uppy<M, B>\n\n  on<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    fn: UppyEventMap<M, B>[K],\n  ): Uppy<M, B> {\n    this.#events.push([event, fn])\n    return this.#uppy.on(event as keyof _UppyEventMap<M, B>, fn)\n  }\n\n  remove(): void {\n    for (const [event, fn] of this.#events.splice(0)) {\n      this.#uppy.off(event, fn)\n    }\n  }\n\n  onFilePause(\n    fileID: UppyFile<M, B>['id'],\n    cb: (isPaused: boolean) => void,\n  ): void {\n    this.on('upload-pause', (file, isPaused) => {\n      if (fileID === file?.id) {\n        cb(isPaused)\n      }\n    })\n  }\n\n  onFileRemove(\n    fileID: UppyFile<M, B>['id'],\n    cb: (isPaused: UppyFile<M, B>['id']) => void,\n  ): void {\n    this.on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onPause(fileID: UppyFile<M, B>['id'], cb: (isPaused: boolean) => void): void {\n    this.on('upload-pause', (file, isPaused) => {\n      if (fileID === file?.id) {\n        // const isPaused = this.#uppy.pauseResume(fileID)\n        cb(isPaused)\n      }\n    })\n  }\n\n  onRetry(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('upload-retry', (file) => {\n      if (fileID === file?.id) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('retry-all', () => {\n      if (!this.#uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onPauseAll(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('pause-all', () => {\n      if (!this.#uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll(\n    fileID: UppyFile<M, B>['id'],\n    eventHandler: UppyEventMap<M, B>['cancel-all'],\n  ): void {\n    this.on('cancel-all', (...args) => {\n      if (!this.#uppy.getFile(fileID)) return\n      eventHandler(...args)\n    })\n  }\n\n  onResumeAll(fileID: UppyFile<M, B>['id'], cb: () => void): void {\n    this.on('resume-all', () => {\n      if (!this.#uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n}\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/Restricter.d.ts b/lib/Restricter.d.ts
index e3f67c30f188bf565a2cb30703cf119f98bc7d95..f1be47afede6a97f90d3998b03f54fa3a9be41e2 100644
--- a/lib/Restricter.d.ts
+++ b/lib/Restricter.d.ts
@@ -1,6 +1,6 @@
 import type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile';
 import type { I18n } from '@uppy/utils/lib/Translator';
-import type { State, NonNullableUppyOptions } from './Uppy.js';
+import type { State, NonNullableUppyOptions } from './Uppy.ts';
 export type Restrictions = {
     maxFileSize: number | null;
     minFileSize: number | null;
diff --git a/lib/Restricter.js.map b/lib/Restricter.js.map
index f525dee755013e7e427321921431327547bed85f..1bc50b65b0502420f00cb13ae2b7abb15fac0ada 100644
--- a/lib/Restricter.js.map
+++ b/lib/Restricter.js.map
@@ -1 +1 @@
-{"version":3,"names":["prettierBytes","match","defaultOptions","maxFileSize","minFileSize","maxTotalFileSize","maxNumberOfFiles","minNumberOfFiles","allowedFileTypes","requiredMetaFields","RestrictionError","Error","constructor","message","opts","_opts$isUserFacing","isRestriction","isUserFacing","file","Restricter","getOpts","getI18n","_opts$restrictions","restrictions","Array","isArray","TypeError","validateAggregateRestrictions","existingFiles","addingFiles","nonGhostFiles","filter","f","isGhost","length","smart_count","totalFilesSize","reduce","total","_f$size","size","sizeAllowed","validateSingleFile","isCorrectFileType","some","type","includes","replace","extension","toLowerCase","slice","allowedFileTypesString","join","types","_file$name","name","validate","forEach","addingFile","validateMinNumberOfFiles","files","Object","keys","getMissingRequiredMetaFields","_file$name2","error","fileName","missingFields","field","hasOwn","meta","push"],"sources":["Restricter.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-comment */\n/* eslint-disable max-classes-per-file, class-methods-use-this */\nimport prettierBytes from '@transloadit/prettier-bytes'\n// @ts-ignore untyped\nimport match from 'mime-match'\nimport type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport type { I18n } from '@uppy/utils/lib/Translator'\nimport type { State, NonNullableUppyOptions } from './Uppy.js'\n\nexport type Restrictions = {\n  maxFileSize: number | null\n  minFileSize: number | null\n  maxTotalFileSize: number | null\n  maxNumberOfFiles: number | null\n  minNumberOfFiles: number | null\n  allowedFileTypes: string[] | null\n  requiredMetaFields: string[]\n}\n\n/**\n * The minimal required properties to be present from UppyFile in order to validate it.\n */\nexport type ValidateableFile<M extends Meta, B extends Body> = Pick<\n  UppyFile<M, B>,\n  'type' | 'extension' | 'size' | 'name'\n  // Both UppyFile and CompanionFile need to be passable as a ValidateableFile\n  // CompanionFile's do not have `isGhost`, so we mark it optional.\n> & { isGhost?: boolean }\n\nconst defaultOptions = {\n  maxFileSize: null,\n  minFileSize: null,\n  maxTotalFileSize: null,\n  maxNumberOfFiles: null,\n  minNumberOfFiles: null,\n  allowedFileTypes: null,\n  requiredMetaFields: [],\n}\n\nclass RestrictionError<M extends Meta, B extends Body> extends Error {\n  isUserFacing: boolean\n\n  file!: UppyFile<M, B>\n\n  constructor(\n    message: string,\n    opts?: { isUserFacing?: boolean; file?: UppyFile<M, B> },\n  ) {\n    super(message)\n    this.isUserFacing = opts?.isUserFacing ?? true\n    if (opts?.file) {\n      this.file = opts.file // only some restriction errors are related to a particular file\n    }\n  }\n\n  isRestriction = true\n}\n\nclass Restricter<M extends Meta, B extends Body> {\n  getI18n: () => I18n\n\n  getOpts: () => NonNullableUppyOptions<M, B>\n\n  constructor(\n    getOpts: () => NonNullableUppyOptions<M, B>,\n    getI18n: () => I18n,\n  ) {\n    this.getI18n = getI18n\n    this.getOpts = (): NonNullableUppyOptions<M, B> => {\n      const opts = getOpts()\n\n      if (\n        opts.restrictions?.allowedFileTypes != null &&\n        !Array.isArray(opts.restrictions.allowedFileTypes)\n      ) {\n        throw new TypeError('`restrictions.allowedFileTypes` must be an array')\n      }\n      return opts\n    }\n  }\n\n  // Because these operations are slow, we cannot run them for every file (if we are adding multiple files)\n  validateAggregateRestrictions(\n    existingFiles: ValidateableFile<M, B>[],\n    addingFiles: ValidateableFile<M, B>[],\n  ): void {\n    const { maxTotalFileSize, maxNumberOfFiles } = this.getOpts().restrictions\n\n    if (maxNumberOfFiles) {\n      const nonGhostFiles = existingFiles.filter((f) => !f.isGhost)\n      if (nonGhostFiles.length + addingFiles.length > maxNumberOfFiles) {\n        throw new RestrictionError(\n          `${this.getI18n()('youCanOnlyUploadX', {\n            smart_count: maxNumberOfFiles,\n          })}`,\n        )\n      }\n    }\n\n    if (maxTotalFileSize) {\n      const totalFilesSize = [...existingFiles, ...addingFiles].reduce(\n        (total, f) => total + (f.size ?? 0),\n        0,\n      )\n      if (totalFilesSize > maxTotalFileSize) {\n        throw new RestrictionError(\n          this.getI18n()('aggregateExceedsSize', {\n            sizeAllowed: prettierBytes(maxTotalFileSize),\n            size: prettierBytes(totalFilesSize),\n          }),\n        )\n      }\n    }\n  }\n\n  validateSingleFile(file: ValidateableFile<M, B>): void {\n    const { maxFileSize, minFileSize, allowedFileTypes } =\n      this.getOpts().restrictions\n\n    if (allowedFileTypes) {\n      const isCorrectFileType = allowedFileTypes.some((type) => {\n        // check if this is a mime-type\n        if (type.includes('/')) {\n          if (!file.type) return false\n          return match(file.type.replace(/;.*?$/, ''), type)\n        }\n\n        // otherwise this is likely an extension\n        if (type[0] === '.' && file.extension) {\n          return file.extension.toLowerCase() === type.slice(1).toLowerCase()\n        }\n        return false\n      })\n\n      if (!isCorrectFileType) {\n        const allowedFileTypesString = allowedFileTypes.join(', ')\n        throw new RestrictionError(\n          this.getI18n()('youCanOnlyUploadFileTypes', {\n            types: allowedFileTypesString,\n          }),\n          { file } as { file: UppyFile<M, B> },\n        )\n      }\n    }\n\n    // We can't check maxFileSize if the size is unknown.\n    if (maxFileSize && file.size != null && file.size > maxFileSize) {\n      throw new RestrictionError(\n        this.getI18n()('exceedsSize', {\n          size: prettierBytes(maxFileSize),\n          file: file.name ?? this.getI18n()('unnamed'),\n        }),\n        { file } as { file: UppyFile<M, B> },\n      )\n    }\n\n    // We can't check minFileSize if the size is unknown.\n    if (minFileSize && file.size != null && file.size < minFileSize) {\n      throw new RestrictionError(\n        this.getI18n()('inferiorSize', {\n          size: prettierBytes(minFileSize),\n        }),\n        { file } as { file: UppyFile<M, B> },\n      )\n    }\n  }\n\n  validate(\n    existingFiles: ValidateableFile<M, B>[],\n    addingFiles: ValidateableFile<M, B>[],\n  ): void {\n    addingFiles.forEach((addingFile) => {\n      this.validateSingleFile(addingFile)\n    })\n    this.validateAggregateRestrictions(existingFiles, addingFiles)\n  }\n\n  validateMinNumberOfFiles(files: State<M, B>['files']): void {\n    const { minNumberOfFiles } = this.getOpts().restrictions\n    if (minNumberOfFiles && Object.keys(files).length < minNumberOfFiles) {\n      throw new RestrictionError(\n        this.getI18n()('youHaveToAtLeastSelectX', {\n          smart_count: minNumberOfFiles,\n        }),\n      )\n    }\n  }\n\n  getMissingRequiredMetaFields(file: ValidateableFile<M, B> & { meta: M }): {\n    missingFields: string[]\n    error: RestrictionError<M, B>\n  } {\n    const error = new RestrictionError<M, B>(\n      this.getI18n()('missingRequiredMetaFieldOnFile', {\n        fileName: file.name ?? this.getI18n()('unnamed'),\n      }),\n    )\n    const { requiredMetaFields } = this.getOpts().restrictions\n    const missingFields: string[] = []\n\n    for (const field of requiredMetaFields) {\n      if (!Object.hasOwn(file.meta, field) || file.meta[field] === '') {\n        missingFields.push(field)\n      }\n    }\n\n    return { missingFields, error }\n  }\n}\n\nexport { Restricter, defaultOptions, RestrictionError }\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["prettierBytes","match","defaultOptions","maxFileSize","minFileSize","maxTotalFileSize","maxNumberOfFiles","minNumberOfFiles","allowedFileTypes","requiredMetaFields","RestrictionError","Error","constructor","message","opts","_opts$isUserFacing","isRestriction","isUserFacing","file","Restricter","getOpts","getI18n","_opts$restrictions","restrictions","Array","isArray","TypeError","validateAggregateRestrictions","existingFiles","addingFiles","nonGhostFiles","filter","f","isGhost","length","smart_count","totalFilesSize","reduce","total","_f$size","size","sizeAllowed","validateSingleFile","isCorrectFileType","some","type","includes","replace","extension","toLowerCase","slice","allowedFileTypesString","join","types","_file$name","name","validate","forEach","addingFile","validateMinNumberOfFiles","files","Object","keys","getMissingRequiredMetaFields","_file$name2","error","fileName","missingFields","field","hasOwn","meta","push"],"sources":["Restricter.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-comment */\n/* eslint-disable max-classes-per-file, class-methods-use-this */\nimport prettierBytes from '@transloadit/prettier-bytes'\n// @ts-ignore untyped\nimport match from 'mime-match'\nimport type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport type { I18n } from '@uppy/utils/lib/Translator'\nimport type { State, NonNullableUppyOptions } from './Uppy.ts'\n\nexport type Restrictions = {\n  maxFileSize: number | null\n  minFileSize: number | null\n  maxTotalFileSize: number | null\n  maxNumberOfFiles: number | null\n  minNumberOfFiles: number | null\n  allowedFileTypes: string[] | null\n  requiredMetaFields: string[]\n}\n\n/**\n * The minimal required properties to be present from UppyFile in order to validate it.\n */\nexport type ValidateableFile<M extends Meta, B extends Body> = Pick<\n  UppyFile<M, B>,\n  'type' | 'extension' | 'size' | 'name'\n  // Both UppyFile and CompanionFile need to be passable as a ValidateableFile\n  // CompanionFile's do not have `isGhost`, so we mark it optional.\n> & { isGhost?: boolean }\n\nconst defaultOptions = {\n  maxFileSize: null,\n  minFileSize: null,\n  maxTotalFileSize: null,\n  maxNumberOfFiles: null,\n  minNumberOfFiles: null,\n  allowedFileTypes: null,\n  requiredMetaFields: [],\n}\n\nclass RestrictionError<M extends Meta, B extends Body> extends Error {\n  isUserFacing: boolean\n\n  file!: UppyFile<M, B>\n\n  constructor(\n    message: string,\n    opts?: { isUserFacing?: boolean; file?: UppyFile<M, B> },\n  ) {\n    super(message)\n    this.isUserFacing = opts?.isUserFacing ?? true\n    if (opts?.file) {\n      this.file = opts.file // only some restriction errors are related to a particular file\n    }\n  }\n\n  isRestriction = true\n}\n\nclass Restricter<M extends Meta, B extends Body> {\n  getI18n: () => I18n\n\n  getOpts: () => NonNullableUppyOptions<M, B>\n\n  constructor(\n    getOpts: () => NonNullableUppyOptions<M, B>,\n    getI18n: () => I18n,\n  ) {\n    this.getI18n = getI18n\n    this.getOpts = (): NonNullableUppyOptions<M, B> => {\n      const opts = getOpts()\n\n      if (\n        opts.restrictions?.allowedFileTypes != null &&\n        !Array.isArray(opts.restrictions.allowedFileTypes)\n      ) {\n        throw new TypeError('`restrictions.allowedFileTypes` must be an array')\n      }\n      return opts\n    }\n  }\n\n  // Because these operations are slow, we cannot run them for every file (if we are adding multiple files)\n  validateAggregateRestrictions(\n    existingFiles: ValidateableFile<M, B>[],\n    addingFiles: ValidateableFile<M, B>[],\n  ): void {\n    const { maxTotalFileSize, maxNumberOfFiles } = this.getOpts().restrictions\n\n    if (maxNumberOfFiles) {\n      const nonGhostFiles = existingFiles.filter((f) => !f.isGhost)\n      if (nonGhostFiles.length + addingFiles.length > maxNumberOfFiles) {\n        throw new RestrictionError(\n          `${this.getI18n()('youCanOnlyUploadX', {\n            smart_count: maxNumberOfFiles,\n          })}`,\n        )\n      }\n    }\n\n    if (maxTotalFileSize) {\n      const totalFilesSize = [...existingFiles, ...addingFiles].reduce(\n        (total, f) => total + (f.size ?? 0),\n        0,\n      )\n      if (totalFilesSize > maxTotalFileSize) {\n        throw new RestrictionError(\n          this.getI18n()('aggregateExceedsSize', {\n            sizeAllowed: prettierBytes(maxTotalFileSize),\n            size: prettierBytes(totalFilesSize),\n          }),\n        )\n      }\n    }\n  }\n\n  validateSingleFile(file: ValidateableFile<M, B>): void {\n    const { maxFileSize, minFileSize, allowedFileTypes } =\n      this.getOpts().restrictions\n\n    if (allowedFileTypes) {\n      const isCorrectFileType = allowedFileTypes.some((type) => {\n        // check if this is a mime-type\n        if (type.includes('/')) {\n          if (!file.type) return false\n          return match(file.type.replace(/;.*?$/, ''), type)\n        }\n\n        // otherwise this is likely an extension\n        if (type[0] === '.' && file.extension) {\n          return file.extension.toLowerCase() === type.slice(1).toLowerCase()\n        }\n        return false\n      })\n\n      if (!isCorrectFileType) {\n        const allowedFileTypesString = allowedFileTypes.join(', ')\n        throw new RestrictionError(\n          this.getI18n()('youCanOnlyUploadFileTypes', {\n            types: allowedFileTypesString,\n          }),\n          { file } as { file: UppyFile<M, B> },\n        )\n      }\n    }\n\n    // We can't check maxFileSize if the size is unknown.\n    if (maxFileSize && file.size != null && file.size > maxFileSize) {\n      throw new RestrictionError(\n        this.getI18n()('exceedsSize', {\n          size: prettierBytes(maxFileSize),\n          file: file.name ?? this.getI18n()('unnamed'),\n        }),\n        { file } as { file: UppyFile<M, B> },\n      )\n    }\n\n    // We can't check minFileSize if the size is unknown.\n    if (minFileSize && file.size != null && file.size < minFileSize) {\n      throw new RestrictionError(\n        this.getI18n()('inferiorSize', {\n          size: prettierBytes(minFileSize),\n        }),\n        { file } as { file: UppyFile<M, B> },\n      )\n    }\n  }\n\n  validate(\n    existingFiles: ValidateableFile<M, B>[],\n    addingFiles: ValidateableFile<M, B>[],\n  ): void {\n    addingFiles.forEach((addingFile) => {\n      this.validateSingleFile(addingFile)\n    })\n    this.validateAggregateRestrictions(existingFiles, addingFiles)\n  }\n\n  validateMinNumberOfFiles(files: State<M, B>['files']): void {\n    const { minNumberOfFiles } = this.getOpts().restrictions\n    if (minNumberOfFiles && Object.keys(files).length < minNumberOfFiles) {\n      throw new RestrictionError(\n        this.getI18n()('youHaveToAtLeastSelectX', {\n          smart_count: minNumberOfFiles,\n        }),\n      )\n    }\n  }\n\n  getMissingRequiredMetaFields(file: ValidateableFile<M, B> & { meta: M }): {\n    missingFields: string[]\n    error: RestrictionError<M, B>\n  } {\n    const error = new RestrictionError<M, B>(\n      this.getI18n()('missingRequiredMetaFieldOnFile', {\n        fileName: file.name ?? this.getI18n()('unnamed'),\n      }),\n    )\n    const { requiredMetaFields } = this.getOpts().restrictions\n    const missingFields: string[] = []\n\n    for (const field of requiredMetaFields) {\n      if (!Object.hasOwn(file.meta, field) || file.meta[field] === '') {\n        missingFields.push(field)\n      }\n    }\n\n    return { missingFields, error }\n  }\n}\n\nexport { Restricter, defaultOptions, RestrictionError }\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/UIPlugin.d.ts b/lib/UIPlugin.d.ts
index d1728a7b969506c6378defcde48192e09a115eb7..97c896a64ecbcf27212d0c25353f083242c37ef6 100644
--- a/lib/UIPlugin.d.ts
+++ b/lib/UIPlugin.d.ts
@@ -1,8 +1,8 @@
 import { type ComponentChild } from 'preact';
 import type { Body, Meta } from '@uppy/utils/lib/UppyFile';
 import BasePlugin from './BasePlugin.ts';
-import type { PluginOpts } from './BasePlugin.js';
-import type { State } from './Uppy.js';
+import type { PluginOpts } from './BasePlugin.ts';
+import type { State } from './Uppy.ts';
 /**
  * UIPlugin is the extended version of BasePlugin to incorporate rendering with Preact.
  * Use this for plugins that need a user interface.
diff --git a/lib/UIPlugin.js.map b/lib/UIPlugin.js.map
index f96aa329ccc901e9ea4edd0994f0c9620af066a1..0ee8bde3904ab855937f6a2aa976f61f6d294e03 100644
--- a/lib/UIPlugin.js.map
+++ b/lib/UIPlugin.js.map
@@ -1 +1 @@
-{"version":3,"names":["render","findDOMElement","getTextDirection","BasePlugin","debounce","fn","calling","latestArgs","_len","arguments","length","args","Array","_key","Promise","resolve","then","_updateUI","_classPrivateFieldLooseKey","UIPlugin","constructor","Object","defineProperty","writable","value","getTargetPlugin","target","targetPlugin","addTarget","console","warn","Error","cause","Target","uppy","iteratePlugins","p","mount","plugin","callerPluginName","id","targetElement","isTargetDOMEl","uppyRootElement","document","createElement","classList","add","_classPrivateFieldLooseBase","state","getPlugin","afterUpdate","log","opts","replaceTargetContent","innerHTML","getState","el","appendChild","dir","direction","onMount","parent","message","update","_classPrivateFieldLoo","_classPrivateFieldLoo2","call","unmount","_this$el","remove","onUnmount"],"sources":["UIPlugin.ts"],"sourcesContent":["/* eslint-disable class-methods-use-this */\nimport { render, type ComponentChild } from 'preact'\nimport findDOMElement from '@uppy/utils/lib/findDOMElement'\nimport getTextDirection from '@uppy/utils/lib/getTextDirection'\n\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\nimport BasePlugin from './BasePlugin.ts'\nimport type { PluginOpts } from './BasePlugin.js'\nimport type { State } from './Uppy.js'\n\n/**\n * Defer a frequent call to the microtask queue.\n */\nfunction debounce<T extends (...args: any[]) => any>(\n  fn: T,\n): (...args: Parameters<T>) => Promise<ReturnType<T>> {\n  let calling: Promise<ReturnType<T>> | null = null\n  let latestArgs: Parameters<T>\n  return (...args) => {\n    latestArgs = args\n    if (!calling) {\n      calling = Promise.resolve().then(() => {\n        calling = null\n        // At this point `args` may be different from the most\n        // recent state, if multiple calls happened since this task\n        // was queued. So we use the `latestArgs`, which definitely\n        // is the most recent call.\n        return fn(...latestArgs)\n      })\n    }\n    return calling\n  }\n}\n\n/**\n * UIPlugin is the extended version of BasePlugin to incorporate rendering with Preact.\n * Use this for plugins that need a user interface.\n *\n * For plugins without an user interface, see BasePlugin.\n */\nclass UIPlugin<\n  // eslint-disable-next-line no-use-before-define\n  Opts extends UIPluginOptions,\n  M extends Meta,\n  B extends Body,\n  PluginState extends Record<string, unknown> = Record<string, unknown>,\n> extends BasePlugin<Opts, M, B, PluginState> {\n  #updateUI!: (state: Partial<State<M, B>>) => void\n\n  isTargetDOMEl!: boolean\n\n  el!: HTMLElement | null\n\n  parent: unknown\n\n  title!: string\n\n  getTargetPlugin<Me extends Meta, Bo extends Body>(\n    target: PluginTarget<Me, Bo>, // eslint-disable-line no-use-before-define\n  ): UIPlugin<any, Me, Bo> | undefined {\n    let targetPlugin\n    if (typeof (target as UIPlugin<any, any, any>)?.addTarget === 'function') {\n      // Targeting a plugin *instance*\n      targetPlugin = target as UIPlugin<any, any, any>\n      if (!(targetPlugin instanceof UIPlugin)) {\n        // eslint-disable-next-line no-console\n        console.warn(\n          new Error(\n            'The provided plugin is not an instance of UIPlugin. This is an indication of a bug with the way Uppy is bundled.',\n            { cause: { targetPlugin, UIPlugin } },\n          ),\n        )\n      }\n    } else if (typeof target === 'function') {\n      // Targeting a plugin type\n      const Target = target\n      // Find the target plugin instance.\n      this.uppy.iteratePlugins((p) => {\n        if (p instanceof Target) {\n          targetPlugin = p\n        }\n      })\n    }\n\n    return targetPlugin\n  }\n\n  /**\n   * Check if supplied `target` is a DOM element or an `object`.\n   * If it’s an object — target is a plugin, and we search `plugins`\n   * for a plugin with same name and return its target.\n   */\n  mount<Me extends Meta, Bo extends Body>(\n    target: PluginTarget<Me, Bo>, // eslint-disable-line no-use-before-define\n    plugin: UIPlugin<any, Me, Bo>,\n  ): HTMLElement {\n    const callerPluginName = plugin.id\n\n    const targetElement = findDOMElement(target)\n\n    if (targetElement) {\n      this.isTargetDOMEl = true\n      // When target is <body> with a single <div> element,\n      // Preact thinks it’s the Uppy root element in there when doing a diff,\n      // and destroys it. So we are creating a fragment (could be empty div)\n      const uppyRootElement = document.createElement('div')\n      uppyRootElement.classList.add('uppy-Root')\n\n      // API for plugins that require a synchronous rerender.\n      this.#updateUI = debounce((state) => {\n        // plugin could be removed, but this.rerender is debounced below,\n        // so it could still be called even after uppy.removePlugin or uppy.destroy\n        // hence the check\n        if (!this.uppy.getPlugin(this.id)) return\n        render(this.render(state), uppyRootElement)\n        this.afterUpdate()\n      })\n\n      this.uppy.log(\n        `Installing ${callerPluginName} to a DOM element '${target}'`,\n      )\n\n      if (this.opts.replaceTargetContent) {\n        // Doing render(h(null), targetElement), which should have been\n        // a better way, since because the component might need to do additional cleanup when it is removed,\n        // stopped working — Preact just adds null into target, not replacing\n        targetElement.innerHTML = ''\n      }\n\n      render(this.render(this.uppy.getState()), uppyRootElement)\n      this.el = uppyRootElement\n      targetElement.appendChild(uppyRootElement)\n\n      // Set the text direction if the page has not defined one.\n      uppyRootElement.dir =\n        this.opts.direction || getTextDirection(uppyRootElement) || 'ltr'\n\n      this.onMount()\n\n      return this.el!\n    }\n\n    const targetPlugin = this.getTargetPlugin(target)\n\n    if (targetPlugin) {\n      this.uppy.log(`Installing ${callerPluginName} to ${targetPlugin.id}`)\n      this.parent = targetPlugin\n      this.el = targetPlugin.addTarget(plugin)\n\n      this.onMount()\n      return this.el!\n    }\n\n    this.uppy.log(`Not installing ${callerPluginName}`)\n\n    let message = `Invalid target option given to ${callerPluginName}.`\n    if (typeof target === 'function') {\n      message +=\n        ' The given target is not a Plugin class. ' +\n        \"Please check that you're not specifying a React Component instead of a plugin. \" +\n        'If you are using @uppy/* packages directly, make sure you have only 1 version of @uppy/core installed: ' +\n        'run `npm ls @uppy/core` on the command line and verify that all the versions match and are deduped correctly.'\n    } else {\n      message +=\n        'If you meant to target an HTML element, please make sure that the element exists. ' +\n        'Check that the <script> tag initializing Uppy is right before the closing </body> tag at the end of the page. ' +\n        '(see https://github.com/transloadit/uppy/issues/1042)\\n\\n' +\n        'If you meant to target a plugin, please confirm that your `import` statements or `require` calls are correct.'\n    }\n    throw new Error(message)\n  }\n\n  /**\n   * Called when plugin is mounted, whether in DOM or into another plugin.\n   * Needed because sometimes plugins are mounted separately/after `install`,\n   * so this.el and this.parent might not be available in `install`.\n   * This is the case with @uppy/react plugins, for example.\n   */\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  render(state: Record<string, unknown>): ComponentChild {\n    throw new Error(\n      'Extend the render method to add your plugin to a DOM element',\n    )\n  }\n\n  update(state: Partial<State<M, B>>): void {\n    if (this.el != null) {\n      this.#updateUI?.(state)\n    }\n  }\n\n  unmount(): void {\n    if (this.isTargetDOMEl) {\n      this.el?.remove()\n    }\n    this.onUnmount()\n  }\n\n  onMount(): void {}\n\n  onUnmount(): void {}\n}\n\nexport default UIPlugin\n\nexport type PluginTarget<M extends Meta, B extends Body> =\n  | string\n  | Element\n  | typeof BasePlugin\n  | typeof UIPlugin\n  | BasePlugin<any, M, B>\n\nexport interface UIPluginOptions extends PluginOpts {\n  target?: PluginTarget<any, any>\n  replaceTargetContent?: boolean\n  direction?: 'ltr' | 'rtl'\n}\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["render","findDOMElement","getTextDirection","BasePlugin","debounce","fn","calling","latestArgs","_len","arguments","length","args","Array","_key","Promise","resolve","then","_updateUI","_classPrivateFieldLooseKey","UIPlugin","constructor","Object","defineProperty","writable","value","getTargetPlugin","target","targetPlugin","addTarget","console","warn","Error","cause","Target","uppy","iteratePlugins","p","mount","plugin","callerPluginName","id","targetElement","isTargetDOMEl","uppyRootElement","document","createElement","classList","add","_classPrivateFieldLooseBase","state","getPlugin","afterUpdate","log","opts","replaceTargetContent","innerHTML","getState","el","appendChild","dir","direction","onMount","parent","message","update","_classPrivateFieldLoo","_classPrivateFieldLoo2","call","unmount","_this$el","remove","onUnmount"],"sources":["UIPlugin.ts"],"sourcesContent":["/* eslint-disable class-methods-use-this */\nimport { render, type ComponentChild } from 'preact'\nimport findDOMElement from '@uppy/utils/lib/findDOMElement'\nimport getTextDirection from '@uppy/utils/lib/getTextDirection'\n\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\nimport BasePlugin from './BasePlugin.ts'\nimport type { PluginOpts } from './BasePlugin.ts'\nimport type { State } from './Uppy.ts'\n\n/**\n * Defer a frequent call to the microtask queue.\n */\nfunction debounce<T extends (...args: any[]) => any>(\n  fn: T,\n): (...args: Parameters<T>) => Promise<ReturnType<T>> {\n  let calling: Promise<ReturnType<T>> | null = null\n  let latestArgs: Parameters<T>\n  return (...args) => {\n    latestArgs = args\n    if (!calling) {\n      calling = Promise.resolve().then(() => {\n        calling = null\n        // At this point `args` may be different from the most\n        // recent state, if multiple calls happened since this task\n        // was queued. So we use the `latestArgs`, which definitely\n        // is the most recent call.\n        return fn(...latestArgs)\n      })\n    }\n    return calling\n  }\n}\n\n/**\n * UIPlugin is the extended version of BasePlugin to incorporate rendering with Preact.\n * Use this for plugins that need a user interface.\n *\n * For plugins without an user interface, see BasePlugin.\n */\nclass UIPlugin<\n  // eslint-disable-next-line no-use-before-define\n  Opts extends UIPluginOptions,\n  M extends Meta,\n  B extends Body,\n  PluginState extends Record<string, unknown> = Record<string, unknown>,\n> extends BasePlugin<Opts, M, B, PluginState> {\n  #updateUI!: (state: Partial<State<M, B>>) => void\n\n  isTargetDOMEl!: boolean\n\n  el!: HTMLElement | null\n\n  parent: unknown\n\n  title!: string\n\n  getTargetPlugin<Me extends Meta, Bo extends Body>(\n    target: PluginTarget<Me, Bo>, // eslint-disable-line no-use-before-define\n  ): UIPlugin<any, Me, Bo> | undefined {\n    let targetPlugin\n    if (typeof (target as UIPlugin<any, any, any>)?.addTarget === 'function') {\n      // Targeting a plugin *instance*\n      targetPlugin = target as UIPlugin<any, any, any>\n      if (!(targetPlugin instanceof UIPlugin)) {\n        // eslint-disable-next-line no-console\n        console.warn(\n          new Error(\n            'The provided plugin is not an instance of UIPlugin. This is an indication of a bug with the way Uppy is bundled.',\n            { cause: { targetPlugin, UIPlugin } },\n          ),\n        )\n      }\n    } else if (typeof target === 'function') {\n      // Targeting a plugin type\n      const Target = target\n      // Find the target plugin instance.\n      this.uppy.iteratePlugins((p) => {\n        if (p instanceof Target) {\n          targetPlugin = p\n        }\n      })\n    }\n\n    return targetPlugin\n  }\n\n  /**\n   * Check if supplied `target` is a DOM element or an `object`.\n   * If it’s an object — target is a plugin, and we search `plugins`\n   * for a plugin with same name and return its target.\n   */\n  mount<Me extends Meta, Bo extends Body>(\n    target: PluginTarget<Me, Bo>, // eslint-disable-line no-use-before-define\n    plugin: UIPlugin<any, Me, Bo>,\n  ): HTMLElement {\n    const callerPluginName = plugin.id\n\n    const targetElement = findDOMElement(target)\n\n    if (targetElement) {\n      this.isTargetDOMEl = true\n      // When target is <body> with a single <div> element,\n      // Preact thinks it’s the Uppy root element in there when doing a diff,\n      // and destroys it. So we are creating a fragment (could be empty div)\n      const uppyRootElement = document.createElement('div')\n      uppyRootElement.classList.add('uppy-Root')\n\n      // API for plugins that require a synchronous rerender.\n      this.#updateUI = debounce((state) => {\n        // plugin could be removed, but this.rerender is debounced below,\n        // so it could still be called even after uppy.removePlugin or uppy.destroy\n        // hence the check\n        if (!this.uppy.getPlugin(this.id)) return\n        render(this.render(state), uppyRootElement)\n        this.afterUpdate()\n      })\n\n      this.uppy.log(\n        `Installing ${callerPluginName} to a DOM element '${target}'`,\n      )\n\n      if (this.opts.replaceTargetContent) {\n        // Doing render(h(null), targetElement), which should have been\n        // a better way, since because the component might need to do additional cleanup when it is removed,\n        // stopped working — Preact just adds null into target, not replacing\n        targetElement.innerHTML = ''\n      }\n\n      render(this.render(this.uppy.getState()), uppyRootElement)\n      this.el = uppyRootElement\n      targetElement.appendChild(uppyRootElement)\n\n      // Set the text direction if the page has not defined one.\n      uppyRootElement.dir =\n        this.opts.direction || getTextDirection(uppyRootElement) || 'ltr'\n\n      this.onMount()\n\n      return this.el!\n    }\n\n    const targetPlugin = this.getTargetPlugin(target)\n\n    if (targetPlugin) {\n      this.uppy.log(`Installing ${callerPluginName} to ${targetPlugin.id}`)\n      this.parent = targetPlugin\n      this.el = targetPlugin.addTarget(plugin)\n\n      this.onMount()\n      return this.el!\n    }\n\n    this.uppy.log(`Not installing ${callerPluginName}`)\n\n    let message = `Invalid target option given to ${callerPluginName}.`\n    if (typeof target === 'function') {\n      message +=\n        ' The given target is not a Plugin class. ' +\n        \"Please check that you're not specifying a React Component instead of a plugin. \" +\n        'If you are using @uppy/* packages directly, make sure you have only 1 version of @uppy/core installed: ' +\n        'run `npm ls @uppy/core` on the command line and verify that all the versions match and are deduped correctly.'\n    } else {\n      message +=\n        'If you meant to target an HTML element, please make sure that the element exists. ' +\n        'Check that the <script> tag initializing Uppy is right before the closing </body> tag at the end of the page. ' +\n        '(see https://github.com/transloadit/uppy/issues/1042)\\n\\n' +\n        'If you meant to target a plugin, please confirm that your `import` statements or `require` calls are correct.'\n    }\n    throw new Error(message)\n  }\n\n  /**\n   * Called when plugin is mounted, whether in DOM or into another plugin.\n   * Needed because sometimes plugins are mounted separately/after `install`,\n   * so this.el and this.parent might not be available in `install`.\n   * This is the case with @uppy/react plugins, for example.\n   */\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  render(state: Record<string, unknown>): ComponentChild {\n    throw new Error(\n      'Extend the render method to add your plugin to a DOM element',\n    )\n  }\n\n  update(state: Partial<State<M, B>>): void {\n    if (this.el != null) {\n      this.#updateUI?.(state)\n    }\n  }\n\n  unmount(): void {\n    if (this.isTargetDOMEl) {\n      this.el?.remove()\n    }\n    this.onUnmount()\n  }\n\n  onMount(): void {}\n\n  onUnmount(): void {}\n}\n\nexport default UIPlugin\n\nexport type PluginTarget<M extends Meta, B extends Body> =\n  | string\n  | Element\n  | typeof BasePlugin\n  | typeof UIPlugin\n  | BasePlugin<any, M, B>\n\nexport interface UIPluginOptions extends PluginOpts {\n  target?: PluginTarget<any, any>\n  replaceTargetContent?: boolean\n  direction?: 'ltr' | 'rtl'\n}\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/Uppy.d.ts b/lib/Uppy.d.ts
index d3687fa093e7a102fdb199b493061f34a1db5de2..e2a065046a03f3a70bbf0ad2ac6139b0b956b710 100644
--- a/lib/Uppy.d.ts
+++ b/lib/Uppy.d.ts
@@ -8,8 +8,8 @@ import type { CompanionClientProvider, CompanionClientSearchProvider } from '@up
 import type { FileProgressStarted } from '@uppy/utils/lib/FileProgress';
 import type { Locale, I18n, OptionalPluralizeLocale } from '@uppy/utils/lib/Translator';
 import { debugLogger } from './loggers.ts';
-import type BasePlugin from './BasePlugin.js';
-import type { Restrictions, ValidateableFile } from './Restricter.js';
+import type BasePlugin from './BasePlugin.ts';
+import type { Restrictions, ValidateableFile } from './Restricter.ts';
 type Processor = (fileIDs: string[], uploadID: string) => Promise<unknown> | void;
 type LogLevel = 'info' | 'warning' | 'error' | 'success';
 export type UnknownPlugin<M extends Meta, B extends Body, PluginState extends Record<string, unknown> = Record<string, unknown>> = BasePlugin<any, M, B, PluginState>;
@@ -211,6 +211,12 @@ export interface _UppyEventMap<M extends Meta, B extends Body> {
         message: string;
         details?: string;
     }, response?: Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'> | undefined) => void;
+    'modify-upload-error': (file: UppyFile<M, B> | undefined, error: {
+        name: string;
+        message: string;
+        request: XMLHttpRequest;
+        details?: string;
+    }, response?: Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'> | undefined) => void;
     'upload-pause': (file: UppyFile<M, B> | undefined, isPaused: boolean) => void;
     'upload-progress': (file: UppyFile<M, B> | undefined, progress: FileProgressStarted) => void;
     'upload-retry': (file: UppyFile<M, B>) => void;
diff --git a/lib/Uppy.d.ts.map b/lib/Uppy.d.ts.map
index 19fd075e451103ed1d7f8d1bbf970cc6acfc326b..67609c9c2c899e1ed63d7e62d55a919becc92852 100644
--- a/lib/Uppy.d.ts.map
+++ b/lib/Uppy.d.ts.map
@@ -1 +1 @@
-{"version":3,"file":"Uppy.d.ts","sourceRoot":"","sources":["../src/Uppy.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
+{"version":3,"file":"Uppy.d.ts","sourceRoot":"","sources":["../src/Uppy.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
diff --git a/lib/Uppy.js b/lib/Uppy.js
index f56f0c0517ad59026d6f94398b9dcc9933cb19e7..036e2dd540f6037b49791e16b338cd2797df80de 100644
--- a/lib/Uppy.js
+++ b/lib/Uppy.js
@@ -16,6 +16,7 @@ import getFileNameAndExtension from '@uppy/utils/lib/getFileNameAndExtension';
 import { getSafeFileId } from '@uppy/utils/lib/generateFileID';
 import supportsUploadProgress from "./supportsUploadProgress.js";
 import getFileName from "./getFileName.js";
+import getFilePlugins from "./getFilePlugins.js";
 import { justErrorsLogger, debugLogger } from "./loggers.js";
 import { Restricter, defaultOptions as defaultRestrictionOptions, RestrictionError } from "./Restricter.js";
 // eslint-disable-next-line @typescript-eslint/ban-ts-comment
@@ -90,6 +91,7 @@ var _emitter = /*#__PURE__*/_classPrivateFieldLooseKey("emitter");
 var _preProcessors = /*#__PURE__*/_classPrivateFieldLooseKey("preProcessors");
 var _uploaders = /*#__PURE__*/_classPrivateFieldLooseKey("uploaders");
 var _postProcessors = /*#__PURE__*/_classPrivateFieldLooseKey("postProcessors");
+var _installingPlugin = /*#__PURE__*/_classPrivateFieldLooseKey("installingPlugin");
 var _informAndEmit = /*#__PURE__*/_classPrivateFieldLooseKey("informAndEmit");
 var _checkRequiredMetaFieldsOnFile = /*#__PURE__*/_classPrivateFieldLooseKey("checkRequiredMetaFieldsOnFile");
 var _checkRequiredMetaFields = /*#__PURE__*/_classPrivateFieldLooseKey("checkRequiredMetaFields");
@@ -186,12 +188,16 @@ export class Uppy {
     });
     Object.defineProperty(this, _uploaders, {
       writable: true,
-      value: new Set()
+      value: new Map()
     });
     Object.defineProperty(this, _postProcessors, {
       writable: true,
       value: new Set()
     });
+    Object.defineProperty(this, _installingPlugin, {
+      writable: true,
+      value: void 0
+    });
     this.scheduledAutoProceed = null;
     this.wasOffline = false;
     // ___Why throttle at 500ms?
@@ -466,7 +472,8 @@ export class Uppy {
     return _classPrivateFieldLooseBase(this, _postProcessors)[_postProcessors].delete(fn);
   }
   addUploader(fn) {
-    _classPrivateFieldLooseBase(this, _uploaders)[_uploaders].add(fn);
+    var _classPrivateFieldLoo;
+    _classPrivateFieldLooseBase(this, _uploaders)[_uploaders].set(fn, (_classPrivateFieldLoo = _classPrivateFieldLooseBase(this, _installingPlugin)[_installingPlugin]) != null ? _classPrivateFieldLoo : '');
   }
   removeUploader(fn) {
     return _classPrivateFieldLooseBase(this, _uploaders)[_uploaders].delete(fn);
@@ -1001,7 +1008,9 @@ export class Uppy {
     } else {
       _classPrivateFieldLooseBase(this, _plugins)[_plugins][plugin.type] = [plugin];
     }
+    _classPrivateFieldLooseBase(this, _installingPlugin)[_installingPlugin] = pluginId;
     plugin.install();
+    _classPrivateFieldLooseBase(this, _installingPlugin)[_installingPlugin] = undefined;
     this.emit('plugin-added', plugin);
     return this;
   }
@@ -1181,8 +1190,8 @@ export class Uppy {
    * Start an upload for all the files that are not currently being uploaded.
    */
   upload() {
-    var _classPrivateFieldLoo;
-    if (!((_classPrivateFieldLoo = _classPrivateFieldLooseBase(this, _plugins)[_plugins]['uploader']) != null && _classPrivateFieldLoo.length)) {
+    var _classPrivateFieldLoo2;
+    if (!((_classPrivateFieldLoo2 = _classPrivateFieldLooseBase(this, _plugins)[_plugins]['uploader']) != null && _classPrivateFieldLoo2.length)) {
       this.log('No uploader type plugins are used', 'warning');
     }
     let {
@@ -1316,6 +1325,7 @@ function _transformFile2(fileDescriptorOrFile) {
   } : fileDescriptorOrFile;
   const fileType = getFileType(file);
   const fileName = getFileName(fileType, file);
+  const filePlugins = getFilePlugins(file);
   const fileExtension = getFileNameAndExtension(fileName).extension;
   const id = getSafeFileId(file, this.getID());
   const meta = file.meta || {};
@@ -1328,6 +1338,7 @@ function _transformFile2(fileDescriptorOrFile) {
     source: file.source || '',
     id,
     name: fileName,
+    plugins: filePlugins,
     extension: fileExtension || '',
     meta: {
       ...this.getState().meta,
@@ -1445,7 +1456,7 @@ function _addListeners2() {
   const errorHandler = (error, file, response) => {
     let errorMsg = error.message || 'Unknown error';
     if (error.details) {
-      errorMsg += ` ${error.details}`;
+      errorMsg += `: ${error.details}`;
     }
     this.setState({
       error: errorMsg
@@ -1459,7 +1470,6 @@ function _addListeners2() {
   };
   this.on('error', errorHandler);
   this.on('upload-error', (file, error, response) => {
-    errorHandler(error, file, response);
     if (typeof error === 'object' && error.message) {
       var _file$name;
       this.log(error.message, 'error');
@@ -1471,9 +1481,16 @@ function _addListeners2() {
       if (error.details) {
         newError.details += ` ${error.details}`;
       }
+
+      // @ts-expect-error
+      newError.request = error.request;
+      this.emit('modify-upload-error', file, newError, response);
       _classPrivateFieldLooseBase(this, _informAndEmit)[_informAndEmit]([newError]);
+      errorHandler(newError, file, response);
     } else {
+      this.emit('modify-upload-error', file, error, response);
       _classPrivateFieldLooseBase(this, _informAndEmit)[_informAndEmit]([error]);
+      errorHandler(error, file, response);
     }
   });
   let uploadStalledWarningRecentlyEmitted = null;
@@ -1681,7 +1698,7 @@ async function _runUpload2(uploadID) {
     return currentUploads[uploadID];
   };
   let currentUpload = getCurrentUpload();
-  const steps = [..._classPrivateFieldLooseBase(this, _preProcessors)[_preProcessors], ..._classPrivateFieldLooseBase(this, _uploaders)[_uploaders], ..._classPrivateFieldLooseBase(this, _postProcessors)[_postProcessors]];
+  const steps = [..._classPrivateFieldLooseBase(this, _preProcessors)[_preProcessors], ..._classPrivateFieldLooseBase(this, _uploaders)[_uploaders].keys(), ..._classPrivateFieldLooseBase(this, _postProcessors)[_postProcessors]];
   try {
     for (let step = currentUpload.step || 0; step < steps.length; step++) {
       if (!currentUpload) {
@@ -1700,12 +1717,18 @@ async function _runUpload2(uploadID) {
       const {
         fileIDs
       } = currentUpload;
-
+      let uploaderFileIds = fileIDs;
+      const uploaderPlugin = _classPrivateFieldLooseBase(this, _uploaders)[_uploaders].get(fn);
+      if (uploaderPlugin) {
+        const files = this.getFilesByIds(uploaderFileIds);
+        uploaderFileIds = files.filter(file => {
+          var _file$plugins, _file$plugins2;
+          return ((_file$plugins = file.plugins) == null ? void 0 : _file$plugins.includes(uploaderPlugin)) || ((_file$plugins2 = file.plugins) == null ? void 0 : _file$plugins2.length) === 0;
+        }).map(file => file.id);
+      }
       // TODO give this the `updatedUpload` object as its only parameter maybe?
       // Otherwise when more metadata may be added to the upload this would keep getting more parameters
-      await fn(fileIDs, uploadID);
-
-      // Update currentUpload value in case it was modified asynchronously.
+      await fn(uploaderFileIds, uploadID);
       currentUpload = getCurrentUpload();
     }
   } catch (err) {
diff --git a/lib/Uppy.js.map b/lib/Uppy.js.map
index 4c056b2809f06d41e950c0d7f262c97c55bd07ad..06e6b9ee759b9ee59119a828445e598f43fb7d58 100644
--- a/lib/Uppy.js.map
+++ b/lib/Uppy.js.map
@@ -1 +1 @@
-{"version":3,"names":["Translator","ee","nanoid","throttle","DefaultStore","getFileType","getFileNameAndExtension","getSafeFileId","supportsUploadProgress","getFileName","justErrorsLogger","debugLogger","Restricter","defaultOptions","defaultRestrictionOptions","RestrictionError","packageJson","locale","defaultUploadState","totalProgress","allowNewUpload","error","recoveredState","_plugins","_classPrivateFieldLooseKey","_restricter","_storeUnsubscribe","_emitter","_preProcessors","_uploaders","_postProcessors","_informAndEmit","_checkRequiredMetaFieldsOnFile","_checkRequiredMetaFields","_assertNewUploadAllowed","_transformFile","_startIfAutoProceed","_checkAndUpdateFileState","_addListeners","_updateOnlineStatus","_requestClientById","_createUpload","_getUpload","_removeUpload","_runUpload","Uppy","constructor","opts","Object","defineProperty","value","_runUpload2","_removeUpload2","_getUpload2","_createUpload2","_addListeners2","_checkAndUpdateFileState2","_startIfAutoProceed2","_transformFile2","_assertNewUploadAllowed2","_checkRequiredMetaFields2","_checkRequiredMetaFieldsOnFile2","_informAndEmit2","writable","create","Set","scheduledAutoProceed","wasOffline","calculateProgress","file","data","fileInState","getFile","id","log","progress","percentage","canHavePercentage","Number","isFinite","bytesTotal","setFileState","bytesUploaded","Math","round","calculateTotalProgress","leading","trailing","updateOnlineStatus","bind","Map","defaultLocale","autoProceed","allowMultipleUploadBatches","debug","restrictions","meta","onBeforeFileAdded","files","hasOwn","onBeforeUpload","store","logger","infoTimeout","merged","VERSION","i18nInit","setState","plugins","currentUploads","capabilities","uploadProgress","individualCancellation","resumableUploads","info","_classPrivateFieldLooseBase","i18n","subscribe","prevState","nextState","patch","emit","updateAll","window","event","_len","arguments","length","args","Array","_key","on","callback","once","off","state","iteratePlugins","plugin","update","getState","patchFilesState","filesWithNewState","existingFilesState","fromEntries","entries","map","_ref","fileID","newFileState","Error","onMissingKey","key","translator","translate","i18nArray","translateArray","setOptions","newOpts","setMeta","undefined","resetProgress","defaultProgress","uploadComplete","uploadStarted","updatedFiles","keys","forEach","clear","addPreProcessor","fn","add","removePreProcessor","delete","addPostProcessor","removePostProcessor","addUploader","removeUploader","updatedMeta","setFileMeta","newMeta","getFiles","values","getFilesByIds","ids","getObjectOfFilesPerState","filesObject","inProgressFiles","newFiles","startedFiles","uploadStartedFiles","pausedFiles","completeFiles","erroredFiles","inProgressNotPausedFiles","processingFiles","push","isPaused","preprocess","postprocess","isUploadStarted","isAllComplete","isAllErrored","isAllPaused","isUploadInProgress","isSomeGhost","some","isGhost","validateSingleFile","err","message","validateAggregateRestrictions","existingFiles","checkIfFileAlreadyExists","addFile","nextFilesState","validFilesToAdd","errors","restrictionErrors","filter","isRestriction","firstValidFileToAdd","name","type","addFiles","fileDescriptors","nonRestrictionErrors","subError","smart_count","details","AggregateError","removeFiles","fileIDs","updatedUploads","removedFiles","fileIsNotRemoved","uploadFileID","uploadID","newFileIDs","stateUpdate","removedFileIDs","join","removeFile","pauseResume","wasPaused","pauseAll","inProgressUpdatedFiles","updatedFile","resumeAll","retryAll","filesToRetry","Promise","resolve","successful","failed","forceAllowNewUpload","cancelAll","retryUpload","logout","_provider","provider","inProgress","sizedFiles","unsizedFiles","progressMax","currentProgress","reduce","acc","totalSize","_file$progress$bytesT","averageSize","uploadedSize","_window$navigator$onL","online","navigator","onLine","getID","use","Plugin","msg","TypeError","_len2","_key2","pluginId","existsPluginAlready","getPlugin","install","foundPlugin","find","Symbol","for","method","flat","removePlugin","instance","uninstall","list","index","findIndex","item","splice","updatedState","destroy","removeEventListener","hideInfo","slice","duration","isComplexMessage","setTimeout","warn","registerRequestClient","client","set","getRequestClientForFile","remote","requestClient","get","requestClientId","restore","reject","addResultData","currentUpload","result","upload","_classPrivateFieldLoo","onBeforeUploadResult","then","validateMinNumberOfFiles","catch","currentlyUploadingFiles","flatMap","curr","waitingFileIDs","indexOf","userFacingErrors","isUserFacing","maxNumToShow","firstErrors","additionalErrors","_ref2","count","missingFields","getMissingRequiredMetaFields","missingRequiredMetaFields","success","fileDescriptorOrFile","File","size","fileType","fileName","fileExtension","extension","source","isRemote","preview","stack","filesToAdd","fileToAdd","_existingFiles$newFil","newFile","existingFileState","onBeforeFileAddedResult","_newFile$name","errorHandler","response","errorMsg","_file$name","newError","uploadStalledWarningRecentlyEmitted","trim","onUploadStarted","filesFiltered","exists","filesState","Date","now","uploadResp","mode","uploadURL","addEventListener","allowMultipleUploads","step","getCurrentUpload","steps","version"],"sources":["Uppy.ts"],"sourcesContent":["/* eslint-disable max-classes-per-file */\n/* global AggregateError */\n\nimport type { h } from 'preact'\nimport Translator from '@uppy/utils/lib/Translator'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore untyped\nimport ee from 'namespace-emitter'\nimport { nanoid } from 'nanoid/non-secure'\nimport throttle from 'lodash/throttle.js'\nimport DefaultStore, { type Store } from '@uppy/store-default'\nimport getFileType from '@uppy/utils/lib/getFileType'\nimport getFileNameAndExtension from '@uppy/utils/lib/getFileNameAndExtension'\nimport { getSafeFileId } from '@uppy/utils/lib/generateFileID'\nimport type {\n  UppyFile,\n  Meta,\n  Body,\n  MinimalRequiredUppyFile,\n} from '@uppy/utils/lib/UppyFile'\nimport type { CompanionFile } from '@uppy/utils/lib/CompanionFile'\nimport type {\n  CompanionClientProvider,\n  CompanionClientSearchProvider,\n} from '@uppy/utils/lib/CompanionClientProvider'\nimport type {\n  FileProgressNotStarted,\n  FileProgressStarted,\n} from '@uppy/utils/lib/FileProgress'\nimport type {\n  Locale,\n  I18n,\n  OptionalPluralizeLocale,\n} from '@uppy/utils/lib/Translator'\nimport supportsUploadProgress from './supportsUploadProgress.ts'\nimport getFileName from './getFileName.ts'\nimport { justErrorsLogger, debugLogger } from './loggers.ts'\nimport {\n  Restricter,\n  defaultOptions as defaultRestrictionOptions,\n  RestrictionError,\n} from './Restricter.ts'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\nimport locale from './locale.ts'\n\nimport type BasePlugin from './BasePlugin.js'\nimport type { Restrictions, ValidateableFile } from './Restricter.js'\n\ntype Processor = (\n  fileIDs: string[],\n  uploadID: string,\n) => Promise<unknown> | void\n\ntype LogLevel = 'info' | 'warning' | 'error' | 'success'\n\nexport type UnknownPlugin<\n  M extends Meta,\n  B extends Body,\n  PluginState extends Record<string, unknown> = Record<string, unknown>,\n> = BasePlugin<any, M, B, PluginState>\n\n/**\n * ids are always `string`s, except the root folder's id can be `null`\n */\nexport type PartialTreeId = string | null\n\nexport type PartialTreeStatusFile = 'checked' | 'unchecked'\nexport type PartialTreeStatus = PartialTreeStatusFile | 'partial'\n\nexport type PartialTreeFile = {\n  type: 'file'\n  id: string\n\n  /**\n   * There exist two types of restrictions:\n   * - individual restrictions (`allowedFileTypes`, `minFileSize`, `maxFileSize`), and\n   * - aggregate restrictions (`maxNumberOfFiles`, `maxTotalFileSize`).\n   *\n   * `.restrictionError` reports whether this file passes individual restrictions.\n   *\n   */\n  restrictionError: string | null\n\n  status: PartialTreeStatusFile\n  parentId: PartialTreeId\n  data: CompanionFile\n}\n\nexport type PartialTreeFolderNode = {\n  type: 'folder'\n  id: string\n\n  /**\n   * Consider `(.nextPagePath, .cached)` a composite key that can represent 4 states:\n   * - `{ cached: true, nextPagePath: null }` - we fetched all pages in this folder\n   * - `{ cached: true, nextPagePath: 'smth' }` - we fetched 1st page, and there are still pages left to fetch in this folder\n   * - `{ cached: false, nextPagePath: null }` - we didn't fetch the 1st page in this folder\n   * - `{ cached: false, nextPagePath: 'someString' }` - ❌ CAN'T HAPPEN ❌\n   */\n  cached: boolean\n  nextPagePath: PartialTreeId\n\n  status: PartialTreeStatus\n  parentId: PartialTreeId\n  data: CompanionFile\n}\n\nexport type PartialTreeFolderRoot = {\n  type: 'root'\n  id: PartialTreeId\n\n  cached: boolean\n  nextPagePath: PartialTreeId\n}\n\nexport type PartialTreeFolder = PartialTreeFolderNode | PartialTreeFolderRoot\n\n/**\n * PartialTree has the following structure.\n *\n *           FolderRoot\n *         ┌─────┴─────┐\n *     FolderNode     File\n *   ┌─────┴────┐\n *  File      File\n *\n * Root folder is called `PartialTreeFolderRoot`,\n * all other folders are called `PartialTreeFolderNode`, because they are \"internal nodes\".\n *\n * It's possible for `PartialTreeFolderNode` to be a leaf node if it doesn't contain any files.\n */\nexport type PartialTree = (PartialTreeFile | PartialTreeFolder)[]\n\nexport type UnknownProviderPluginState = {\n  authenticated: boolean | undefined\n  didFirstRender: boolean\n  searchString: string\n  loading: boolean | string\n  partialTree: PartialTree\n  currentFolderId: PartialTreeId\n  username: string | null\n}\n/*\n * UnknownProviderPlugin can be any Companion plugin (such as Google Drive).\n * As the plugins are passed around throughout Uppy we need a generic type for this.\n * It may seems like duplication, but this type safe. Changing the type of `storage`\n * will error in the `Provider` class of @uppy/companion-client and vice versa.\n *\n * Note that this is the *plugin* class, not a version of the `Provider` class.\n * `Provider` does operate on Companion plugins with `uppy.getPlugin()`.\n */\nexport type UnknownProviderPlugin<\n  M extends Meta,\n  B extends Body,\n> = UnknownPlugin<M, B, UnknownProviderPluginState> & {\n  title: string\n  rootFolderId: string | null\n  files: UppyFile<M, B>[]\n  icon: () => h.JSX.Element\n  provider: CompanionClientProvider\n  storage: {\n    getItem: (key: string) => Promise<string | null>\n    setItem: (key: string, value: string) => Promise<void>\n    removeItem: (key: string) => Promise<void>\n  }\n}\n\n/*\n * UnknownSearchProviderPlugin can be any search Companion plugin (such as Unsplash).\n * As the plugins are passed around throughout Uppy we need a generic type for this.\n * It may seems like duplication, but this type safe. Changing the type of `title`\n * will error in the `SearchProvider` class of @uppy/companion-client and vice versa.\n *\n * Note that this is the *plugin* class, not a version of the `SearchProvider` class.\n * `SearchProvider` does operate on Companion plugins with `uppy.getPlugin()`.\n */\nexport type UnknownSearchProviderPluginState = {\n  isInputMode: boolean\n} & Pick<\n  UnknownProviderPluginState,\n  'loading' | 'searchString' | 'partialTree' | 'currentFolderId'\n>\nexport type UnknownSearchProviderPlugin<\n  M extends Meta,\n  B extends Body,\n> = UnknownPlugin<M, B, UnknownSearchProviderPluginState> & {\n  title: string\n  icon: () => h.JSX.Element\n  provider: CompanionClientSearchProvider\n}\n\nexport interface UploadResult<M extends Meta, B extends Body> {\n  successful?: UppyFile<M, B>[]\n  failed?: UppyFile<M, B>[]\n  uploadID?: string\n  [key: string]: unknown\n}\n\ninterface CurrentUpload<M extends Meta, B extends Body> {\n  fileIDs: string[]\n  step: number\n  result: UploadResult<M, B>\n}\n\n// TODO: can we use namespaces in other plugins to populate this?\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\ninterface Plugins extends Record<string, Record<string, unknown> | undefined> {}\n\nexport interface State<M extends Meta, B extends Body>\n  extends Record<string, unknown> {\n  meta: M\n  capabilities: {\n    uploadProgress: boolean\n    individualCancellation: boolean\n    resumableUploads: boolean\n    isMobileDevice?: boolean\n    darkMode?: boolean\n  }\n  currentUploads: Record<string, CurrentUpload<M, B>>\n  allowNewUpload: boolean\n  recoveredState: null | Required<Pick<State<M, B>, 'files' | 'currentUploads'>>\n  error: string | null\n  files: {\n    [key: string]: UppyFile<M, B>\n  }\n  info: Array<{\n    isHidden?: boolean\n    type: LogLevel\n    message: string\n    details?: string | Record<string, string> | null\n  }>\n  plugins: Plugins\n  totalProgress: number\n  companion?: Record<string, string>\n}\n\nexport interface UppyOptions<M extends Meta, B extends Body> {\n  id?: string\n  autoProceed?: boolean\n  /**\n   * @deprecated Use allowMultipleUploadBatches\n   */\n  allowMultipleUploads?: boolean\n  allowMultipleUploadBatches?: boolean\n  logger?: typeof debugLogger\n  debug?: boolean\n  restrictions: Restrictions\n  meta?: M\n  onBeforeFileAdded?: (\n    currentFile: UppyFile<M, B>,\n    files: { [key: string]: UppyFile<M, B> },\n  ) => UppyFile<M, B> | boolean | undefined\n  onBeforeUpload?: (files: {\n    [key: string]: UppyFile<M, B>\n  }) => { [key: string]: UppyFile<M, B> } | boolean\n  locale?: Locale\n  store?: Store<State<M, B>>\n  infoTimeout?: number\n}\n\nexport interface UppyOptionsWithOptionalRestrictions<\n  M extends Meta,\n  B extends Body,\n> extends Omit<UppyOptions<M, B>, 'restrictions'> {\n  restrictions?: Partial<Restrictions>\n}\n\n// The user facing type for UppyOptions used in uppy.setOptions()\ntype MinimalRequiredOptions<M extends Meta, B extends Body> = Partial<\n  Omit<UppyOptions<M, B>, 'locale' | 'meta' | 'restrictions'> & {\n    locale: OptionalPluralizeLocale\n    meta: Partial<M>\n    restrictions: Partial<Restrictions>\n  }\n>\n\nexport type NonNullableUppyOptions<M extends Meta, B extends Body> = Required<\n  UppyOptions<M, B>\n>\n\nexport interface _UppyEventMap<M extends Meta, B extends Body> {\n  'back-online': () => void\n  'cancel-all': () => void\n  complete: (result: UploadResult<M, B>) => void\n  error: (\n    error: { name: string; message: string; details?: string },\n    file?: UppyFile<M, B>,\n    response?: UppyFile<M, B>['response'],\n  ) => void\n  'file-added': (file: UppyFile<M, B>) => void\n  'file-removed': (file: UppyFile<M, B>) => void\n  'files-added': (files: UppyFile<M, B>[]) => void\n  'info-hidden': () => void\n  'info-visible': () => void\n  'is-offline': () => void\n  'is-online': () => void\n  'pause-all': () => void\n  'plugin-added': (plugin: UnknownPlugin<any, any>) => void\n  'plugin-remove': (plugin: UnknownPlugin<any, any>) => void\n  'postprocess-complete': (\n    file: UppyFile<M, B> | undefined,\n    progress?: NonNullable<FileProgressStarted['preprocess']>,\n  ) => void\n  'postprocess-progress': (\n    file: UppyFile<M, B> | undefined,\n    progress: NonNullable<FileProgressStarted['postprocess']>,\n  ) => void\n  'preprocess-complete': (\n    file: UppyFile<M, B> | undefined,\n    progress?: NonNullable<FileProgressStarted['preprocess']>,\n  ) => void\n  'preprocess-progress': (\n    file: UppyFile<M, B> | undefined,\n    progress: NonNullable<FileProgressStarted['preprocess']>,\n  ) => void\n  progress: (progress: number) => void\n  restored: (pluginData: any) => void\n  'restore-confirmed': () => void\n  'restore-canceled': () => void\n  'restriction-failed': (file: UppyFile<M, B> | undefined, error: Error) => void\n  'resume-all': () => void\n  'retry-all': (files: UppyFile<M, B>[]) => void\n  'state-update': (\n    prevState: State<M, B>,\n    nextState: State<M, B>,\n    patch?: Partial<State<M, B>>,\n  ) => void\n  upload: (uploadID: string, files: UppyFile<M, B>[]) => void\n  'upload-error': (\n    file: UppyFile<M, B> | undefined,\n    error: { name: string; message: string; details?: string },\n    response?:\n      | Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'>\n      | undefined,\n  ) => void\n  'upload-pause': (file: UppyFile<M, B> | undefined, isPaused: boolean) => void\n  'upload-progress': (\n    file: UppyFile<M, B> | undefined,\n    progress: FileProgressStarted,\n  ) => void\n  'upload-retry': (file: UppyFile<M, B>) => void\n  'upload-stalled': (\n    error: { message: string; details?: string },\n    files: UppyFile<M, B>[],\n  ) => void\n  'upload-success': (\n    file: UppyFile<M, B> | undefined,\n    response: NonNullable<UppyFile<M, B>['response']>,\n  ) => void\n}\n\nexport interface UppyEventMap<M extends Meta, B extends Body>\n  extends _UppyEventMap<M, B> {\n  'upload-start': (files: UppyFile<M, B>[]) => void\n}\n\n/** `OmitFirstArg<typeof someArray>` is the type of the returned value of `someArray.slice(1)`. */\ntype OmitFirstArg<T> = T extends [any, ...infer U] ? U : never\n\nconst defaultUploadState = {\n  totalProgress: 0,\n  allowNewUpload: true,\n  error: null,\n  recoveredState: null,\n}\n\n/**\n * Uppy Core module.\n * Manages plugins, state updates, acts as an event bus,\n * adds/removes files and metadata.\n */\nexport class Uppy<\n  M extends Meta = Meta,\n  B extends Body = Record<string, never>,\n> {\n  static VERSION = packageJson.version\n\n  #plugins: Record<string, UnknownPlugin<M, B>[]> = Object.create(null)\n\n  #restricter\n\n  #storeUnsubscribe\n\n  #emitter = ee()\n\n  #preProcessors: Set<Processor> = new Set()\n\n  #uploaders: Set<Processor> = new Set()\n\n  #postProcessors: Set<Processor> = new Set()\n\n  defaultLocale: Locale\n\n  locale!: Locale\n\n  // The user optionally passes in options, but we set defaults for missing options.\n  // We consider all options present after the contructor has run.\n  opts: NonNullableUppyOptions<M, B>\n\n  store: NonNullableUppyOptions<M, B>['store']\n\n  i18n!: I18n\n\n  i18nArray!: Translator['translateArray']\n\n  scheduledAutoProceed: ReturnType<typeof setTimeout> | null = null\n\n  wasOffline = false\n\n  /**\n   * Instantiate Uppy\n   */\n  constructor(opts?: UppyOptionsWithOptionalRestrictions<M, B>) {\n    this.defaultLocale = locale as any as Locale\n\n    const defaultOptions: UppyOptions<Record<string, unknown>, B> = {\n      id: 'uppy',\n      autoProceed: false,\n      allowMultipleUploadBatches: true,\n      debug: false,\n      restrictions: defaultRestrictionOptions,\n      meta: {},\n      onBeforeFileAdded: (file, files) => !Object.hasOwn(files, file.id),\n      onBeforeUpload: (files) => files,\n      store: new DefaultStore(),\n      logger: justErrorsLogger,\n      infoTimeout: 5000,\n    }\n\n    const merged = { ...defaultOptions, ...opts } as Omit<\n      NonNullableUppyOptions<M, B>,\n      'restrictions'\n    >\n    // Merge default options with the ones set by user,\n    // making sure to merge restrictions too\n    this.opts = {\n      ...merged,\n      restrictions: {\n        ...(defaultOptions.restrictions as Restrictions),\n        ...(opts && opts.restrictions),\n      },\n    }\n\n    // Support debug: true for backwards-compatability, unless logger is set in opts\n    // opts instead of this.opts to avoid comparing objects — we set logger: justErrorsLogger in defaultOptions\n    if (opts && opts.logger && opts.debug) {\n      this.log(\n        'You are using a custom `logger`, but also set `debug: true`, which uses built-in logger to output logs to console. Ignoring `debug: true` and using your custom `logger`.',\n        'warning',\n      )\n    } else if (opts && opts.debug) {\n      this.opts.logger = debugLogger\n    }\n\n    this.log(`Using Core v${Uppy.VERSION}`)\n\n    this.i18nInit()\n\n    this.store = this.opts.store\n    this.setState({\n      ...defaultUploadState,\n      plugins: {},\n      files: {},\n      currentUploads: {},\n      capabilities: {\n        uploadProgress: supportsUploadProgress(),\n        individualCancellation: true,\n        resumableUploads: false,\n      },\n      meta: { ...this.opts.meta },\n      info: [],\n    })\n\n    this.#restricter = new Restricter<M, B>(\n      () => this.opts,\n      () => this.i18n,\n    )\n\n    this.#storeUnsubscribe = this.store.subscribe(\n      (prevState, nextState, patch) => {\n        this.emit('state-update', prevState, nextState, patch)\n        this.updateAll(nextState)\n      },\n    )\n\n    // Exposing uppy object on window for debugging and testing\n    if (this.opts.debug && typeof window !== 'undefined') {\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore Mutating the global object for debug purposes\n      window[this.opts.id] = this\n    }\n\n    this.#addListeners()\n  }\n\n  emit<T extends keyof UppyEventMap<M, B>>(\n    event: T,\n    ...args: Parameters<UppyEventMap<M, B>[T]>\n  ): void {\n    this.#emitter.emit(event, ...args)\n  }\n\n  on<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    callback: UppyEventMap<M, B>[K],\n  ): this {\n    this.#emitter.on(event, callback)\n    return this\n  }\n\n  once<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    callback: UppyEventMap<M, B>[K],\n  ): this {\n    this.#emitter.once(event, callback)\n    return this\n  }\n\n  off<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    callback: UppyEventMap<M, B>[K],\n  ): this {\n    this.#emitter.off(event, callback)\n    return this\n  }\n\n  /**\n   * Iterate on all plugins and run `update` on them.\n   * Called each time state changes.\n   *\n   */\n  updateAll(state: Partial<State<M, B>>): void {\n    this.iteratePlugins((plugin: UnknownPlugin<M, B>) => {\n      plugin.update(state)\n    })\n  }\n\n  /**\n   * Updates state with a patch\n   */\n  setState(patch?: Partial<State<M, B>>): void {\n    this.store.setState(patch)\n  }\n\n  /**\n   * Returns current state.\n   */\n  getState(): State<M, B> {\n    return this.store.getState()\n  }\n\n  patchFilesState(filesWithNewState: {\n    [id: string]: Partial<UppyFile<M, B>>\n  }): void {\n    const existingFilesState = this.getState().files\n\n    this.setState({\n      files: {\n        ...existingFilesState,\n        ...Object.fromEntries(\n          Object.entries(filesWithNewState).map(([fileID, newFileState]) => [\n            fileID,\n            {\n              ...existingFilesState[fileID],\n              ...newFileState,\n            },\n          ]),\n        ),\n      },\n    })\n  }\n\n  /**\n   * Shorthand to set state for a specific file.\n   */\n  setFileState(fileID: string, state: Partial<UppyFile<M, B>>): void {\n    if (!this.getState().files[fileID]) {\n      throw new Error(\n        `Can’t set state for ${fileID} (the file could have been removed)`,\n      )\n    }\n\n    this.patchFilesState({ [fileID]: state })\n  }\n\n  i18nInit(): void {\n    const onMissingKey = (key: string): void =>\n      this.log(`Missing i18n string: ${key}`, 'error')\n    const translator = new Translator([this.defaultLocale, this.opts.locale], {\n      onMissingKey,\n    })\n    this.i18n = translator.translate.bind(translator)\n    this.i18nArray = translator.translateArray.bind(translator)\n    this.locale = translator.locale\n  }\n\n  setOptions(newOpts: MinimalRequiredOptions<M, B>): void {\n    this.opts = {\n      ...this.opts,\n      ...(newOpts as UppyOptions<M, B>),\n      restrictions: {\n        ...this.opts.restrictions,\n        ...(newOpts?.restrictions as Restrictions),\n      },\n    }\n\n    if (newOpts.meta) {\n      this.setMeta(newOpts.meta)\n    }\n\n    this.i18nInit()\n\n    if (newOpts.locale) {\n      this.iteratePlugins((plugin) => {\n        plugin.setOptions(newOpts)\n      })\n    }\n\n    // Note: this is not the preact `setState`, it's an internal function that has the same name.\n    this.setState(undefined) // so that UI re-renders with new options\n  }\n\n  resetProgress(): void {\n    const defaultProgress: Omit<FileProgressNotStarted, 'bytesTotal'> = {\n      percentage: 0,\n      bytesUploaded: false,\n      uploadComplete: false,\n      uploadStarted: null,\n    }\n    const files = { ...this.getState().files }\n    const updatedFiles: State<M, B>['files'] = Object.create(null)\n\n    Object.keys(files).forEach((fileID) => {\n      updatedFiles[fileID] = {\n        ...files[fileID],\n        progress: {\n          ...files[fileID].progress,\n          ...defaultProgress,\n        },\n      }\n    })\n\n    this.setState({ files: updatedFiles, ...defaultUploadState })\n  }\n\n  clear(): void {\n    const { capabilities, currentUploads } = this.getState()\n    if (\n      Object.keys(currentUploads).length > 0 &&\n      !capabilities.individualCancellation\n    ) {\n      throw new Error(\n        'The installed uploader plugin does not allow removing files during an upload.',\n      )\n    }\n\n    this.setState({ ...defaultUploadState, files: {} })\n  }\n\n  addPreProcessor(fn: Processor): void {\n    this.#preProcessors.add(fn)\n  }\n\n  removePreProcessor(fn: Processor): boolean {\n    return this.#preProcessors.delete(fn)\n  }\n\n  addPostProcessor(fn: Processor): void {\n    this.#postProcessors.add(fn)\n  }\n\n  removePostProcessor(fn: Processor): boolean {\n    return this.#postProcessors.delete(fn)\n  }\n\n  addUploader(fn: Processor): void {\n    this.#uploaders.add(fn)\n  }\n\n  removeUploader(fn: Processor): boolean {\n    return this.#uploaders.delete(fn)\n  }\n\n  setMeta(data: Partial<M>): void {\n    const updatedMeta = { ...this.getState().meta, ...data }\n    const updatedFiles = { ...this.getState().files }\n\n    Object.keys(updatedFiles).forEach((fileID) => {\n      updatedFiles[fileID] = {\n        ...updatedFiles[fileID],\n        meta: { ...updatedFiles[fileID].meta, ...data },\n      }\n    })\n\n    this.log('Adding metadata:')\n    this.log(data)\n\n    this.setState({\n      meta: updatedMeta,\n      files: updatedFiles,\n    })\n  }\n\n  setFileMeta(fileID: string, data: State<M, B>['meta']): void {\n    const updatedFiles = { ...this.getState().files }\n    if (!updatedFiles[fileID]) {\n      this.log(\n        'Was trying to set metadata for a file that has been removed: ',\n        fileID,\n      )\n      return\n    }\n    const newMeta = { ...updatedFiles[fileID].meta, ...data }\n    updatedFiles[fileID] = { ...updatedFiles[fileID], meta: newMeta }\n    this.setState({ files: updatedFiles })\n  }\n\n  /**\n   * Get a file object.\n   */\n  getFile(fileID: string): UppyFile<M, B> {\n    return this.getState().files[fileID]\n  }\n\n  /**\n   * Get all files in an array.\n   */\n  getFiles(): UppyFile<M, B>[] {\n    const { files } = this.getState()\n    return Object.values(files)\n  }\n\n  getFilesByIds(ids: string[]): UppyFile<M, B>[] {\n    return ids.map((id) => this.getFile(id))\n  }\n\n  getObjectOfFilesPerState(): {\n    newFiles: UppyFile<M, B>[]\n    startedFiles: UppyFile<M, B>[]\n    uploadStartedFiles: UppyFile<M, B>[]\n    pausedFiles: UppyFile<M, B>[]\n    completeFiles: UppyFile<M, B>[]\n    erroredFiles: UppyFile<M, B>[]\n    inProgressFiles: UppyFile<M, B>[]\n    inProgressNotPausedFiles: UppyFile<M, B>[]\n    processingFiles: UppyFile<M, B>[]\n    isUploadStarted: boolean\n    isAllComplete: boolean\n    isAllErrored: boolean\n    isAllPaused: boolean\n    isUploadInProgress: boolean\n    isSomeGhost: boolean\n  } {\n    const { files: filesObject, totalProgress, error } = this.getState()\n    const files = Object.values(filesObject)\n\n    const inProgressFiles: UppyFile<M, B>[] = []\n    const newFiles: UppyFile<M, B>[] = []\n    const startedFiles: UppyFile<M, B>[] = []\n    const uploadStartedFiles: UppyFile<M, B>[] = []\n    const pausedFiles: UppyFile<M, B>[] = []\n    const completeFiles: UppyFile<M, B>[] = []\n    const erroredFiles: UppyFile<M, B>[] = []\n    const inProgressNotPausedFiles: UppyFile<M, B>[] = []\n    const processingFiles: UppyFile<M, B>[] = []\n\n    for (const file of files) {\n      const { progress } = file\n\n      if (!progress.uploadComplete && progress.uploadStarted) {\n        inProgressFiles.push(file)\n        if (!file.isPaused) {\n          inProgressNotPausedFiles.push(file)\n        }\n      }\n      if (!progress.uploadStarted) {\n        newFiles.push(file)\n      }\n      if (\n        progress.uploadStarted ||\n        progress.preprocess ||\n        progress.postprocess\n      ) {\n        startedFiles.push(file)\n      }\n      if (progress.uploadStarted) {\n        uploadStartedFiles.push(file)\n      }\n      if (file.isPaused) {\n        pausedFiles.push(file)\n      }\n      if (progress.uploadComplete) {\n        completeFiles.push(file)\n      }\n      if (file.error) {\n        erroredFiles.push(file)\n      }\n      if (progress.preprocess || progress.postprocess) {\n        processingFiles.push(file)\n      }\n    }\n\n    return {\n      newFiles,\n      startedFiles,\n      uploadStartedFiles,\n      pausedFiles,\n      completeFiles,\n      erroredFiles,\n      inProgressFiles,\n      inProgressNotPausedFiles,\n      processingFiles,\n\n      isUploadStarted: uploadStartedFiles.length > 0,\n      isAllComplete:\n        totalProgress === 100 &&\n        completeFiles.length === files.length &&\n        processingFiles.length === 0,\n      isAllErrored: !!error && erroredFiles.length === files.length,\n      isAllPaused:\n        inProgressFiles.length !== 0 &&\n        pausedFiles.length === inProgressFiles.length,\n      isUploadInProgress: inProgressFiles.length > 0,\n      isSomeGhost: files.some((file) => file.isGhost),\n    }\n  }\n\n  #informAndEmit(\n    errors: {\n      name: string\n      message: string\n      isUserFacing?: boolean\n      details?: string\n      isRestriction?: boolean\n      file?: UppyFile<M, B>\n    }[],\n  ): void {\n    for (const error of errors) {\n      if (error.isRestriction) {\n        this.emit(\n          'restriction-failed',\n          error.file,\n          error as RestrictionError<M, B>,\n        )\n      } else {\n        this.emit('error', error, error.file)\n      }\n      this.log(error, 'warning')\n    }\n\n    const userFacingErrors = errors.filter((error) => error.isUserFacing)\n\n    // don't flood the user: only show the first 4 toasts\n    const maxNumToShow = 4\n    const firstErrors = userFacingErrors.slice(0, maxNumToShow)\n    const additionalErrors = userFacingErrors.slice(maxNumToShow)\n    firstErrors.forEach(({ message, details = '' }) => {\n      this.info({ message, details }, 'error', this.opts.infoTimeout)\n    })\n\n    if (additionalErrors.length > 0) {\n      this.info({\n        message: this.i18n('additionalRestrictionsFailed', {\n          count: additionalErrors.length,\n        }),\n      })\n    }\n  }\n\n  validateSingleFile(file: ValidateableFile<M, B>): string | null {\n    try {\n      this.#restricter.validateSingleFile(file)\n    } catch (err) {\n      return err.message\n    }\n    return null\n  }\n\n  validateAggregateRestrictions(\n    files: ValidateableFile<M, B>[],\n  ): string | null {\n    const existingFiles = this.getFiles()\n    try {\n      this.#restricter.validateAggregateRestrictions(existingFiles, files)\n    } catch (err) {\n      return err.message\n    }\n    return null\n  }\n\n  #checkRequiredMetaFieldsOnFile(file: UppyFile<M, B>): boolean {\n    const { missingFields, error } =\n      this.#restricter.getMissingRequiredMetaFields(file)\n\n    if (missingFields.length > 0) {\n      this.setFileState(file.id, { missingRequiredMetaFields: missingFields })\n      this.log(error.message)\n      this.emit('restriction-failed', file, error)\n      return false\n    }\n    return true\n  }\n\n  #checkRequiredMetaFields(files: State<M, B>['files']): boolean {\n    let success = true\n    for (const file of Object.values(files)) {\n      if (!this.#checkRequiredMetaFieldsOnFile(file)) {\n        success = false\n      }\n    }\n    return success\n  }\n\n  #assertNewUploadAllowed(file?: UppyFile<M, B>): void {\n    const { allowNewUpload } = this.getState()\n\n    if (allowNewUpload === false) {\n      const error = new RestrictionError<M, B>(\n        this.i18n('noMoreFilesAllowed'),\n        {\n          file,\n        },\n      )\n      this.#informAndEmit([error])\n      throw error\n    }\n  }\n\n  checkIfFileAlreadyExists(fileID: string): boolean {\n    const { files } = this.getState()\n\n    if (files[fileID] && !files[fileID].isGhost) {\n      return true\n    }\n    return false\n  }\n\n  /**\n   * Create a file state object based on user-provided `addFile()` options.\n   */\n  #transformFile(fileDescriptorOrFile: File | UppyFile<M, B>): UppyFile<M, B> {\n    // Uppy expects files in { name, type, size, data } format.\n    // If the actual File object is passed from input[type=file] or drag-drop,\n    // we normalize it to match Uppy file object\n    const file = (\n      fileDescriptorOrFile instanceof File ?\n        {\n          name: fileDescriptorOrFile.name,\n          type: fileDescriptorOrFile.type,\n          size: fileDescriptorOrFile.size,\n          data: fileDescriptorOrFile,\n        }\n      : fileDescriptorOrFile) as UppyFile<M, B>\n\n    const fileType = getFileType(file)\n    const fileName = getFileName(fileType, file)\n    const fileExtension = getFileNameAndExtension(fileName).extension\n    const id = getSafeFileId(file, this.getID())\n\n    const meta = file.meta || {}\n    meta.name = fileName\n    meta.type = fileType\n\n    // `null` means the size is unknown.\n    const size =\n      Number.isFinite(file.data.size) ? file.data.size : (null as never)\n\n    return {\n      source: file.source || '',\n      id,\n      name: fileName,\n      extension: fileExtension || '',\n      meta: {\n        ...this.getState().meta,\n        ...meta,\n      },\n      type: fileType,\n      data: file.data,\n      progress: {\n        percentage: 0,\n        bytesUploaded: false,\n        bytesTotal: size,\n        uploadComplete: false,\n        uploadStarted: null,\n      },\n      size,\n      isGhost: false,\n      isRemote: file.isRemote || false,\n      remote: file.remote,\n      preview: file.preview,\n    }\n  }\n\n  // Schedule an upload if `autoProceed` is enabled.\n  #startIfAutoProceed(): void {\n    if (this.opts.autoProceed && !this.scheduledAutoProceed) {\n      this.scheduledAutoProceed = setTimeout(() => {\n        this.scheduledAutoProceed = null\n        this.upload().catch((err) => {\n          if (!err.isRestriction) {\n            this.log(err.stack || err.message || err)\n          }\n        })\n      }, 4)\n    }\n  }\n\n  #checkAndUpdateFileState(filesToAdd: UppyFile<M, B>[]): {\n    nextFilesState: State<M, B>['files']\n    validFilesToAdd: UppyFile<M, B>[]\n    errors: RestrictionError<M, B>[]\n  } {\n    const { files: existingFiles } = this.getState()\n\n    // create a copy of the files object only once\n    const nextFilesState = { ...existingFiles }\n    const validFilesToAdd: UppyFile<M, B>[] = []\n    const errors: RestrictionError<M, B>[] = []\n\n    for (const fileToAdd of filesToAdd) {\n      try {\n        let newFile = this.#transformFile(fileToAdd)\n\n        // If a file has been recovered (Golden Retriever), but we were unable to recover its data (probably too large),\n        // users are asked to re-select these half-recovered files and then this method will be called again.\n        // In order to keep the progress, meta and everything else, we keep the existing file,\n        // but we replace `data`, and we remove `isGhost`, because the file is no longer a ghost now\n        const isGhost = existingFiles[newFile.id]?.isGhost\n        if (isGhost) {\n          const existingFileState = existingFiles[newFile.id]\n          newFile = {\n            ...existingFileState,\n            isGhost: false,\n            data: fileToAdd.data,\n          }\n          this.log(\n            `Replaced the blob in the restored ghost file: ${newFile.name}, ${newFile.id}`,\n          )\n        }\n\n        const onBeforeFileAddedResult = this.opts.onBeforeFileAdded(\n          newFile,\n          nextFilesState,\n        )\n\n        if (\n          !onBeforeFileAddedResult &&\n          this.checkIfFileAlreadyExists(newFile.id)\n        ) {\n          throw new RestrictionError(\n            this.i18n('noDuplicates', {\n              fileName: newFile.name ?? this.i18n('unnamed'),\n            }),\n            { file: fileToAdd },\n          )\n        }\n\n        // Pass through reselected files from Golden Retriever\n        if (onBeforeFileAddedResult === false && !isGhost) {\n          // Don’t show UI info for this error, as it should be done by the developer\n          throw new RestrictionError(\n            'Cannot add the file because onBeforeFileAdded returned false.',\n            { isUserFacing: false, file: fileToAdd },\n          )\n        } else if (\n          typeof onBeforeFileAddedResult === 'object' &&\n          onBeforeFileAddedResult !== null\n        ) {\n          newFile = onBeforeFileAddedResult\n        }\n\n        this.#restricter.validateSingleFile(newFile)\n\n        // need to add it to the new local state immediately, so we can use the state to validate the next files too\n        nextFilesState[newFile.id] = newFile\n        validFilesToAdd.push(newFile)\n      } catch (err) {\n        errors.push(err as any)\n      }\n    }\n\n    try {\n      // need to run this separately because it's much more slow, so if we run it inside the for-loop it will be very slow\n      // when many files are added\n      this.#restricter.validateAggregateRestrictions(\n        Object.values(existingFiles),\n        validFilesToAdd,\n      )\n    } catch (err) {\n      errors.push(err as any)\n\n      // If we have any aggregate error, don't allow adding this batch\n      return {\n        nextFilesState: existingFiles,\n        validFilesToAdd: [],\n        errors,\n      }\n    }\n\n    return {\n      nextFilesState,\n      validFilesToAdd,\n      errors,\n    }\n  }\n\n  /**\n   * Add a new file to `state.files`. This will run `onBeforeFileAdded`,\n   * try to guess file type in a clever way, check file against restrictions,\n   * and start an upload if `autoProceed === true`.\n   */\n  addFile(file: File | MinimalRequiredUppyFile<M, B>): UppyFile<M, B>['id'] {\n    this.#assertNewUploadAllowed(file as UppyFile<M, B>)\n\n    const { nextFilesState, validFilesToAdd, errors } =\n      this.#checkAndUpdateFileState([file as UppyFile<M, B>])\n\n    const restrictionErrors = errors.filter((error) => error.isRestriction)\n    this.#informAndEmit(restrictionErrors)\n\n    if (errors.length > 0) throw errors[0]\n\n    this.setState({ files: nextFilesState })\n\n    const [firstValidFileToAdd] = validFilesToAdd\n\n    this.emit('file-added', firstValidFileToAdd)\n    this.emit('files-added', validFilesToAdd)\n    this.log(\n      `Added file: ${firstValidFileToAdd.name}, ${firstValidFileToAdd.id}, mime type: ${firstValidFileToAdd.type}`,\n    )\n\n    this.#startIfAutoProceed()\n\n    return firstValidFileToAdd.id\n  }\n\n  /**\n   * Add multiple files to `state.files`. See the `addFile()` documentation.\n   *\n   * If an error occurs while adding a file, it is logged and the user is notified.\n   * This is good for UI plugins, but not for programmatic use.\n   * Programmatic users should usually still use `addFile()` on individual files.\n   */\n  addFiles(fileDescriptors: MinimalRequiredUppyFile<M, B>[]): void {\n    this.#assertNewUploadAllowed()\n\n    const { nextFilesState, validFilesToAdd, errors } =\n      this.#checkAndUpdateFileState(fileDescriptors as UppyFile<M, B>[])\n\n    const restrictionErrors = errors.filter((error) => error.isRestriction)\n    this.#informAndEmit(restrictionErrors)\n\n    const nonRestrictionErrors = errors.filter((error) => !error.isRestriction)\n\n    if (nonRestrictionErrors.length > 0) {\n      let message = 'Multiple errors occurred while adding files:\\n'\n      nonRestrictionErrors.forEach((subError) => {\n        message += `\\n * ${subError.message}`\n      })\n\n      this.info(\n        {\n          message: this.i18n('addBulkFilesFailed', {\n            smart_count: nonRestrictionErrors.length,\n          }),\n          details: message,\n        },\n        'error',\n        this.opts.infoTimeout,\n      )\n\n      if (typeof AggregateError === 'function') {\n        throw new AggregateError(nonRestrictionErrors, message)\n      } else {\n        const err = new Error(message)\n        // @ts-expect-error fallback when AggregateError is not available\n        err.errors = nonRestrictionErrors\n        throw err\n      }\n    }\n\n    // OK, we haven't thrown an error, we can start updating state and emitting events now:\n\n    this.setState({ files: nextFilesState })\n\n    validFilesToAdd.forEach((file) => {\n      this.emit('file-added', file)\n    })\n\n    this.emit('files-added', validFilesToAdd)\n\n    if (validFilesToAdd.length > 5) {\n      this.log(`Added batch of ${validFilesToAdd.length} files`)\n    } else {\n      Object.values(validFilesToAdd).forEach((file) => {\n        this.log(\n          `Added file: ${file.name}\\n id: ${file.id}\\n type: ${file.type}`,\n        )\n      })\n    }\n\n    if (validFilesToAdd.length > 0) {\n      this.#startIfAutoProceed()\n    }\n  }\n\n  removeFiles(fileIDs: string[]): void {\n    const { files, currentUploads } = this.getState()\n    const updatedFiles = { ...files }\n    const updatedUploads = { ...currentUploads }\n\n    const removedFiles = Object.create(null)\n    fileIDs.forEach((fileID) => {\n      if (files[fileID]) {\n        removedFiles[fileID] = files[fileID]\n        delete updatedFiles[fileID]\n      }\n    })\n\n    // Remove files from the `fileIDs` list in each upload.\n    function fileIsNotRemoved(uploadFileID: string): boolean {\n      return removedFiles[uploadFileID] === undefined\n    }\n\n    Object.keys(updatedUploads).forEach((uploadID) => {\n      const newFileIDs =\n        currentUploads[uploadID].fileIDs.filter(fileIsNotRemoved)\n\n      // Remove the upload if no files are associated with it anymore.\n      if (newFileIDs.length === 0) {\n        delete updatedUploads[uploadID]\n        return\n      }\n\n      const { capabilities } = this.getState()\n      if (\n        newFileIDs.length !== currentUploads[uploadID].fileIDs.length &&\n        !capabilities.individualCancellation\n      ) {\n        throw new Error(\n          'The installed uploader plugin does not allow removing files during an upload.',\n        )\n      }\n\n      updatedUploads[uploadID] = {\n        ...currentUploads[uploadID],\n        fileIDs: newFileIDs,\n      }\n    })\n\n    const stateUpdate: Partial<State<M, B>> = {\n      currentUploads: updatedUploads,\n      files: updatedFiles,\n    }\n\n    // If all files were removed - allow new uploads,\n    // and clear recoveredState\n    if (Object.keys(updatedFiles).length === 0) {\n      stateUpdate.allowNewUpload = true\n      stateUpdate.error = null\n      stateUpdate.recoveredState = null\n    }\n\n    this.setState(stateUpdate)\n    this.calculateTotalProgress()\n\n    const removedFileIDs = Object.keys(removedFiles)\n    removedFileIDs.forEach((fileID) => {\n      this.emit('file-removed', removedFiles[fileID])\n    })\n\n    if (removedFileIDs.length > 5) {\n      this.log(`Removed ${removedFileIDs.length} files`)\n    } else {\n      this.log(`Removed files: ${removedFileIDs.join(', ')}`)\n    }\n  }\n\n  removeFile(fileID: string): void {\n    this.removeFiles([fileID])\n  }\n\n  pauseResume(fileID: string): boolean | undefined {\n    if (\n      !this.getState().capabilities.resumableUploads ||\n      this.getFile(fileID).progress.uploadComplete\n    ) {\n      return undefined\n    }\n\n    const file = this.getFile(fileID)\n    const wasPaused = file.isPaused || false\n    const isPaused = !wasPaused\n\n    this.setFileState(fileID, {\n      isPaused,\n    })\n\n    this.emit('upload-pause', file, isPaused)\n\n    return isPaused\n  }\n\n  pauseAll(): void {\n    const updatedFiles = { ...this.getState().files }\n    const inProgressUpdatedFiles = Object.keys(updatedFiles).filter((file) => {\n      return (\n        !updatedFiles[file].progress.uploadComplete &&\n        updatedFiles[file].progress.uploadStarted\n      )\n    })\n\n    inProgressUpdatedFiles.forEach((file) => {\n      const updatedFile = { ...updatedFiles[file], isPaused: true }\n      updatedFiles[file] = updatedFile\n    })\n\n    this.setState({ files: updatedFiles })\n    this.emit('pause-all')\n  }\n\n  resumeAll(): void {\n    const updatedFiles = { ...this.getState().files }\n    const inProgressUpdatedFiles = Object.keys(updatedFiles).filter((file) => {\n      return (\n        !updatedFiles[file].progress.uploadComplete &&\n        updatedFiles[file].progress.uploadStarted\n      )\n    })\n\n    inProgressUpdatedFiles.forEach((file) => {\n      const updatedFile = {\n        ...updatedFiles[file],\n        isPaused: false,\n        error: null,\n      }\n      updatedFiles[file] = updatedFile\n    })\n    this.setState({ files: updatedFiles })\n\n    this.emit('resume-all')\n  }\n\n  retryAll(): Promise<UploadResult<M, B> | undefined> {\n    const updatedFiles = { ...this.getState().files }\n    const filesToRetry = Object.keys(updatedFiles).filter((file) => {\n      return updatedFiles[file].error\n    })\n\n    filesToRetry.forEach((file) => {\n      const updatedFile = {\n        ...updatedFiles[file],\n        isPaused: false,\n        error: null,\n      }\n      updatedFiles[file] = updatedFile\n    })\n    this.setState({\n      files: updatedFiles,\n      error: null,\n    })\n\n    this.emit('retry-all', Object.values(updatedFiles))\n\n    if (filesToRetry.length === 0) {\n      return Promise.resolve({\n        successful: [],\n        failed: [],\n      })\n    }\n\n    const uploadID = this.#createUpload(filesToRetry, {\n      forceAllowNewUpload: true, // create new upload even if allowNewUpload: false\n    })\n    return this.#runUpload(uploadID)\n  }\n\n  cancelAll(): void {\n    this.emit('cancel-all')\n\n    const { files } = this.getState()\n\n    const fileIDs = Object.keys(files)\n    if (fileIDs.length) {\n      this.removeFiles(fileIDs)\n    }\n\n    this.setState(defaultUploadState)\n  }\n\n  retryUpload(fileID: string): Promise<UploadResult<M, B> | undefined> {\n    this.setFileState(fileID, {\n      error: null,\n      isPaused: false,\n    })\n\n    this.emit('upload-retry', this.getFile(fileID))\n\n    const uploadID = this.#createUpload([fileID], {\n      forceAllowNewUpload: true, // create new upload even if allowNewUpload: false\n    })\n    return this.#runUpload(uploadID)\n  }\n\n  logout(): void {\n    this.iteratePlugins((plugin) => {\n      ;(plugin as UnknownProviderPlugin<M, B>).provider?.logout?.()\n    })\n  }\n\n  // ___Why throttle at 500ms?\n  //    - We must throttle at >250ms for superfocus in Dashboard to work well\n  //    (because animation takes 0.25s, and we want to wait for all animations to be over before refocusing).\n  //    [Practical Check]: if thottle is at 100ms, then if you are uploading a file,\n  //    and click 'ADD MORE FILES', - focus won't activate in Firefox.\n  //    - We must throttle at around >500ms to avoid performance lags.\n  //    [Practical Check] Firefox, try to upload a big file for a prolonged period of time. Laptop will start to heat up.\n  // todo when uploading multiple files, this will cause problems because they share the same throttle,\n  // meaning some files might never get their progress reported (eaten up by progress events from other files)\n  calculateProgress = throttle(\n    (file, data) => {\n      const fileInState = this.getFile(file?.id)\n      if (file == null || !fileInState) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n\n      if (fileInState.progress.percentage === 100) {\n        this.log(\n          `Not setting progress for a file that has been already uploaded: ${file.id}`,\n        )\n        return\n      }\n\n      // bytesTotal may be null or zero; in that case we can't divide by it\n      const canHavePercentage =\n        Number.isFinite(data.bytesTotal) && data.bytesTotal > 0\n      this.setFileState(file.id, {\n        progress: {\n          ...fileInState.progress,\n          bytesUploaded: data.bytesUploaded,\n          bytesTotal: data.bytesTotal,\n          percentage:\n            canHavePercentage ?\n              Math.round((data.bytesUploaded / data.bytesTotal) * 100)\n            : 0,\n        },\n      })\n\n      this.calculateTotalProgress()\n    },\n    500,\n    { leading: true, trailing: true },\n  )\n\n  calculateTotalProgress(): void {\n    // calculate total progress, using the number of files currently uploading,\n    // multiplied by 100 and the summ of individual progress of each file\n    const files = this.getFiles()\n\n    const inProgress = files.filter((file) => {\n      return (\n        file.progress.uploadStarted ||\n        file.progress.preprocess ||\n        file.progress.postprocess\n      )\n    })\n\n    if (inProgress.length === 0) {\n      this.emit('progress', 0)\n      this.setState({ totalProgress: 0 })\n      return\n    }\n\n    const sizedFiles = inProgress.filter(\n      (file) => file.progress.bytesTotal != null,\n    )\n    const unsizedFiles = inProgress.filter(\n      (file) => file.progress.bytesTotal == null,\n    )\n\n    if (sizedFiles.length === 0) {\n      const progressMax = inProgress.length * 100\n      const currentProgress = unsizedFiles.reduce((acc, file) => {\n        return acc + (file.progress.percentage as number)\n      }, 0)\n      const totalProgress = Math.round((currentProgress / progressMax) * 100)\n      this.setState({ totalProgress })\n      return\n    }\n\n    let totalSize = sizedFiles.reduce((acc, file) => {\n      return (acc + (file.progress.bytesTotal ?? 0)) as number\n    }, 0)\n    const averageSize = totalSize / sizedFiles.length\n    totalSize += averageSize * unsizedFiles.length\n\n    let uploadedSize = 0\n    sizedFiles.forEach((file) => {\n      uploadedSize += file.progress.bytesUploaded as number\n    })\n    unsizedFiles.forEach((file) => {\n      uploadedSize += (averageSize * (file.progress.percentage || 0)) / 100\n    })\n\n    let totalProgress =\n      totalSize === 0 ? 0 : Math.round((uploadedSize / totalSize) * 100)\n\n    // hot fix, because:\n    // uploadedSize ended up larger than totalSize, resulting in 1325% total\n    if (totalProgress > 100) {\n      totalProgress = 100\n    }\n\n    this.setState({ totalProgress })\n    this.emit('progress', totalProgress)\n  }\n\n  /**\n   * Registers listeners for all global actions, like:\n   * `error`, `file-removed`, `upload-progress`\n   */\n  #addListeners(): void {\n    // Type inference only works for inline functions so we have to type it again\n    const errorHandler: UppyEventMap<M, B>['error'] = (\n      error,\n      file,\n      response,\n    ) => {\n      let errorMsg = error.message || 'Unknown error'\n      if (error.details) {\n        errorMsg += ` ${error.details}`\n      }\n\n      this.setState({ error: errorMsg })\n\n      if (file != null && file.id in this.getState().files) {\n        this.setFileState(file.id, {\n          error: errorMsg,\n          response,\n        })\n      }\n    }\n\n    this.on('error', errorHandler)\n\n    this.on('upload-error', (file, error, response) => {\n      errorHandler(error, file, response)\n\n      if (typeof error === 'object' && error.message) {\n        this.log(error.message, 'error')\n        const newError = new Error(\n          this.i18n('failedToUpload', { file: file?.name ?? '' }),\n        ) as any // we may want a new custom error here\n        newError.isUserFacing = true // todo maybe don't do this with all errors?\n        newError.details = error.message\n        if (error.details) {\n          newError.details += ` ${error.details}`\n        }\n        this.#informAndEmit([newError])\n      } else {\n        this.#informAndEmit([error])\n      }\n    })\n\n    let uploadStalledWarningRecentlyEmitted: ReturnType<\n      typeof setTimeout\n    > | null = null\n    this.on('upload-stalled', (error, files) => {\n      const { message } = error\n      const details = files.map((file) => file.meta.name).join(', ')\n      if (!uploadStalledWarningRecentlyEmitted) {\n        this.info({ message, details }, 'warning', this.opts.infoTimeout)\n        uploadStalledWarningRecentlyEmitted = setTimeout(() => {\n          uploadStalledWarningRecentlyEmitted = null\n        }, this.opts.infoTimeout)\n      }\n      this.log(`${message} ${details}`.trim(), 'warning')\n    })\n\n    this.on('upload', () => {\n      this.setState({ error: null })\n    })\n\n    const onUploadStarted = (files: UppyFile<M, B>[]): void => {\n      const filesFiltered = files.filter((file) => {\n        const exists = file != null && this.getFile(file.id)\n        if (!exists)\n          this.log(\n            `Not setting progress for a file that has been removed: ${file?.id}`,\n          )\n        return exists\n      })\n\n      const filesState = Object.fromEntries(\n        filesFiltered.map((file) => [\n          file.id,\n          {\n            progress: {\n              uploadStarted: Date.now(),\n              uploadComplete: false,\n              percentage: 0,\n              bytesUploaded: 0,\n              bytesTotal: file.size,\n            } as FileProgressStarted,\n          },\n        ]),\n      )\n\n      this.patchFilesState(filesState)\n    }\n\n    this.on('upload-start', onUploadStarted)\n\n    this.on('upload-progress', this.calculateProgress)\n\n    this.on('upload-success', (file, uploadResp) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n\n      const currentProgress = this.getFile(file.id).progress\n      this.setFileState(file.id, {\n        progress: {\n          ...currentProgress,\n          postprocess:\n            this.#postProcessors.size > 0 ?\n              {\n                mode: 'indeterminate',\n              }\n            : undefined,\n          uploadComplete: true,\n          percentage: 100,\n          bytesUploaded: currentProgress.bytesTotal,\n        } as FileProgressStarted,\n        response: uploadResp,\n        uploadURL: uploadResp.uploadURL,\n        isPaused: false,\n      })\n\n      // Remote providers sometimes don't tell us the file size,\n      // but we can know how many bytes we uploaded once the upload is complete.\n      if (file.size == null) {\n        this.setFileState(file.id, {\n          size: uploadResp.bytesUploaded || currentProgress.bytesTotal,\n        })\n      }\n\n      this.calculateTotalProgress()\n    })\n\n    this.on('preprocess-progress', (file, progress) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      this.setFileState(file.id, {\n        progress: { ...this.getFile(file.id).progress, preprocess: progress },\n      })\n    })\n\n    this.on('preprocess-complete', (file) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      const files = { ...this.getState().files }\n      files[file.id] = {\n        ...files[file.id],\n        progress: { ...files[file.id].progress },\n      }\n      delete files[file.id].progress.preprocess\n\n      this.setState({ files })\n    })\n\n    this.on('postprocess-progress', (file, progress) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      this.setFileState(file.id, {\n        progress: {\n          ...this.getState().files[file.id].progress,\n          postprocess: progress,\n        },\n      })\n    })\n\n    this.on('postprocess-complete', (file) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      const files = {\n        ...this.getState().files,\n      }\n      files[file.id] = {\n        ...files[file.id],\n        progress: {\n          ...files[file.id].progress,\n        },\n      }\n      delete files[file.id].progress.postprocess\n\n      this.setState({ files })\n    })\n\n    this.on('restored', () => {\n      // Files may have changed--ensure progress is still accurate.\n      this.calculateTotalProgress()\n    })\n\n    // @ts-expect-error should fix itself when dashboard it typed (also this doesn't belong here)\n    this.on('dashboard:file-edit-complete', (file) => {\n      if (file) {\n        this.#checkRequiredMetaFieldsOnFile(file)\n      }\n    })\n\n    // show informer if offline\n    if (typeof window !== 'undefined' && window.addEventListener) {\n      window.addEventListener('online', this.#updateOnlineStatus)\n      window.addEventListener('offline', this.#updateOnlineStatus)\n      setTimeout(this.#updateOnlineStatus, 3000)\n    }\n  }\n\n  updateOnlineStatus(): void {\n    const online = window.navigator.onLine ?? true\n    if (!online) {\n      this.emit('is-offline')\n      this.info(this.i18n('noInternetConnection'), 'error', 0)\n      this.wasOffline = true\n    } else {\n      this.emit('is-online')\n      if (this.wasOffline) {\n        this.emit('back-online')\n        this.info(this.i18n('connectedToInternet'), 'success', 3000)\n        this.wasOffline = false\n      }\n    }\n  }\n\n  #updateOnlineStatus = this.updateOnlineStatus.bind(this)\n\n  getID(): string {\n    return this.opts.id\n  }\n\n  /**\n   * Registers a plugin with Core.\n   */\n  use<T extends typeof BasePlugin<any, M, B>>(\n    Plugin: T,\n    // We want to let the plugin decide whether `opts` is optional or not\n    // so we spread the argument rather than defining `opts:` ourselves.\n    ...args: OmitFirstArg<ConstructorParameters<T>>\n  ): this {\n    if (typeof Plugin !== 'function') {\n      const msg =\n        `Expected a plugin class, but got ${\n          Plugin === null ? 'null' : typeof Plugin\n        }.` +\n        ' Please verify that the plugin was imported and spelled correctly.'\n      throw new TypeError(msg)\n    }\n\n    // Instantiate\n    const plugin = new Plugin(this, ...args)\n    const pluginId = plugin.id\n\n    if (!pluginId) {\n      throw new Error('Your plugin must have an id')\n    }\n\n    if (!plugin.type) {\n      throw new Error('Your plugin must have a type')\n    }\n\n    const existsPluginAlready = this.getPlugin(pluginId)\n    if (existsPluginAlready) {\n      const msg =\n        `Already found a plugin named '${existsPluginAlready.id}'. ` +\n        `Tried to use: '${pluginId}'.\\n` +\n        'Uppy plugins must have unique `id` options. See https://uppy.io/docs/plugins/#id.'\n      throw new Error(msg)\n    }\n\n    // @ts-expect-error does exist\n    if (Plugin.VERSION) {\n      // @ts-expect-error does exist\n      this.log(`Using ${pluginId} v${Plugin.VERSION}`)\n    }\n\n    if (plugin.type in this.#plugins) {\n      this.#plugins[plugin.type].push(plugin)\n    } else {\n      this.#plugins[plugin.type] = [plugin]\n    }\n    plugin.install()\n\n    this.emit('plugin-added', plugin)\n\n    return this\n  }\n\n  /**\n   * Find one Plugin by name.\n   */\n  getPlugin<T extends UnknownPlugin<M, B> = UnknownPlugin<M, B>>(\n    id: string,\n  ): T | undefined {\n    for (const plugins of Object.values(this.#plugins)) {\n      const foundPlugin = plugins.find((plugin) => plugin.id === id)\n      if (foundPlugin != null) return foundPlugin as T\n    }\n    return undefined\n  }\n\n  private [Symbol.for('uppy test: getPlugins')](\n    type: string,\n  ): UnknownPlugin<M, B>[] {\n    return this.#plugins[type]\n  }\n\n  /**\n   * Iterate through all `use`d plugins.\n   *\n   */\n  iteratePlugins(method: (plugin: UnknownPlugin<M, B>) => void): void {\n    Object.values(this.#plugins).flat(1).forEach(method)\n  }\n\n  /**\n   * Uninstall and remove a plugin.\n   *\n   * @param {object} instance The plugin instance to remove.\n   */\n  removePlugin(instance: UnknownPlugin<M, B>): void {\n    this.log(`Removing plugin ${instance.id}`)\n    this.emit('plugin-remove', instance)\n\n    if (instance.uninstall) {\n      instance.uninstall()\n    }\n\n    const list = this.#plugins[instance.type]\n    // list.indexOf failed here, because Vue3 converted the plugin instance\n    // to a Proxy object, which failed the strict comparison test:\n    // obj !== objProxy\n    const index = list.findIndex((item) => item.id === instance.id)\n    if (index !== -1) {\n      list.splice(index, 1)\n    }\n\n    const state = this.getState()\n    const updatedState = {\n      plugins: {\n        ...state.plugins,\n        [instance.id]: undefined,\n      },\n    }\n    this.setState(updatedState)\n  }\n\n  /**\n   * Uninstall all plugins and close down this Uppy instance.\n   */\n  destroy(): void {\n    this.log(\n      `Closing Uppy instance ${this.opts.id}: removing all files and uninstalling plugins`,\n    )\n\n    this.cancelAll()\n\n    this.#storeUnsubscribe()\n\n    this.iteratePlugins((plugin) => {\n      this.removePlugin(plugin)\n    })\n\n    if (typeof window !== 'undefined' && window.removeEventListener) {\n      window.removeEventListener('online', this.#updateOnlineStatus)\n      window.removeEventListener('offline', this.#updateOnlineStatus)\n    }\n  }\n\n  hideInfo(): void {\n    const { info } = this.getState()\n\n    this.setState({ info: info.slice(1) })\n\n    this.emit('info-hidden')\n  }\n\n  /**\n   * Set info message in `state.info`, so that UI plugins like `Informer`\n   * can display the message.\n   */\n  info(\n    message:\n      | string\n      | { message: string; details?: string | Record<string, string> },\n    type: LogLevel = 'info',\n    duration = 3000,\n  ): void {\n    const isComplexMessage = typeof message === 'object'\n\n    this.setState({\n      info: [\n        ...this.getState().info,\n        {\n          type,\n          message: isComplexMessage ? message.message : message,\n          details: isComplexMessage ? message.details : null,\n        },\n      ],\n    })\n\n    setTimeout(() => this.hideInfo(), duration)\n\n    this.emit('info-visible')\n  }\n\n  /**\n   * Passes messages to a function, provided in `opts.logger`.\n   * If `opts.logger: Uppy.debugLogger` or `opts.debug: true`, logs to the browser console.\n   */\n  log(message: string | Record<any, any> | Error, type?: string): void {\n    const { logger } = this.opts\n    switch (type) {\n      case 'error':\n        logger.error(message)\n        break\n      case 'warning':\n        logger.warn(message)\n        break\n      default:\n        logger.debug(message)\n        break\n    }\n  }\n\n  // We need to store request clients by a unique ID, so we can share RequestClient instances across files\n  // this allows us to do rate limiting and synchronous operations like refreshing provider tokens\n  // example: refreshing tokens: if each file has their own requestclient,\n  // we don't have any way to synchronize all requests in order to\n  // - block all requests\n  // - refresh the token\n  // - unblock all requests and allow them to run with a the new access token\n  // back when we had a requestclient per file, once an access token expired,\n  // all 6 files would go ahead and refresh the token at the same time\n  // (calling /refresh-token up to 6 times), which will probably fail for some providers\n  #requestClientById = new Map<string, unknown>()\n\n  registerRequestClient(id: string, client: unknown): void {\n    this.#requestClientById.set(id, client)\n  }\n\n  /** @protected */\n  getRequestClientForFile<Client>(file: UppyFile<M, B>): Client {\n    if (!file.remote)\n      throw new Error(\n        `Tried to get RequestClient for a non-remote file ${file.id}`,\n      )\n    const requestClient = this.#requestClientById.get(\n      file.remote.requestClientId,\n    )\n    if (requestClient == null)\n      throw new Error(\n        `requestClientId \"${file.remote.requestClientId}\" not registered for file \"${file.id}\"`,\n      )\n    return requestClient as Client\n  }\n\n  /**\n   * Restore an upload by its ID.\n   */\n  restore(uploadID: string): Promise<UploadResult<M, B> | undefined> {\n    this.log(`Core: attempting to restore upload \"${uploadID}\"`)\n\n    if (!this.getState().currentUploads[uploadID]) {\n      this.#removeUpload(uploadID)\n      return Promise.reject(new Error('Nonexistent upload'))\n    }\n\n    return this.#runUpload(uploadID)\n  }\n\n  /**\n   * Create an upload for a bunch of files.\n   *\n   */\n  #createUpload(\n    fileIDs: string[],\n    opts: { forceAllowNewUpload?: boolean } = {},\n  ): string {\n    // uppy.retryAll sets this to true — when retrying we want to ignore `allowNewUpload: false`\n    const { forceAllowNewUpload = false } = opts\n\n    const { allowNewUpload, currentUploads } = this.getState()\n    if (!allowNewUpload && !forceAllowNewUpload) {\n      throw new Error('Cannot create a new upload: already uploading.')\n    }\n\n    const uploadID = nanoid()\n\n    this.emit('upload', uploadID, this.getFilesByIds(fileIDs))\n\n    this.setState({\n      allowNewUpload:\n        this.opts.allowMultipleUploadBatches !== false &&\n        this.opts.allowMultipleUploads !== false,\n\n      currentUploads: {\n        ...currentUploads,\n        [uploadID]: {\n          fileIDs,\n          step: 0,\n          result: {},\n        },\n      },\n    })\n\n    return uploadID\n  }\n\n  private [Symbol.for('uppy test: createUpload')](...args: any[]): string {\n    // @ts-expect-error https://github.com/microsoft/TypeScript/issues/47595\n    return this.#createUpload(...args)\n  }\n\n  #getUpload(uploadID: string): CurrentUpload<M, B> {\n    const { currentUploads } = this.getState()\n\n    return currentUploads[uploadID]\n  }\n\n  /**\n   * Add data to an upload's result object.\n   */\n  addResultData(uploadID: string, data: CurrentUpload<M, B>['result']): void {\n    if (!this.#getUpload(uploadID)) {\n      this.log(\n        `Not setting result for an upload that has been removed: ${uploadID}`,\n      )\n      return\n    }\n    const { currentUploads } = this.getState()\n    const currentUpload = {\n      ...currentUploads[uploadID],\n      result: { ...currentUploads[uploadID].result, ...data },\n    }\n    this.setState({\n      currentUploads: { ...currentUploads, [uploadID]: currentUpload },\n    })\n  }\n\n  /**\n   * Remove an upload, eg. if it has been canceled or completed.\n   *\n   */\n  #removeUpload(uploadID: string): void {\n    const currentUploads = { ...this.getState().currentUploads }\n    delete currentUploads[uploadID]\n\n    this.setState({\n      currentUploads,\n    })\n  }\n\n  /**\n   * Run an upload. This picks up where it left off in case the upload is being restored.\n   */\n  async #runUpload(uploadID: string): Promise<UploadResult<M, B> | undefined> {\n    const getCurrentUpload = (): CurrentUpload<M, B> => {\n      const { currentUploads } = this.getState()\n      return currentUploads[uploadID]\n    }\n\n    let currentUpload = getCurrentUpload()\n\n    const steps = [\n      ...this.#preProcessors,\n      ...this.#uploaders,\n      ...this.#postProcessors,\n    ]\n    try {\n      for (let step = currentUpload.step || 0; step < steps.length; step++) {\n        if (!currentUpload) {\n          break\n        }\n        const fn = steps[step]\n\n        this.setState({\n          currentUploads: {\n            ...this.getState().currentUploads,\n            [uploadID]: {\n              ...currentUpload,\n              step,\n            },\n          },\n        })\n\n        const { fileIDs } = currentUpload\n\n        // TODO give this the `updatedUpload` object as its only parameter maybe?\n        // Otherwise when more metadata may be added to the upload this would keep getting more parameters\n        await fn(fileIDs, uploadID)\n\n        // Update currentUpload value in case it was modified asynchronously.\n        currentUpload = getCurrentUpload()\n      }\n    } catch (err) {\n      this.#removeUpload(uploadID)\n      throw err\n    }\n\n    // Set result data.\n    if (currentUpload) {\n      // Mark postprocessing step as complete if necessary; this addresses a case where we might get\n      // stuck in the postprocessing UI while the upload is fully complete.\n      // If the postprocessing steps do not do any work, they may not emit postprocessing events at\n      // all, and never mark the postprocessing as complete. This is fine on its own but we\n      // introduced code in the @uppy/core upload-success handler to prepare postprocessing progress\n      // state if any postprocessors are registered. That is to avoid a \"flash of completed state\"\n      // before the postprocessing plugins can emit events.\n      //\n      // So, just in case an upload with postprocessing plugins *has* completed *without* emitting\n      // postprocessing completion, we do it instead.\n      currentUpload.fileIDs.forEach((fileID) => {\n        const file = this.getFile(fileID)\n        if (file && file.progress.postprocess) {\n          this.emit('postprocess-complete', file)\n        }\n      })\n\n      const files = currentUpload.fileIDs.map((fileID) => this.getFile(fileID))\n      const successful = files.filter((file) => !file.error)\n      const failed = files.filter((file) => file.error)\n      this.addResultData(uploadID, { successful, failed, uploadID })\n\n      // Update currentUpload value in case it was modified asynchronously.\n      currentUpload = getCurrentUpload()\n    }\n    // Emit completion events.\n    // This is in a separate function so that the `currentUploads` variable\n    // always refers to the latest state. In the handler right above it refers\n    // to an outdated object without the `.result` property.\n    let result\n    if (currentUpload) {\n      result = currentUpload.result\n      this.emit('complete', result)\n\n      this.#removeUpload(uploadID)\n    }\n    if (result == null) {\n      this.log(\n        `Not setting result for an upload that has been removed: ${uploadID}`,\n      )\n    }\n    return result\n  }\n\n  /**\n   * Start an upload for all the files that are not currently being uploaded.\n   */\n  upload(): Promise<NonNullable<UploadResult<M, B>> | undefined> {\n    if (!this.#plugins['uploader']?.length) {\n      this.log('No uploader type plugins are used', 'warning')\n    }\n\n    let { files } = this.getState()\n\n    const onBeforeUploadResult = this.opts.onBeforeUpload(files)\n\n    if (onBeforeUploadResult === false) {\n      return Promise.reject(\n        new Error(\n          'Not starting the upload because onBeforeUpload returned false',\n        ),\n      )\n    }\n\n    if (onBeforeUploadResult && typeof onBeforeUploadResult === 'object') {\n      files = onBeforeUploadResult\n      // Updating files in state, because uploader plugins receive file IDs,\n      // and then fetch the actual file object from state\n      this.setState({\n        files,\n      })\n    }\n\n    return Promise.resolve()\n      .then(() => this.#restricter.validateMinNumberOfFiles(files))\n      .catch((err) => {\n        this.#informAndEmit([err])\n        throw err\n      })\n      .then(() => {\n        if (!this.#checkRequiredMetaFields(files)) {\n          throw new RestrictionError(this.i18n('missingRequiredMetaField'))\n        }\n      })\n      .catch((err) => {\n        // Doing this in a separate catch because we already emited and logged\n        // all the errors in `checkRequiredMetaFields` so we only throw a generic\n        // missing fields error here.\n        throw err\n      })\n      .then(() => {\n        const { currentUploads } = this.getState()\n        // get a list of files that are currently assigned to uploads\n        const currentlyUploadingFiles = Object.values(currentUploads).flatMap(\n          (curr) => curr.fileIDs,\n        )\n\n        const waitingFileIDs: string[] = []\n        Object.keys(files).forEach((fileID) => {\n          const file = this.getFile(fileID)\n          // if the file hasn't started uploading and hasn't already been assigned to an upload..\n          if (\n            !file.progress.uploadStarted &&\n            currentlyUploadingFiles.indexOf(fileID) === -1\n          ) {\n            waitingFileIDs.push(file.id)\n          }\n        })\n\n        const uploadID = this.#createUpload(waitingFileIDs)\n        return this.#runUpload(uploadID)\n      })\n      .catch((err) => {\n        this.emit('error', err)\n        this.log(err, 'error')\n        throw err\n      })\n  }\n}\n\nexport default Uppy\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["Translator","ee","nanoid","throttle","DefaultStore","getFileType","getFileNameAndExtension","getSafeFileId","supportsUploadProgress","getFileName","getFilePlugins","justErrorsLogger","debugLogger","Restricter","defaultOptions","defaultRestrictionOptions","RestrictionError","packageJson","locale","defaultUploadState","totalProgress","allowNewUpload","error","recoveredState","_plugins","_classPrivateFieldLooseKey","_restricter","_storeUnsubscribe","_emitter","_preProcessors","_uploaders","_postProcessors","_installingPlugin","_informAndEmit","_checkRequiredMetaFieldsOnFile","_checkRequiredMetaFields","_assertNewUploadAllowed","_transformFile","_startIfAutoProceed","_checkAndUpdateFileState","_addListeners","_updateOnlineStatus","_requestClientById","_createUpload","_getUpload","_removeUpload","_runUpload","Uppy","constructor","opts","Object","defineProperty","value","_runUpload2","_removeUpload2","_getUpload2","_createUpload2","_addListeners2","_checkAndUpdateFileState2","_startIfAutoProceed2","_transformFile2","_assertNewUploadAllowed2","_checkRequiredMetaFields2","_checkRequiredMetaFieldsOnFile2","_informAndEmit2","writable","create","Set","Map","scheduledAutoProceed","wasOffline","calculateProgress","file","data","fileInState","getFile","id","log","progress","percentage","canHavePercentage","Number","isFinite","bytesTotal","setFileState","bytesUploaded","Math","round","calculateTotalProgress","leading","trailing","updateOnlineStatus","bind","defaultLocale","autoProceed","allowMultipleUploadBatches","debug","restrictions","meta","onBeforeFileAdded","files","hasOwn","onBeforeUpload","store","logger","infoTimeout","merged","VERSION","i18nInit","setState","plugins","currentUploads","capabilities","uploadProgress","individualCancellation","resumableUploads","info","_classPrivateFieldLooseBase","i18n","subscribe","prevState","nextState","patch","emit","updateAll","window","event","_len","arguments","length","args","Array","_key","on","callback","once","off","state","iteratePlugins","plugin","update","getState","patchFilesState","filesWithNewState","existingFilesState","fromEntries","entries","map","_ref","fileID","newFileState","Error","onMissingKey","key","translator","translate","i18nArray","translateArray","setOptions","newOpts","setMeta","undefined","resetProgress","defaultProgress","uploadComplete","uploadStarted","updatedFiles","keys","forEach","clear","addPreProcessor","fn","add","removePreProcessor","delete","addPostProcessor","removePostProcessor","addUploader","_classPrivateFieldLoo","set","removeUploader","updatedMeta","setFileMeta","newMeta","getFiles","values","getFilesByIds","ids","getObjectOfFilesPerState","filesObject","inProgressFiles","newFiles","startedFiles","uploadStartedFiles","pausedFiles","completeFiles","erroredFiles","inProgressNotPausedFiles","processingFiles","push","isPaused","preprocess","postprocess","isUploadStarted","isAllComplete","isAllErrored","isAllPaused","isUploadInProgress","isSomeGhost","some","isGhost","validateSingleFile","err","message","validateAggregateRestrictions","existingFiles","checkIfFileAlreadyExists","addFile","nextFilesState","validFilesToAdd","errors","restrictionErrors","filter","isRestriction","firstValidFileToAdd","name","type","addFiles","fileDescriptors","nonRestrictionErrors","subError","smart_count","details","AggregateError","removeFiles","fileIDs","updatedUploads","removedFiles","fileIsNotRemoved","uploadFileID","uploadID","newFileIDs","stateUpdate","removedFileIDs","join","removeFile","pauseResume","wasPaused","pauseAll","inProgressUpdatedFiles","updatedFile","resumeAll","retryAll","filesToRetry","Promise","resolve","successful","failed","forceAllowNewUpload","cancelAll","retryUpload","logout","_provider","provider","inProgress","sizedFiles","unsizedFiles","progressMax","currentProgress","reduce","acc","totalSize","_file$progress$bytesT","averageSize","uploadedSize","_window$navigator$onL","online","navigator","onLine","getID","use","Plugin","msg","TypeError","_len2","_key2","pluginId","existsPluginAlready","getPlugin","install","foundPlugin","find","Symbol","for","method","flat","removePlugin","instance","uninstall","list","index","findIndex","item","splice","updatedState","destroy","removeEventListener","hideInfo","slice","duration","isComplexMessage","setTimeout","warn","registerRequestClient","client","getRequestClientForFile","remote","requestClient","get","requestClientId","restore","reject","addResultData","currentUpload","result","upload","_classPrivateFieldLoo2","onBeforeUploadResult","then","validateMinNumberOfFiles","catch","currentlyUploadingFiles","flatMap","curr","waitingFileIDs","indexOf","userFacingErrors","isUserFacing","maxNumToShow","firstErrors","additionalErrors","_ref2","count","missingFields","getMissingRequiredMetaFields","missingRequiredMetaFields","success","fileDescriptorOrFile","File","size","fileType","fileName","filePlugins","fileExtension","extension","source","isRemote","preview","stack","filesToAdd","fileToAdd","_existingFiles$newFil","newFile","existingFileState","onBeforeFileAddedResult","_newFile$name","errorHandler","response","errorMsg","_file$name","newError","request","uploadStalledWarningRecentlyEmitted","trim","onUploadStarted","filesFiltered","exists","filesState","Date","now","uploadResp","mode","uploadURL","addEventListener","allowMultipleUploads","step","getCurrentUpload","steps","uploaderFileIds","uploaderPlugin","_file$plugins","_file$plugins2","includes","version"],"sources":["Uppy.ts"],"sourcesContent":["/* eslint-disable max-classes-per-file */\n/* global AggregateError */\n\nimport type { h } from 'preact'\nimport Translator from '@uppy/utils/lib/Translator'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore untyped\nimport ee from 'namespace-emitter'\nimport { nanoid } from 'nanoid/non-secure'\nimport throttle from 'lodash/throttle.js'\nimport DefaultStore, { type Store } from '@uppy/store-default'\nimport getFileType from '@uppy/utils/lib/getFileType'\nimport getFileNameAndExtension from '@uppy/utils/lib/getFileNameAndExtension'\nimport { getSafeFileId } from '@uppy/utils/lib/generateFileID'\nimport type {\n  UppyFile,\n  Meta,\n  Body,\n  MinimalRequiredUppyFile,\n} from '@uppy/utils/lib/UppyFile'\nimport type { CompanionFile } from '@uppy/utils/lib/CompanionFile'\nimport type {\n  CompanionClientProvider,\n  CompanionClientSearchProvider,\n} from '@uppy/utils/lib/CompanionClientProvider'\nimport type {\n  FileProgressNotStarted,\n  FileProgressStarted,\n} from '@uppy/utils/lib/FileProgress'\nimport type {\n  Locale,\n  I18n,\n  OptionalPluralizeLocale,\n} from '@uppy/utils/lib/Translator'\nimport supportsUploadProgress from './supportsUploadProgress.ts'\nimport getFileName from './getFileName.ts'\nimport getFilePlugins from './getFilePlugins.ts'\nimport { justErrorsLogger, debugLogger } from './loggers.ts'\nimport {\n  Restricter,\n  defaultOptions as defaultRestrictionOptions,\n  RestrictionError,\n} from './Restricter.ts'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\nimport locale from './locale.ts'\n\nimport type BasePlugin from './BasePlugin.ts'\nimport type { Restrictions, ValidateableFile } from './Restricter.ts'\n\ntype Processor = (\n  fileIDs: string[],\n  uploadID: string,\n) => Promise<unknown> | void\n\ntype LogLevel = 'info' | 'warning' | 'error' | 'success'\n\nexport type UnknownPlugin<\n  M extends Meta,\n  B extends Body,\n  PluginState extends Record<string, unknown> = Record<string, unknown>,\n> = BasePlugin<any, M, B, PluginState>\n\n/**\n * ids are always `string`s, except the root folder's id can be `null`\n */\nexport type PartialTreeId = string | null\n\nexport type PartialTreeStatusFile = 'checked' | 'unchecked'\nexport type PartialTreeStatus = PartialTreeStatusFile | 'partial'\n\nexport type PartialTreeFile = {\n  type: 'file'\n  id: string\n\n  /**\n   * There exist two types of restrictions:\n   * - individual restrictions (`allowedFileTypes`, `minFileSize`, `maxFileSize`), and\n   * - aggregate restrictions (`maxNumberOfFiles`, `maxTotalFileSize`).\n   *\n   * `.restrictionError` reports whether this file passes individual restrictions.\n   *\n   */\n  restrictionError: string | null\n\n  status: PartialTreeStatusFile\n  parentId: PartialTreeId\n  data: CompanionFile\n}\n\nexport type PartialTreeFolderNode = {\n  type: 'folder'\n  id: string\n\n  /**\n   * Consider `(.nextPagePath, .cached)` a composite key that can represent 4 states:\n   * - `{ cached: true, nextPagePath: null }` - we fetched all pages in this folder\n   * - `{ cached: true, nextPagePath: 'smth' }` - we fetched 1st page, and there are still pages left to fetch in this folder\n   * - `{ cached: false, nextPagePath: null }` - we didn't fetch the 1st page in this folder\n   * - `{ cached: false, nextPagePath: 'someString' }` - ❌ CAN'T HAPPEN ❌\n   */\n  cached: boolean\n  nextPagePath: PartialTreeId\n\n  status: PartialTreeStatus\n  parentId: PartialTreeId\n  data: CompanionFile\n}\n\nexport type PartialTreeFolderRoot = {\n  type: 'root'\n  id: PartialTreeId\n\n  cached: boolean\n  nextPagePath: PartialTreeId\n}\n\nexport type PartialTreeFolder = PartialTreeFolderNode | PartialTreeFolderRoot\n\n/**\n * PartialTree has the following structure.\n *\n *           FolderRoot\n *         ┌─────┴─────┐\n *     FolderNode     File\n *   ┌─────┴────┐\n *  File      File\n *\n * Root folder is called `PartialTreeFolderRoot`,\n * all other folders are called `PartialTreeFolderNode`, because they are \"internal nodes\".\n *\n * It's possible for `PartialTreeFolderNode` to be a leaf node if it doesn't contain any files.\n */\nexport type PartialTree = (PartialTreeFile | PartialTreeFolder)[]\n\nexport type UnknownProviderPluginState = {\n  authenticated: boolean | undefined\n  didFirstRender: boolean\n  searchString: string\n  loading: boolean | string\n  partialTree: PartialTree\n  currentFolderId: PartialTreeId\n  username: string | null\n}\n/*\n * UnknownProviderPlugin can be any Companion plugin (such as Google Drive).\n * As the plugins are passed around throughout Uppy we need a generic type for this.\n * It may seems like duplication, but this type safe. Changing the type of `storage`\n * will error in the `Provider` class of @uppy/companion-client and vice versa.\n *\n * Note that this is the *plugin* class, not a version of the `Provider` class.\n * `Provider` does operate on Companion plugins with `uppy.getPlugin()`.\n */\nexport type UnknownProviderPlugin<\n  M extends Meta,\n  B extends Body,\n> = UnknownPlugin<M, B, UnknownProviderPluginState> & {\n  title: string\n  rootFolderId: string | null\n  files: UppyFile<M, B>[]\n  icon: () => h.JSX.Element\n  provider: CompanionClientProvider\n  storage: {\n    getItem: (key: string) => Promise<string | null>\n    setItem: (key: string, value: string) => Promise<void>\n    removeItem: (key: string) => Promise<void>\n  }\n}\n\n/*\n * UnknownSearchProviderPlugin can be any search Companion plugin (such as Unsplash).\n * As the plugins are passed around throughout Uppy we need a generic type for this.\n * It may seems like duplication, but this type safe. Changing the type of `title`\n * will error in the `SearchProvider` class of @uppy/companion-client and vice versa.\n *\n * Note that this is the *plugin* class, not a version of the `SearchProvider` class.\n * `SearchProvider` does operate on Companion plugins with `uppy.getPlugin()`.\n */\nexport type UnknownSearchProviderPluginState = {\n  isInputMode: boolean\n} & Pick<\n  UnknownProviderPluginState,\n  'loading' | 'searchString' | 'partialTree' | 'currentFolderId'\n>\nexport type UnknownSearchProviderPlugin<\n  M extends Meta,\n  B extends Body,\n> = UnknownPlugin<M, B, UnknownSearchProviderPluginState> & {\n  title: string\n  icon: () => h.JSX.Element\n  provider: CompanionClientSearchProvider\n}\n\nexport interface UploadResult<M extends Meta, B extends Body> {\n  successful?: UppyFile<M, B>[]\n  failed?: UppyFile<M, B>[]\n  uploadID?: string\n  [key: string]: unknown\n}\n\ninterface CurrentUpload<M extends Meta, B extends Body> {\n  fileIDs: string[]\n  step: number\n  result: UploadResult<M, B>\n}\n\n// TODO: can we use namespaces in other plugins to populate this?\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\ninterface Plugins extends Record<string, Record<string, unknown> | undefined> {}\n\nexport interface State<M extends Meta, B extends Body>\n  extends Record<string, unknown> {\n  meta: M\n  capabilities: {\n    uploadProgress: boolean\n    individualCancellation: boolean\n    resumableUploads: boolean\n    isMobileDevice?: boolean\n    darkMode?: boolean\n  }\n  currentUploads: Record<string, CurrentUpload<M, B>>\n  allowNewUpload: boolean\n  recoveredState: null | Required<Pick<State<M, B>, 'files' | 'currentUploads'>>\n  error: string | null\n  files: {\n    [key: string]: UppyFile<M, B>\n  }\n  info: Array<{\n    isHidden?: boolean\n    type: LogLevel\n    message: string\n    details?: string | Record<string, string> | null\n  }>\n  plugins: Plugins\n  totalProgress: number\n  companion?: Record<string, string>\n}\n\nexport interface UppyOptions<M extends Meta, B extends Body> {\n  id?: string\n  autoProceed?: boolean\n  /**\n   * @deprecated Use allowMultipleUploadBatches\n   */\n  allowMultipleUploads?: boolean\n  allowMultipleUploadBatches?: boolean\n  logger?: typeof debugLogger\n  debug?: boolean\n  restrictions: Restrictions\n  meta?: M\n  onBeforeFileAdded?: (\n    currentFile: UppyFile<M, B>,\n    files: { [key: string]: UppyFile<M, B> },\n  ) => UppyFile<M, B> | boolean | undefined\n  onBeforeUpload?: (files: {\n    [key: string]: UppyFile<M, B>\n  }) => { [key: string]: UppyFile<M, B> } | boolean\n  locale?: Locale\n  store?: Store<State<M, B>>\n  infoTimeout?: number\n}\n\nexport interface UppyOptionsWithOptionalRestrictions<\n  M extends Meta,\n  B extends Body,\n> extends Omit<UppyOptions<M, B>, 'restrictions'> {\n  restrictions?: Partial<Restrictions>\n}\n\n// The user facing type for UppyOptions used in uppy.setOptions()\ntype MinimalRequiredOptions<M extends Meta, B extends Body> = Partial<\n  Omit<UppyOptions<M, B>, 'locale' | 'meta' | 'restrictions'> & {\n    locale: OptionalPluralizeLocale\n    meta: Partial<M>\n    restrictions: Partial<Restrictions>\n  }\n>\n\nexport type NonNullableUppyOptions<M extends Meta, B extends Body> = Required<\n  UppyOptions<M, B>\n>\n\nexport interface _UppyEventMap<M extends Meta, B extends Body> {\n  'back-online': () => void\n  'cancel-all': () => void\n  complete: (result: UploadResult<M, B>) => void\n  error: (\n    error: { name: string; message: string; details?: string },\n    file?: UppyFile<M, B>,\n    response?: UppyFile<M, B>['response'],\n  ) => void\n  'file-added': (file: UppyFile<M, B>) => void\n  'file-removed': (file: UppyFile<M, B>) => void\n  'files-added': (files: UppyFile<M, B>[]) => void\n  'info-hidden': () => void\n  'info-visible': () => void\n  'is-offline': () => void\n  'is-online': () => void\n  'pause-all': () => void\n  'plugin-added': (plugin: UnknownPlugin<any, any>) => void\n  'plugin-remove': (plugin: UnknownPlugin<any, any>) => void\n  'postprocess-complete': (\n    file: UppyFile<M, B> | undefined,\n    progress?: NonNullable<FileProgressStarted['preprocess']>,\n  ) => void\n  'postprocess-progress': (\n    file: UppyFile<M, B> | undefined,\n    progress: NonNullable<FileProgressStarted['postprocess']>,\n  ) => void\n  'preprocess-complete': (\n    file: UppyFile<M, B> | undefined,\n    progress?: NonNullable<FileProgressStarted['preprocess']>,\n  ) => void\n  'preprocess-progress': (\n    file: UppyFile<M, B> | undefined,\n    progress: NonNullable<FileProgressStarted['preprocess']>,\n  ) => void\n  progress: (progress: number) => void\n  restored: (pluginData: any) => void\n  'restore-confirmed': () => void\n  'restore-canceled': () => void\n  'restriction-failed': (file: UppyFile<M, B> | undefined, error: Error) => void\n  'resume-all': () => void\n  'retry-all': (files: UppyFile<M, B>[]) => void\n  'state-update': (\n    prevState: State<M, B>,\n    nextState: State<M, B>,\n    patch?: Partial<State<M, B>>,\n  ) => void\n  upload: (uploadID: string, files: UppyFile<M, B>[]) => void\n  'upload-error': (\n    file: UppyFile<M, B> | undefined,\n    error: { name: string; message: string; details?: string },\n    response?:\n      | Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'>\n      | undefined,\n  ) => void,\n  'modify-upload-error': (\n    file: UppyFile<M, B> | undefined,\n    error: {\n      name: string\n      message: string\n      request: XMLHttpRequest\n      details?: string\n    },\n    response?:\n      | Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'>\n      | undefined,\n  ) => void\n  'upload-pause': (file: UppyFile<M, B> | undefined, isPaused: boolean) => void\n  'upload-progress': (\n    file: UppyFile<M, B> | undefined,\n    progress: FileProgressStarted,\n  ) => void\n  'upload-retry': (file: UppyFile<M, B>) => void\n  'upload-stalled': (\n    error: { message: string; details?: string },\n    files: UppyFile<M, B>[],\n  ) => void\n  'upload-success': (\n    file: UppyFile<M, B> | undefined,\n    response: NonNullable<UppyFile<M, B>['response']>,\n  ) => void\n}\n\nexport interface UppyEventMap<M extends Meta, B extends Body>\n  extends _UppyEventMap<M, B> {\n  'upload-start': (files: UppyFile<M, B>[]) => void\n}\n\n/** `OmitFirstArg<typeof someArray>` is the type of the returned value of `someArray.slice(1)`. */\ntype OmitFirstArg<T> = T extends [any, ...infer U] ? U : never\n\nconst defaultUploadState = {\n  totalProgress: 0,\n  allowNewUpload: true,\n  error: null,\n  recoveredState: null,\n}\n\n/**\n * Uppy Core module.\n * Manages plugins, state updates, acts as an event bus,\n * adds/removes files and metadata.\n */\nexport class Uppy<\n  M extends Meta = Meta,\n  B extends Body = Record<string, never>,\n> {\n  static VERSION = packageJson.version\n\n  #plugins: Record<string, UnknownPlugin<M, B>[]> = Object.create(null)\n\n  #restricter\n\n  #storeUnsubscribe\n\n  #emitter = ee()\n\n  #preProcessors: Set<Processor> = new Set()\n\n  #uploaders: Map<Processor, string> = new Map()\n\n  #postProcessors: Set<Processor> = new Set()\n\n  #installingPlugin?: string\n\n  defaultLocale: Locale\n\n  locale!: Locale\n\n  // The user optionally passes in options, but we set defaults for missing options.\n  // We consider all options present after the contructor has run.\n  opts: NonNullableUppyOptions<M, B>\n\n  store: NonNullableUppyOptions<M, B>['store']\n\n  i18n!: I18n\n\n  i18nArray!: Translator['translateArray']\n\n  scheduledAutoProceed: ReturnType<typeof setTimeout> | null = null\n\n  wasOffline = false\n\n  /**\n   * Instantiate Uppy\n   */\n  constructor(opts?: UppyOptionsWithOptionalRestrictions<M, B>) {\n    this.defaultLocale = locale as any as Locale\n\n    const defaultOptions: UppyOptions<Record<string, unknown>, B> = {\n      id: 'uppy',\n      autoProceed: false,\n      allowMultipleUploadBatches: true,\n      debug: false,\n      restrictions: defaultRestrictionOptions,\n      meta: {},\n      onBeforeFileAdded: (file, files) => !Object.hasOwn(files, file.id),\n      onBeforeUpload: (files) => files,\n      store: new DefaultStore(),\n      logger: justErrorsLogger,\n      infoTimeout: 5000,\n    }\n\n    const merged = { ...defaultOptions, ...opts } as Omit<\n      NonNullableUppyOptions<M, B>,\n      'restrictions'\n    >\n    // Merge default options with the ones set by user,\n    // making sure to merge restrictions too\n    this.opts = {\n      ...merged,\n      restrictions: {\n        ...(defaultOptions.restrictions as Restrictions),\n        ...(opts && opts.restrictions),\n      },\n    }\n\n    // Support debug: true for backwards-compatability, unless logger is set in opts\n    // opts instead of this.opts to avoid comparing objects — we set logger: justErrorsLogger in defaultOptions\n    if (opts && opts.logger && opts.debug) {\n      this.log(\n        'You are using a custom `logger`, but also set `debug: true`, which uses built-in logger to output logs to console. Ignoring `debug: true` and using your custom `logger`.',\n        'warning',\n      )\n    } else if (opts && opts.debug) {\n      this.opts.logger = debugLogger\n    }\n\n    this.log(`Using Core v${Uppy.VERSION}`)\n\n    this.i18nInit()\n\n    this.store = this.opts.store\n    this.setState({\n      ...defaultUploadState,\n      plugins: {},\n      files: {},\n      currentUploads: {},\n      capabilities: {\n        uploadProgress: supportsUploadProgress(),\n        individualCancellation: true,\n        resumableUploads: false,\n      },\n      meta: { ...this.opts.meta },\n      info: [],\n    })\n\n    this.#restricter = new Restricter<M, B>(\n      () => this.opts,\n      () => this.i18n,\n    )\n\n    this.#storeUnsubscribe = this.store.subscribe(\n      (prevState, nextState, patch) => {\n        this.emit('state-update', prevState, nextState, patch)\n        this.updateAll(nextState)\n      },\n    )\n\n    // Exposing uppy object on window for debugging and testing\n    if (this.opts.debug && typeof window !== 'undefined') {\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore Mutating the global object for debug purposes\n      window[this.opts.id] = this\n    }\n\n    this.#addListeners()\n  }\n\n  emit<T extends keyof UppyEventMap<M, B>>(\n    event: T,\n    ...args: Parameters<UppyEventMap<M, B>[T]>\n  ): void {\n    this.#emitter.emit(event, ...args)\n  }\n\n  on<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    callback: UppyEventMap<M, B>[K],\n  ): this {\n    this.#emitter.on(event, callback)\n    return this\n  }\n\n  once<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    callback: UppyEventMap<M, B>[K],\n  ): this {\n    this.#emitter.once(event, callback)\n    return this\n  }\n\n  off<K extends keyof UppyEventMap<M, B>>(\n    event: K,\n    callback: UppyEventMap<M, B>[K],\n  ): this {\n    this.#emitter.off(event, callback)\n    return this\n  }\n\n  /**\n   * Iterate on all plugins and run `update` on them.\n   * Called each time state changes.\n   *\n   */\n  updateAll(state: Partial<State<M, B>>): void {\n    this.iteratePlugins((plugin: UnknownPlugin<M, B>) => {\n      plugin.update(state)\n    })\n  }\n\n  /**\n   * Updates state with a patch\n   */\n  setState(patch?: Partial<State<M, B>>): void {\n    this.store.setState(patch)\n  }\n\n  /**\n   * Returns current state.\n   */\n  getState(): State<M, B> {\n    return this.store.getState()\n  }\n\n  patchFilesState(filesWithNewState: {\n    [id: string]: Partial<UppyFile<M, B>>\n  }): void {\n    const existingFilesState = this.getState().files\n\n    this.setState({\n      files: {\n        ...existingFilesState,\n        ...Object.fromEntries(\n          Object.entries(filesWithNewState).map(([fileID, newFileState]) => [\n            fileID,\n            {\n              ...existingFilesState[fileID],\n              ...newFileState,\n            },\n          ]),\n        ),\n      },\n    })\n  }\n\n  /**\n   * Shorthand to set state for a specific file.\n   */\n  setFileState(fileID: string, state: Partial<UppyFile<M, B>>): void {\n    if (!this.getState().files[fileID]) {\n      throw new Error(\n        `Can’t set state for ${fileID} (the file could have been removed)`,\n      )\n    }\n\n    this.patchFilesState({ [fileID]: state })\n  }\n\n  i18nInit(): void {\n    const onMissingKey = (key: string): void =>\n      this.log(`Missing i18n string: ${key}`, 'error')\n    const translator = new Translator([this.defaultLocale, this.opts.locale], {\n      onMissingKey,\n    })\n    this.i18n = translator.translate.bind(translator)\n    this.i18nArray = translator.translateArray.bind(translator)\n    this.locale = translator.locale\n  }\n\n  setOptions(newOpts: MinimalRequiredOptions<M, B>): void {\n    this.opts = {\n      ...this.opts,\n      ...(newOpts as UppyOptions<M, B>),\n      restrictions: {\n        ...this.opts.restrictions,\n        ...(newOpts?.restrictions as Restrictions),\n      },\n    }\n\n    if (newOpts.meta) {\n      this.setMeta(newOpts.meta)\n    }\n\n    this.i18nInit()\n\n    if (newOpts.locale) {\n      this.iteratePlugins((plugin) => {\n        plugin.setOptions(newOpts)\n      })\n    }\n\n    // Note: this is not the preact `setState`, it's an internal function that has the same name.\n    this.setState(undefined) // so that UI re-renders with new options\n  }\n\n  resetProgress(): void {\n    const defaultProgress: Omit<FileProgressNotStarted, 'bytesTotal'> = {\n      percentage: 0,\n      bytesUploaded: false,\n      uploadComplete: false,\n      uploadStarted: null,\n    }\n    const files = { ...this.getState().files }\n    const updatedFiles: State<M, B>['files'] = Object.create(null)\n\n    Object.keys(files).forEach((fileID) => {\n      updatedFiles[fileID] = {\n        ...files[fileID],\n        progress: {\n          ...files[fileID].progress,\n          ...defaultProgress,\n        },\n      }\n    })\n\n    this.setState({ files: updatedFiles, ...defaultUploadState })\n  }\n\n  clear(): void {\n    const { capabilities, currentUploads } = this.getState()\n    if (\n      Object.keys(currentUploads).length > 0 &&\n      !capabilities.individualCancellation\n    ) {\n      throw new Error(\n        'The installed uploader plugin does not allow removing files during an upload.',\n      )\n    }\n\n    this.setState({ ...defaultUploadState, files: {} })\n  }\n\n  addPreProcessor(fn: Processor): void {\n    this.#preProcessors.add(fn)\n  }\n\n  removePreProcessor(fn: Processor): boolean {\n    return this.#preProcessors.delete(fn)\n  }\n\n  addPostProcessor(fn: Processor): void {\n    this.#postProcessors.add(fn)\n  }\n\n  removePostProcessor(fn: Processor): boolean {\n    return this.#postProcessors.delete(fn)\n  }\n\n  addUploader(fn: Processor): void {\n    this.#uploaders.set(fn, this.#installingPlugin ?? '')\n  }\n\n  removeUploader(fn: Processor): boolean {\n    return this.#uploaders.delete(fn)\n  }\n\n  setMeta(data: Partial<M>): void {\n    const updatedMeta = { ...this.getState().meta, ...data }\n    const updatedFiles = { ...this.getState().files }\n\n    Object.keys(updatedFiles).forEach((fileID) => {\n      updatedFiles[fileID] = {\n        ...updatedFiles[fileID],\n        meta: { ...updatedFiles[fileID].meta, ...data },\n      }\n    })\n\n    this.log('Adding metadata:')\n    this.log(data)\n\n    this.setState({\n      meta: updatedMeta,\n      files: updatedFiles,\n    })\n  }\n\n  setFileMeta(fileID: string, data: State<M, B>['meta']): void {\n    const updatedFiles = { ...this.getState().files }\n    if (!updatedFiles[fileID]) {\n      this.log(\n        'Was trying to set metadata for a file that has been removed: ',\n        fileID,\n      )\n      return\n    }\n    const newMeta = { ...updatedFiles[fileID].meta, ...data }\n    updatedFiles[fileID] = { ...updatedFiles[fileID], meta: newMeta }\n    this.setState({ files: updatedFiles })\n  }\n\n  /**\n   * Get a file object.\n   */\n  getFile(fileID: string): UppyFile<M, B> {\n    return this.getState().files[fileID]\n  }\n\n  /**\n   * Get all files in an array.\n   */\n  getFiles(): UppyFile<M, B>[] {\n    const { files } = this.getState()\n    return Object.values(files)\n  }\n\n  getFilesByIds(ids: string[]): UppyFile<M, B>[] {\n    return ids.map((id) => this.getFile(id))\n  }\n\n  getObjectOfFilesPerState(): {\n    newFiles: UppyFile<M, B>[]\n    startedFiles: UppyFile<M, B>[]\n    uploadStartedFiles: UppyFile<M, B>[]\n    pausedFiles: UppyFile<M, B>[]\n    completeFiles: UppyFile<M, B>[]\n    erroredFiles: UppyFile<M, B>[]\n    inProgressFiles: UppyFile<M, B>[]\n    inProgressNotPausedFiles: UppyFile<M, B>[]\n    processingFiles: UppyFile<M, B>[]\n    isUploadStarted: boolean\n    isAllComplete: boolean\n    isAllErrored: boolean\n    isAllPaused: boolean\n    isUploadInProgress: boolean\n    isSomeGhost: boolean\n  } {\n    const { files: filesObject, totalProgress, error } = this.getState()\n    const files = Object.values(filesObject)\n\n    const inProgressFiles: UppyFile<M, B>[] = []\n    const newFiles: UppyFile<M, B>[] = []\n    const startedFiles: UppyFile<M, B>[] = []\n    const uploadStartedFiles: UppyFile<M, B>[] = []\n    const pausedFiles: UppyFile<M, B>[] = []\n    const completeFiles: UppyFile<M, B>[] = []\n    const erroredFiles: UppyFile<M, B>[] = []\n    const inProgressNotPausedFiles: UppyFile<M, B>[] = []\n    const processingFiles: UppyFile<M, B>[] = []\n\n    for (const file of files) {\n      const { progress } = file\n\n      if (!progress.uploadComplete && progress.uploadStarted) {\n        inProgressFiles.push(file)\n        if (!file.isPaused) {\n          inProgressNotPausedFiles.push(file)\n        }\n      }\n      if (!progress.uploadStarted) {\n        newFiles.push(file)\n      }\n      if (\n        progress.uploadStarted ||\n        progress.preprocess ||\n        progress.postprocess\n      ) {\n        startedFiles.push(file)\n      }\n      if (progress.uploadStarted) {\n        uploadStartedFiles.push(file)\n      }\n      if (file.isPaused) {\n        pausedFiles.push(file)\n      }\n      if (progress.uploadComplete) {\n        completeFiles.push(file)\n      }\n      if (file.error) {\n        erroredFiles.push(file)\n      }\n      if (progress.preprocess || progress.postprocess) {\n        processingFiles.push(file)\n      }\n    }\n\n    return {\n      newFiles,\n      startedFiles,\n      uploadStartedFiles,\n      pausedFiles,\n      completeFiles,\n      erroredFiles,\n      inProgressFiles,\n      inProgressNotPausedFiles,\n      processingFiles,\n\n      isUploadStarted: uploadStartedFiles.length > 0,\n      isAllComplete:\n        totalProgress === 100 &&\n        completeFiles.length === files.length &&\n        processingFiles.length === 0,\n      isAllErrored: !!error && erroredFiles.length === files.length,\n      isAllPaused:\n        inProgressFiles.length !== 0 &&\n        pausedFiles.length === inProgressFiles.length,\n      isUploadInProgress: inProgressFiles.length > 0,\n      isSomeGhost: files.some((file) => file.isGhost),\n    }\n  }\n\n  #informAndEmit(\n    errors: {\n      name: string\n      message: string\n      isUserFacing?: boolean\n      details?: string\n      isRestriction?: boolean\n      file?: UppyFile<M, B>\n    }[],\n  ): void {\n    for (const error of errors) {\n      if (error.isRestriction) {\n        this.emit(\n          'restriction-failed',\n          error.file,\n          error as RestrictionError<M, B>,\n        )\n      } else {\n        this.emit('error', error, error.file)\n      }\n      this.log(error, 'warning')\n    }\n\n    const userFacingErrors = errors.filter((error) => error.isUserFacing)\n\n    // don't flood the user: only show the first 4 toasts\n    const maxNumToShow = 4\n    const firstErrors = userFacingErrors.slice(0, maxNumToShow)\n    const additionalErrors = userFacingErrors.slice(maxNumToShow)\n    firstErrors.forEach(({ message, details = '' }) => {\n      this.info({ message, details }, 'error', this.opts.infoTimeout)\n    })\n\n    if (additionalErrors.length > 0) {\n      this.info({\n        message: this.i18n('additionalRestrictionsFailed', {\n          count: additionalErrors.length,\n        }),\n      })\n    }\n  }\n\n  validateSingleFile(file: ValidateableFile<M, B>): string | null {\n    try {\n      this.#restricter.validateSingleFile(file)\n    } catch (err) {\n      return err.message\n    }\n    return null\n  }\n\n  validateAggregateRestrictions(\n    files: ValidateableFile<M, B>[],\n  ): string | null {\n    const existingFiles = this.getFiles()\n    try {\n      this.#restricter.validateAggregateRestrictions(existingFiles, files)\n    } catch (err) {\n      return err.message\n    }\n    return null\n  }\n\n  #checkRequiredMetaFieldsOnFile(file: UppyFile<M, B>): boolean {\n    const { missingFields, error } =\n      this.#restricter.getMissingRequiredMetaFields(file)\n\n    if (missingFields.length > 0) {\n      this.setFileState(file.id, { missingRequiredMetaFields: missingFields })\n      this.log(error.message)\n      this.emit('restriction-failed', file, error)\n      return false\n    }\n    return true\n  }\n\n  #checkRequiredMetaFields(files: State<M, B>['files']): boolean {\n    let success = true\n    for (const file of Object.values(files)) {\n      if (!this.#checkRequiredMetaFieldsOnFile(file)) {\n        success = false\n      }\n    }\n    return success\n  }\n\n  #assertNewUploadAllowed(file?: UppyFile<M, B>): void {\n    const { allowNewUpload } = this.getState()\n\n    if (allowNewUpload === false) {\n      const error = new RestrictionError<M, B>(\n        this.i18n('noMoreFilesAllowed'),\n        {\n          file,\n        },\n      )\n      this.#informAndEmit([error])\n      throw error\n    }\n  }\n\n  checkIfFileAlreadyExists(fileID: string): boolean {\n    const { files } = this.getState()\n\n    if (files[fileID] && !files[fileID].isGhost) {\n      return true\n    }\n    return false\n  }\n\n  /**\n   * Create a file state object based on user-provided `addFile()` options.\n   */\n  #transformFile(fileDescriptorOrFile: File | UppyFile<M, B>): UppyFile<M, B> {\n    // Uppy expects files in { name, type, size, data } format.\n    // If the actual File object is passed from input[type=file] or drag-drop,\n    // we normalize it to match Uppy file object\n    const file = (\n      fileDescriptorOrFile instanceof File ?\n        {\n          name: fileDescriptorOrFile.name,\n          type: fileDescriptorOrFile.type,\n          size: fileDescriptorOrFile.size,\n          data: fileDescriptorOrFile,\n        }\n      : fileDescriptorOrFile) as UppyFile<M, B>\n\n    const fileType = getFileType(file)\n    const fileName = getFileName(fileType, file)\n    const filePlugins = getFilePlugins(file)\n    const fileExtension = getFileNameAndExtension(fileName).extension\n    const id = getSafeFileId(file, this.getID())\n\n    const meta = file.meta || {}\n    meta.name = fileName\n    meta.type = fileType\n\n    // `null` means the size is unknown.\n    const size =\n      Number.isFinite(file.data.size) ? file.data.size : (null as never)\n\n    return {\n      source: file.source || '',\n      id,\n      name: fileName,\n      plugins: filePlugins,\n      extension: fileExtension || '',\n      meta: {\n        ...this.getState().meta,\n        ...meta,\n      },\n      type: fileType,\n      data: file.data,\n      progress: {\n        percentage: 0,\n        bytesUploaded: false,\n        bytesTotal: size,\n        uploadComplete: false,\n        uploadStarted: null,\n      },\n      size,\n      isGhost: false,\n      isRemote: file.isRemote || false,\n      remote: file.remote,\n      preview: file.preview,\n    }\n  }\n\n  // Schedule an upload if `autoProceed` is enabled.\n  #startIfAutoProceed(): void {\n    if (this.opts.autoProceed && !this.scheduledAutoProceed) {\n      this.scheduledAutoProceed = setTimeout(() => {\n        this.scheduledAutoProceed = null\n        this.upload().catch((err) => {\n          if (!err.isRestriction) {\n            this.log(err.stack || err.message || err)\n          }\n        })\n      }, 4)\n    }\n  }\n\n  #checkAndUpdateFileState(filesToAdd: UppyFile<M, B>[]): {\n    nextFilesState: State<M, B>['files']\n    validFilesToAdd: UppyFile<M, B>[]\n    errors: RestrictionError<M, B>[]\n  } {\n    const { files: existingFiles } = this.getState()\n\n    // create a copy of the files object only once\n    const nextFilesState = { ...existingFiles }\n    const validFilesToAdd: UppyFile<M, B>[] = []\n    const errors: RestrictionError<M, B>[] = []\n\n    for (const fileToAdd of filesToAdd) {\n      try {\n        let newFile = this.#transformFile(fileToAdd)\n\n        // If a file has been recovered (Golden Retriever), but we were unable to recover its data (probably too large),\n        // users are asked to re-select these half-recovered files and then this method will be called again.\n        // In order to keep the progress, meta and everything else, we keep the existing file,\n        // but we replace `data`, and we remove `isGhost`, because the file is no longer a ghost now\n        const isGhost = existingFiles[newFile.id]?.isGhost\n        if (isGhost) {\n          const existingFileState = existingFiles[newFile.id]\n          newFile = {\n            ...existingFileState,\n            isGhost: false,\n            data: fileToAdd.data,\n          }\n          this.log(\n            `Replaced the blob in the restored ghost file: ${newFile.name}, ${newFile.id}`,\n          )\n        }\n\n        const onBeforeFileAddedResult = this.opts.onBeforeFileAdded(\n          newFile,\n          nextFilesState,\n        )\n\n        if (\n          !onBeforeFileAddedResult &&\n          this.checkIfFileAlreadyExists(newFile.id)\n        ) {\n          throw new RestrictionError(\n            this.i18n('noDuplicates', {\n              fileName: newFile.name ?? this.i18n('unnamed'),\n            }),\n            { file: fileToAdd },\n          )\n        }\n\n        // Pass through reselected files from Golden Retriever\n        if (onBeforeFileAddedResult === false && !isGhost) {\n          // Don’t show UI info for this error, as it should be done by the developer\n          throw new RestrictionError(\n            'Cannot add the file because onBeforeFileAdded returned false.',\n            { isUserFacing: false, file: fileToAdd },\n          )\n        } else if (\n          typeof onBeforeFileAddedResult === 'object' &&\n          onBeforeFileAddedResult !== null\n        ) {\n          newFile = onBeforeFileAddedResult\n        }\n\n        this.#restricter.validateSingleFile(newFile)\n\n        // need to add it to the new local state immediately, so we can use the state to validate the next files too\n        nextFilesState[newFile.id] = newFile\n        validFilesToAdd.push(newFile)\n      } catch (err) {\n        errors.push(err as any)\n      }\n    }\n\n    try {\n      // need to run this separately because it's much more slow, so if we run it inside the for-loop it will be very slow\n      // when many files are added\n      this.#restricter.validateAggregateRestrictions(\n        Object.values(existingFiles),\n        validFilesToAdd,\n      )\n    } catch (err) {\n      errors.push(err as any)\n\n      // If we have any aggregate error, don't allow adding this batch\n      return {\n        nextFilesState: existingFiles,\n        validFilesToAdd: [],\n        errors,\n      }\n    }\n\n    return {\n      nextFilesState,\n      validFilesToAdd,\n      errors,\n    }\n  }\n\n  /**\n   * Add a new file to `state.files`. This will run `onBeforeFileAdded`,\n   * try to guess file type in a clever way, check file against restrictions,\n   * and start an upload if `autoProceed === true`.\n   */\n  addFile(file: File | MinimalRequiredUppyFile<M, B>): UppyFile<M, B>['id'] {\n    this.#assertNewUploadAllowed(file as UppyFile<M, B>)\n\n    const { nextFilesState, validFilesToAdd, errors } =\n      this.#checkAndUpdateFileState([file as UppyFile<M, B>])\n\n    const restrictionErrors = errors.filter((error) => error.isRestriction)\n    this.#informAndEmit(restrictionErrors)\n\n    if (errors.length > 0) throw errors[0]\n\n    this.setState({ files: nextFilesState })\n\n    const [firstValidFileToAdd] = validFilesToAdd\n\n    this.emit('file-added', firstValidFileToAdd)\n    this.emit('files-added', validFilesToAdd)\n    this.log(\n      `Added file: ${firstValidFileToAdd.name}, ${firstValidFileToAdd.id}, mime type: ${firstValidFileToAdd.type}`,\n    )\n\n    this.#startIfAutoProceed()\n\n    return firstValidFileToAdd.id\n  }\n\n  /**\n   * Add multiple files to `state.files`. See the `addFile()` documentation.\n   *\n   * If an error occurs while adding a file, it is logged and the user is notified.\n   * This is good for UI plugins, but not for programmatic use.\n   * Programmatic users should usually still use `addFile()` on individual files.\n   */\n  addFiles(fileDescriptors: MinimalRequiredUppyFile<M, B>[]): void {\n    this.#assertNewUploadAllowed()\n\n    const { nextFilesState, validFilesToAdd, errors } =\n      this.#checkAndUpdateFileState(fileDescriptors as UppyFile<M, B>[])\n\n    const restrictionErrors = errors.filter((error) => error.isRestriction)\n    this.#informAndEmit(restrictionErrors)\n\n    const nonRestrictionErrors = errors.filter((error) => !error.isRestriction)\n\n    if (nonRestrictionErrors.length > 0) {\n      let message = 'Multiple errors occurred while adding files:\\n'\n      nonRestrictionErrors.forEach((subError) => {\n        message += `\\n * ${subError.message}`\n      })\n\n      this.info(\n        {\n          message: this.i18n('addBulkFilesFailed', {\n            smart_count: nonRestrictionErrors.length,\n          }),\n          details: message,\n        },\n        'error',\n        this.opts.infoTimeout,\n      )\n\n      if (typeof AggregateError === 'function') {\n        throw new AggregateError(nonRestrictionErrors, message)\n      } else {\n        const err = new Error(message)\n        // @ts-expect-error fallback when AggregateError is not available\n        err.errors = nonRestrictionErrors\n        throw err\n      }\n    }\n\n    // OK, we haven't thrown an error, we can start updating state and emitting events now:\n\n    this.setState({ files: nextFilesState })\n\n    validFilesToAdd.forEach((file) => {\n      this.emit('file-added', file)\n    })\n\n    this.emit('files-added', validFilesToAdd)\n\n    if (validFilesToAdd.length > 5) {\n      this.log(`Added batch of ${validFilesToAdd.length} files`)\n    } else {\n      Object.values(validFilesToAdd).forEach((file) => {\n        this.log(\n          `Added file: ${file.name}\\n id: ${file.id}\\n type: ${file.type}`,\n        )\n      })\n    }\n\n    if (validFilesToAdd.length > 0) {\n      this.#startIfAutoProceed()\n    }\n  }\n\n  removeFiles(fileIDs: string[]): void {\n    const { files, currentUploads } = this.getState()\n    const updatedFiles = { ...files }\n    const updatedUploads = { ...currentUploads }\n\n    const removedFiles = Object.create(null)\n    fileIDs.forEach((fileID) => {\n      if (files[fileID]) {\n        removedFiles[fileID] = files[fileID]\n        delete updatedFiles[fileID]\n      }\n    })\n\n    // Remove files from the `fileIDs` list in each upload.\n    function fileIsNotRemoved(uploadFileID: string): boolean {\n      return removedFiles[uploadFileID] === undefined\n    }\n\n    Object.keys(updatedUploads).forEach((uploadID) => {\n      const newFileIDs =\n        currentUploads[uploadID].fileIDs.filter(fileIsNotRemoved)\n\n      // Remove the upload if no files are associated with it anymore.\n      if (newFileIDs.length === 0) {\n        delete updatedUploads[uploadID]\n        return\n      }\n\n      const { capabilities } = this.getState()\n      if (\n        newFileIDs.length !== currentUploads[uploadID].fileIDs.length &&\n        !capabilities.individualCancellation\n      ) {\n        throw new Error(\n          'The installed uploader plugin does not allow removing files during an upload.',\n        )\n      }\n\n      updatedUploads[uploadID] = {\n        ...currentUploads[uploadID],\n        fileIDs: newFileIDs,\n      }\n    })\n\n    const stateUpdate: Partial<State<M, B>> = {\n      currentUploads: updatedUploads,\n      files: updatedFiles,\n    }\n\n    // If all files were removed - allow new uploads,\n    // and clear recoveredState\n    if (Object.keys(updatedFiles).length === 0) {\n      stateUpdate.allowNewUpload = true\n      stateUpdate.error = null\n      stateUpdate.recoveredState = null\n    }\n\n    this.setState(stateUpdate)\n    this.calculateTotalProgress()\n\n    const removedFileIDs = Object.keys(removedFiles)\n    removedFileIDs.forEach((fileID) => {\n      this.emit('file-removed', removedFiles[fileID])\n    })\n\n    if (removedFileIDs.length > 5) {\n      this.log(`Removed ${removedFileIDs.length} files`)\n    } else {\n      this.log(`Removed files: ${removedFileIDs.join(', ')}`)\n    }\n  }\n\n  removeFile(fileID: string): void {\n    this.removeFiles([fileID])\n  }\n\n  pauseResume(fileID: string): boolean | undefined {\n    if (\n      !this.getState().capabilities.resumableUploads ||\n      this.getFile(fileID).progress.uploadComplete\n    ) {\n      return undefined\n    }\n\n    const file = this.getFile(fileID)\n    const wasPaused = file.isPaused || false\n    const isPaused = !wasPaused\n\n    this.setFileState(fileID, {\n      isPaused,\n    })\n\n    this.emit('upload-pause', file, isPaused)\n\n    return isPaused\n  }\n\n  pauseAll(): void {\n    const updatedFiles = { ...this.getState().files }\n    const inProgressUpdatedFiles = Object.keys(updatedFiles).filter((file) => {\n      return (\n        !updatedFiles[file].progress.uploadComplete &&\n        updatedFiles[file].progress.uploadStarted\n      )\n    })\n\n    inProgressUpdatedFiles.forEach((file) => {\n      const updatedFile = { ...updatedFiles[file], isPaused: true }\n      updatedFiles[file] = updatedFile\n    })\n\n    this.setState({ files: updatedFiles })\n    this.emit('pause-all')\n  }\n\n  resumeAll(): void {\n    const updatedFiles = { ...this.getState().files }\n    const inProgressUpdatedFiles = Object.keys(updatedFiles).filter((file) => {\n      return (\n        !updatedFiles[file].progress.uploadComplete &&\n        updatedFiles[file].progress.uploadStarted\n      )\n    })\n\n    inProgressUpdatedFiles.forEach((file) => {\n      const updatedFile = {\n        ...updatedFiles[file],\n        isPaused: false,\n        error: null,\n      }\n      updatedFiles[file] = updatedFile\n    })\n    this.setState({ files: updatedFiles })\n\n    this.emit('resume-all')\n  }\n\n  retryAll(): Promise<UploadResult<M, B> | undefined> {\n    const updatedFiles = { ...this.getState().files }\n    const filesToRetry = Object.keys(updatedFiles).filter((file) => {\n      return updatedFiles[file].error\n    })\n\n    filesToRetry.forEach((file) => {\n      const updatedFile = {\n        ...updatedFiles[file],\n        isPaused: false,\n        error: null,\n      }\n      updatedFiles[file] = updatedFile\n    })\n    this.setState({\n      files: updatedFiles,\n      error: null,\n    })\n\n    this.emit('retry-all', Object.values(updatedFiles))\n\n    if (filesToRetry.length === 0) {\n      return Promise.resolve({\n        successful: [],\n        failed: [],\n      })\n    }\n\n    const uploadID = this.#createUpload(filesToRetry, {\n      forceAllowNewUpload: true, // create new upload even if allowNewUpload: false\n    })\n    return this.#runUpload(uploadID)\n  }\n\n  cancelAll(): void {\n    this.emit('cancel-all')\n\n    const { files } = this.getState()\n\n    const fileIDs = Object.keys(files)\n    if (fileIDs.length) {\n      this.removeFiles(fileIDs)\n    }\n\n    this.setState(defaultUploadState)\n  }\n\n  retryUpload(fileID: string): Promise<UploadResult<M, B> | undefined> {\n    this.setFileState(fileID, {\n      error: null,\n      isPaused: false,\n    })\n\n    this.emit('upload-retry', this.getFile(fileID))\n\n    const uploadID = this.#createUpload([fileID], {\n      forceAllowNewUpload: true, // create new upload even if allowNewUpload: false\n    })\n    return this.#runUpload(uploadID)\n  }\n\n  logout(): void {\n    this.iteratePlugins((plugin) => {\n      ;(plugin as UnknownProviderPlugin<M, B>).provider?.logout?.()\n    })\n  }\n\n  // ___Why throttle at 500ms?\n  //    - We must throttle at >250ms for superfocus in Dashboard to work well\n  //    (because animation takes 0.25s, and we want to wait for all animations to be over before refocusing).\n  //    [Practical Check]: if thottle is at 100ms, then if you are uploading a file,\n  //    and click 'ADD MORE FILES', - focus won't activate in Firefox.\n  //    - We must throttle at around >500ms to avoid performance lags.\n  //    [Practical Check] Firefox, try to upload a big file for a prolonged period of time. Laptop will start to heat up.\n  // todo when uploading multiple files, this will cause problems because they share the same throttle,\n  // meaning some files might never get their progress reported (eaten up by progress events from other files)\n  calculateProgress = throttle(\n    (file, data) => {\n      const fileInState = this.getFile(file?.id)\n      if (file == null || !fileInState) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n\n      if (fileInState.progress.percentage === 100) {\n        this.log(\n          `Not setting progress for a file that has been already uploaded: ${file.id}`,\n        )\n        return\n      }\n\n      // bytesTotal may be null or zero; in that case we can't divide by it\n      const canHavePercentage =\n        Number.isFinite(data.bytesTotal) && data.bytesTotal > 0\n      this.setFileState(file.id, {\n        progress: {\n          ...fileInState.progress,\n          bytesUploaded: data.bytesUploaded,\n          bytesTotal: data.bytesTotal,\n          percentage:\n            canHavePercentage ?\n              Math.round((data.bytesUploaded / data.bytesTotal) * 100)\n            : 0,\n        },\n      })\n\n      this.calculateTotalProgress()\n    },\n    500,\n    { leading: true, trailing: true },\n  )\n\n  calculateTotalProgress(): void {\n    // calculate total progress, using the number of files currently uploading,\n    // multiplied by 100 and the summ of individual progress of each file\n    const files = this.getFiles()\n\n    const inProgress = files.filter((file) => {\n      return (\n        file.progress.uploadStarted ||\n        file.progress.preprocess ||\n        file.progress.postprocess\n      )\n    })\n\n    if (inProgress.length === 0) {\n      this.emit('progress', 0)\n      this.setState({ totalProgress: 0 })\n      return\n    }\n\n    const sizedFiles = inProgress.filter(\n      (file) => file.progress.bytesTotal != null,\n    )\n    const unsizedFiles = inProgress.filter(\n      (file) => file.progress.bytesTotal == null,\n    )\n\n    if (sizedFiles.length === 0) {\n      const progressMax = inProgress.length * 100\n      const currentProgress = unsizedFiles.reduce((acc, file) => {\n        return acc + (file.progress.percentage as number)\n      }, 0)\n      const totalProgress = Math.round((currentProgress / progressMax) * 100)\n      this.setState({ totalProgress })\n      return\n    }\n\n    let totalSize = sizedFiles.reduce((acc, file) => {\n      return (acc + (file.progress.bytesTotal ?? 0)) as number\n    }, 0)\n    const averageSize = totalSize / sizedFiles.length\n    totalSize += averageSize * unsizedFiles.length\n\n    let uploadedSize = 0\n    sizedFiles.forEach((file) => {\n      uploadedSize += file.progress.bytesUploaded as number\n    })\n    unsizedFiles.forEach((file) => {\n      uploadedSize += (averageSize * (file.progress.percentage || 0)) / 100\n    })\n\n    let totalProgress =\n      totalSize === 0 ? 0 : Math.round((uploadedSize / totalSize) * 100)\n\n    // hot fix, because:\n    // uploadedSize ended up larger than totalSize, resulting in 1325% total\n    if (totalProgress > 100) {\n      totalProgress = 100\n    }\n\n    this.setState({ totalProgress })\n    this.emit('progress', totalProgress)\n  }\n\n  /**\n   * Registers listeners for all global actions, like:\n   * `error`, `file-removed`, `upload-progress`\n   */\n  #addListeners(): void {\n    // Type inference only works for inline functions so we have to type it again\n    const errorHandler: UppyEventMap<M, B>['error'] = (\n      error,\n      file,\n      response,\n    ) => {\n      let errorMsg = error.message || 'Unknown error'\n      if (error.details) {\n        errorMsg += `: ${error.details}`\n      }\n\n      this.setState({ error: errorMsg })\n\n      if (file != null && file.id in this.getState().files) {\n        this.setFileState(file.id, {\n          error: errorMsg,\n          response,\n        })\n      }\n    }\n\n    this.on('error', errorHandler)\n\n    this.on('upload-error', (file, error, response) => {\n      if (typeof error === 'object' && error.message) {\n        this.log(error.message, 'error')\n        const newError = new Error(\n          this.i18n('failedToUpload', { file: file?.name ?? '' }),\n        ) as any // we may want a new custom error here\n        newError.isUserFacing = true // todo maybe don't do this with all errors?\n        newError.details = error.message\n        if (error.details) {\n          newError.details += ` ${error.details}`\n        }\n\n        // @ts-expect-error\n        newError.request = error.request\n\n        this.emit('modify-upload-error', file, newError, response)\n        this.#informAndEmit([newError])\n        errorHandler(newError, file, response)\n      } else {\n        this.emit('modify-upload-error', file, error as any, response)\n        this.#informAndEmit([error])\n        errorHandler(error, file, response)\n      }\n    })\n\n    let uploadStalledWarningRecentlyEmitted: ReturnType<\n      typeof setTimeout\n    > | null = null\n    this.on('upload-stalled', (error, files) => {\n      const { message } = error\n      const details = files.map((file) => file.meta.name).join(', ')\n      if (!uploadStalledWarningRecentlyEmitted) {\n        this.info({ message, details }, 'warning', this.opts.infoTimeout)\n        uploadStalledWarningRecentlyEmitted = setTimeout(() => {\n          uploadStalledWarningRecentlyEmitted = null\n        }, this.opts.infoTimeout)\n      }\n      this.log(`${message} ${details}`.trim(), 'warning')\n    })\n\n    this.on('upload', () => {\n      this.setState({ error: null })\n    })\n\n    const onUploadStarted = (files: UppyFile<M, B>[]): void => {\n      const filesFiltered = files.filter((file) => {\n        const exists = file != null && this.getFile(file.id)\n        if (!exists)\n          this.log(\n            `Not setting progress for a file that has been removed: ${file?.id}`,\n          )\n        return exists\n      })\n\n      const filesState = Object.fromEntries(\n        filesFiltered.map((file) => [\n          file.id,\n          {\n            progress: {\n              uploadStarted: Date.now(),\n              uploadComplete: false,\n              percentage: 0,\n              bytesUploaded: 0,\n              bytesTotal: file.size,\n            } as FileProgressStarted,\n          },\n        ]),\n      )\n\n      this.patchFilesState(filesState)\n    }\n\n    this.on('upload-start', onUploadStarted)\n\n    this.on('upload-progress', this.calculateProgress)\n\n    this.on('upload-success', (file, uploadResp) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n\n      const currentProgress = this.getFile(file.id).progress\n      this.setFileState(file.id, {\n        progress: {\n          ...currentProgress,\n          postprocess:\n            this.#postProcessors.size > 0 ?\n              {\n                mode: 'indeterminate',\n              }\n            : undefined,\n          uploadComplete: true,\n          percentage: 100,\n          bytesUploaded: currentProgress.bytesTotal,\n        } as FileProgressStarted,\n        response: uploadResp,\n        uploadURL: uploadResp.uploadURL,\n        isPaused: false,\n      })\n\n      // Remote providers sometimes don't tell us the file size,\n      // but we can know how many bytes we uploaded once the upload is complete.\n      if (file.size == null) {\n        this.setFileState(file.id, {\n          size: uploadResp.bytesUploaded || currentProgress.bytesTotal,\n        })\n      }\n\n      this.calculateTotalProgress()\n    })\n\n    this.on('preprocess-progress', (file, progress) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      this.setFileState(file.id, {\n        progress: { ...this.getFile(file.id).progress, preprocess: progress },\n      })\n    })\n\n    this.on('preprocess-complete', (file) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      const files = { ...this.getState().files }\n      files[file.id] = {\n        ...files[file.id],\n        progress: { ...files[file.id].progress },\n      }\n      delete files[file.id].progress.preprocess\n\n      this.setState({ files })\n    })\n\n    this.on('postprocess-progress', (file, progress) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      this.setFileState(file.id, {\n        progress: {\n          ...this.getState().files[file.id].progress,\n          postprocess: progress,\n        },\n      })\n    })\n\n    this.on('postprocess-complete', (file) => {\n      if (file == null || !this.getFile(file.id)) {\n        this.log(\n          `Not setting progress for a file that has been removed: ${file?.id}`,\n        )\n        return\n      }\n      const files = {\n        ...this.getState().files,\n      }\n      files[file.id] = {\n        ...files[file.id],\n        progress: {\n          ...files[file.id].progress,\n        },\n      }\n      delete files[file.id].progress.postprocess\n\n      this.setState({ files })\n    })\n\n    this.on('restored', () => {\n      // Files may have changed--ensure progress is still accurate.\n      this.calculateTotalProgress()\n    })\n\n    // @ts-expect-error should fix itself when dashboard it typed (also this doesn't belong here)\n    this.on('dashboard:file-edit-complete', (file) => {\n      if (file) {\n        this.#checkRequiredMetaFieldsOnFile(file)\n      }\n    })\n\n    // show informer if offline\n    if (typeof window !== 'undefined' && window.addEventListener) {\n      window.addEventListener('online', this.#updateOnlineStatus)\n      window.addEventListener('offline', this.#updateOnlineStatus)\n      setTimeout(this.#updateOnlineStatus, 3000)\n    }\n  }\n\n  updateOnlineStatus(): void {\n    const online = window.navigator.onLine ?? true\n    if (!online) {\n      this.emit('is-offline')\n      this.info(this.i18n('noInternetConnection'), 'error', 0)\n      this.wasOffline = true\n    } else {\n      this.emit('is-online')\n      if (this.wasOffline) {\n        this.emit('back-online')\n        this.info(this.i18n('connectedToInternet'), 'success', 3000)\n        this.wasOffline = false\n      }\n    }\n  }\n\n  #updateOnlineStatus = this.updateOnlineStatus.bind(this)\n\n  getID(): string {\n    return this.opts.id\n  }\n\n  /**\n   * Registers a plugin with Core.\n   */\n  use<T extends typeof BasePlugin<any, M, B>>(\n    Plugin: T,\n    // We want to let the plugin decide whether `opts` is optional or not\n    // so we spread the argument rather than defining `opts:` ourselves.\n    ...args: OmitFirstArg<ConstructorParameters<T>>\n  ): this {\n    if (typeof Plugin !== 'function') {\n      const msg =\n        `Expected a plugin class, but got ${\n          Plugin === null ? 'null' : typeof Plugin\n        }.` +\n        ' Please verify that the plugin was imported and spelled correctly.'\n      throw new TypeError(msg)\n    }\n\n    // Instantiate\n    const plugin = new Plugin(this, ...args)\n    const pluginId = plugin.id\n\n    if (!pluginId) {\n      throw new Error('Your plugin must have an id')\n    }\n\n    if (!plugin.type) {\n      throw new Error('Your plugin must have a type')\n    }\n\n    const existsPluginAlready = this.getPlugin(pluginId)\n    if (existsPluginAlready) {\n      const msg =\n        `Already found a plugin named '${existsPluginAlready.id}'. ` +\n        `Tried to use: '${pluginId}'.\\n` +\n        'Uppy plugins must have unique `id` options. See https://uppy.io/docs/plugins/#id.'\n      throw new Error(msg)\n    }\n\n    // @ts-expect-error does exist\n    if (Plugin.VERSION) {\n      // @ts-expect-error does exist\n      this.log(`Using ${pluginId} v${Plugin.VERSION}`)\n    }\n\n    if (plugin.type in this.#plugins) {\n      this.#plugins[plugin.type].push(plugin)\n    } else {\n      this.#plugins[plugin.type] = [plugin]\n    }\n\n    this.#installingPlugin = pluginId\n\n    plugin.install()\n\n    this.#installingPlugin = undefined\n\n    this.emit('plugin-added', plugin)\n\n    return this\n  }\n\n  /**\n   * Find one Plugin by name.\n   */\n  getPlugin<T extends UnknownPlugin<M, B> = UnknownPlugin<M, B>>(\n    id: string,\n  ): T | undefined {\n    for (const plugins of Object.values(this.#plugins)) {\n      const foundPlugin = plugins.find((plugin) => plugin.id === id)\n      if (foundPlugin != null) return foundPlugin as T\n    }\n    return undefined\n  }\n\n  private [Symbol.for('uppy test: getPlugins')](\n    type: string,\n  ): UnknownPlugin<M, B>[] {\n    return this.#plugins[type]\n  }\n\n  /**\n   * Iterate through all `use`d plugins.\n   *\n   */\n  iteratePlugins(method: (plugin: UnknownPlugin<M, B>) => void): void {\n    Object.values(this.#plugins).flat(1).forEach(method)\n  }\n\n  /**\n   * Uninstall and remove a plugin.\n   *\n   * @param {object} instance The plugin instance to remove.\n   */\n  removePlugin(instance: UnknownPlugin<M, B>): void {\n    this.log(`Removing plugin ${instance.id}`)\n    this.emit('plugin-remove', instance)\n\n    if (instance.uninstall) {\n      instance.uninstall()\n    }\n\n    const list = this.#plugins[instance.type]\n    // list.indexOf failed here, because Vue3 converted the plugin instance\n    // to a Proxy object, which failed the strict comparison test:\n    // obj !== objProxy\n    const index = list.findIndex((item) => item.id === instance.id)\n    if (index !== -1) {\n      list.splice(index, 1)\n    }\n\n    const state = this.getState()\n    const updatedState = {\n      plugins: {\n        ...state.plugins,\n        [instance.id]: undefined,\n      },\n    }\n    this.setState(updatedState)\n  }\n\n  /**\n   * Uninstall all plugins and close down this Uppy instance.\n   */\n  destroy(): void {\n    this.log(\n      `Closing Uppy instance ${this.opts.id}: removing all files and uninstalling plugins`,\n    )\n\n    this.cancelAll()\n\n    this.#storeUnsubscribe()\n\n    this.iteratePlugins((plugin) => {\n      this.removePlugin(plugin)\n    })\n\n    if (typeof window !== 'undefined' && window.removeEventListener) {\n      window.removeEventListener('online', this.#updateOnlineStatus)\n      window.removeEventListener('offline', this.#updateOnlineStatus)\n    }\n  }\n\n  hideInfo(): void {\n    const { info } = this.getState()\n\n    this.setState({ info: info.slice(1) })\n\n    this.emit('info-hidden')\n  }\n\n  /**\n   * Set info message in `state.info`, so that UI plugins like `Informer`\n   * can display the message.\n   */\n  info(\n    message:\n      | string\n      | { message: string; details?: string | Record<string, string> },\n    type: LogLevel = 'info',\n    duration = 3000,\n  ): void {\n    const isComplexMessage = typeof message === 'object'\n\n    this.setState({\n      info: [\n        ...this.getState().info,\n        {\n          type,\n          message: isComplexMessage ? message.message : message,\n          details: isComplexMessage ? message.details : null,\n        },\n      ],\n    })\n\n    setTimeout(() => this.hideInfo(), duration)\n\n    this.emit('info-visible')\n  }\n\n  /**\n   * Passes messages to a function, provided in `opts.logger`.\n   * If `opts.logger: Uppy.debugLogger` or `opts.debug: true`, logs to the browser console.\n   */\n  log(message: string | Record<any, any> | Error, type?: string): void {\n    const { logger } = this.opts\n    switch (type) {\n      case 'error':\n        logger.error(message)\n        break\n      case 'warning':\n        logger.warn(message)\n        break\n      default:\n        logger.debug(message)\n        break\n    }\n  }\n\n  // We need to store request clients by a unique ID, so we can share RequestClient instances across files\n  // this allows us to do rate limiting and synchronous operations like refreshing provider tokens\n  // example: refreshing tokens: if each file has their own requestclient,\n  // we don't have any way to synchronize all requests in order to\n  // - block all requests\n  // - refresh the token\n  // - unblock all requests and allow them to run with a the new access token\n  // back when we had a requestclient per file, once an access token expired,\n  // all 6 files would go ahead and refresh the token at the same time\n  // (calling /refresh-token up to 6 times), which will probably fail for some providers\n  #requestClientById = new Map<string, unknown>()\n\n  registerRequestClient(id: string, client: unknown): void {\n    this.#requestClientById.set(id, client)\n  }\n\n  /** @protected */\n  getRequestClientForFile<Client>(file: UppyFile<M, B>): Client {\n    if (!file.remote)\n      throw new Error(\n        `Tried to get RequestClient for a non-remote file ${file.id}`,\n      )\n    const requestClient = this.#requestClientById.get(\n      file.remote.requestClientId,\n    )\n    if (requestClient == null)\n      throw new Error(\n        `requestClientId \"${file.remote.requestClientId}\" not registered for file \"${file.id}\"`,\n      )\n    return requestClient as Client\n  }\n\n  /**\n   * Restore an upload by its ID.\n   */\n  restore(uploadID: string): Promise<UploadResult<M, B> | undefined> {\n    this.log(`Core: attempting to restore upload \"${uploadID}\"`)\n\n    if (!this.getState().currentUploads[uploadID]) {\n      this.#removeUpload(uploadID)\n      return Promise.reject(new Error('Nonexistent upload'))\n    }\n\n    return this.#runUpload(uploadID)\n  }\n\n  /**\n   * Create an upload for a bunch of files.\n   *\n   */\n  #createUpload(\n    fileIDs: string[],\n    opts: { forceAllowNewUpload?: boolean } = {},\n  ): string {\n    // uppy.retryAll sets this to true — when retrying we want to ignore `allowNewUpload: false`\n    const { forceAllowNewUpload = false } = opts\n\n    const { allowNewUpload, currentUploads } = this.getState()\n    if (!allowNewUpload && !forceAllowNewUpload) {\n      throw new Error('Cannot create a new upload: already uploading.')\n    }\n\n    const uploadID = nanoid()\n\n    this.emit('upload', uploadID, this.getFilesByIds(fileIDs))\n\n    this.setState({\n      allowNewUpload:\n        this.opts.allowMultipleUploadBatches !== false &&\n        this.opts.allowMultipleUploads !== false,\n\n      currentUploads: {\n        ...currentUploads,\n        [uploadID]: {\n          fileIDs,\n          step: 0,\n          result: {},\n        },\n      },\n    })\n\n    return uploadID\n  }\n\n  private [Symbol.for('uppy test: createUpload')](...args: any[]): string {\n    // @ts-expect-error https://github.com/microsoft/TypeScript/issues/47595\n    return this.#createUpload(...args)\n  }\n\n  #getUpload(uploadID: string): CurrentUpload<M, B> {\n    const { currentUploads } = this.getState()\n\n    return currentUploads[uploadID]\n  }\n\n  /**\n   * Add data to an upload's result object.\n   */\n  addResultData(uploadID: string, data: CurrentUpload<M, B>['result']): void {\n    if (!this.#getUpload(uploadID)) {\n      this.log(\n        `Not setting result for an upload that has been removed: ${uploadID}`,\n      )\n      return\n    }\n    const { currentUploads } = this.getState()\n    const currentUpload = {\n      ...currentUploads[uploadID],\n      result: { ...currentUploads[uploadID].result, ...data },\n    }\n    this.setState({\n      currentUploads: { ...currentUploads, [uploadID]: currentUpload },\n    })\n  }\n\n  /**\n   * Remove an upload, eg. if it has been canceled or completed.\n   *\n   */\n  #removeUpload(uploadID: string): void {\n    const currentUploads = { ...this.getState().currentUploads }\n    delete currentUploads[uploadID]\n\n    this.setState({\n      currentUploads,\n    })\n  }\n\n  /**\n   * Run an upload. This picks up where it left off in case the upload is being restored.\n   */\n  async #runUpload(uploadID: string): Promise<UploadResult<M, B> | undefined> {\n    const getCurrentUpload = (): CurrentUpload<M, B> => {\n      const { currentUploads } = this.getState()\n      return currentUploads[uploadID]\n    }\n\n    let currentUpload = getCurrentUpload()\n\n    const steps = [\n      ...this.#preProcessors,\n      ...this.#uploaders.keys(),\n      ...this.#postProcessors,\n    ]\n    try {\n      for (let step = currentUpload.step || 0; step < steps.length; step++) {\n        if (!currentUpload) {\n          break\n        }\n        const fn = steps[step]\n\n        this.setState({\n          currentUploads: {\n            ...this.getState().currentUploads,\n            [uploadID]: {\n              ...currentUpload,\n              step,\n            },\n          },\n        })\n\n        const { fileIDs } = currentUpload\n        let uploaderFileIds = fileIDs\n        const uploaderPlugin = this.#uploaders.get(fn)\n        if (uploaderPlugin) {\n          const files = this.getFilesByIds(uploaderFileIds)\n          uploaderFileIds = files\n            .filter(\n              (file) =>\n                file.plugins?.includes(uploaderPlugin) ||\n                file.plugins?.length === 0,\n            )\n            .map((file) => file.id)\n        }\n        // TODO give this the `updatedUpload` object as its only parameter maybe?\n        // Otherwise when more metadata may be added to the upload this would keep getting more parameters\n        await fn(uploaderFileIds, uploadID)\n\n        currentUpload = getCurrentUpload()\n      }\n    } catch (err) {\n      this.#removeUpload(uploadID)\n      throw err\n    }\n\n    // Set result data.\n    if (currentUpload) {\n      // Mark postprocessing step as complete if necessary; this addresses a case where we might get\n      // stuck in the postprocessing UI while the upload is fully complete.\n      // If the postprocessing steps do not do any work, they may not emit postprocessing events at\n      // all, and never mark the postprocessing as complete. This is fine on its own but we\n      // introduced code in the @uppy/core upload-success handler to prepare postprocessing progress\n      // state if any postprocessors are registered. That is to avoid a \"flash of completed state\"\n      // before the postprocessing plugins can emit events.\n      //\n      // So, just in case an upload with postprocessing plugins *has* completed *without* emitting\n      // postprocessing completion, we do it instead.\n      currentUpload.fileIDs.forEach((fileID) => {\n        const file = this.getFile(fileID)\n        if (file && file.progress.postprocess) {\n          this.emit('postprocess-complete', file)\n        }\n      })\n\n      const files = currentUpload.fileIDs.map((fileID) => this.getFile(fileID))\n      const successful = files.filter((file) => !file.error)\n      const failed = files.filter((file) => file.error)\n      this.addResultData(uploadID, { successful, failed, uploadID })\n\n      // Update currentUpload value in case it was modified asynchronously.\n      currentUpload = getCurrentUpload()\n    }\n    // Emit completion events.\n    // This is in a separate function so that the `currentUploads` variable\n    // always refers to the latest state. In the handler right above it refers\n    // to an outdated object without the `.result` property.\n    let result\n    if (currentUpload) {\n      result = currentUpload.result\n      this.emit('complete', result)\n\n      this.#removeUpload(uploadID)\n    }\n    if (result == null) {\n      this.log(\n        `Not setting result for an upload that has been removed: ${uploadID}`,\n      )\n    }\n    return result\n  }\n\n  /**\n   * Start an upload for all the files that are not currently being uploaded.\n   */\n  upload(): Promise<NonNullable<UploadResult<M, B>> | undefined> {\n    if (!this.#plugins['uploader']?.length) {\n      this.log('No uploader type plugins are used', 'warning')\n    }\n\n    let { files } = this.getState()\n\n    const onBeforeUploadResult = this.opts.onBeforeUpload(files)\n\n    if (onBeforeUploadResult === false) {\n      return Promise.reject(\n        new Error(\n          'Not starting the upload because onBeforeUpload returned false',\n        ),\n      )\n    }\n\n    if (onBeforeUploadResult && typeof onBeforeUploadResult === 'object') {\n      files = onBeforeUploadResult\n      // Updating files in state, because uploader plugins receive file IDs,\n      // and then fetch the actual file object from state\n      this.setState({\n        files,\n      })\n    }\n\n    return Promise.resolve()\n      .then(() => this.#restricter.validateMinNumberOfFiles(files))\n      .catch((err) => {\n        this.#informAndEmit([err])\n        throw err\n      })\n      .then(() => {\n        if (!this.#checkRequiredMetaFields(files)) {\n          throw new RestrictionError(this.i18n('missingRequiredMetaField'))\n        }\n      })\n      .catch((err) => {\n        // Doing this in a separate catch because we already emited and logged\n        // all the errors in `checkRequiredMetaFields` so we only throw a generic\n        // missing fields error here.\n        throw err\n      })\n      .then(() => {\n        const { currentUploads } = this.getState()\n        // get a list of files that are currently assigned to uploads\n        const currentlyUploadingFiles = Object.values(currentUploads).flatMap(\n          (curr) => curr.fileIDs,\n        )\n\n        const waitingFileIDs: string[] = []\n        Object.keys(files).forEach((fileID) => {\n          const file = this.getFile(fileID)\n          // if the file hasn't started uploading and hasn't already been assigned to an upload..\n          if (\n            !file.progress.uploadStarted &&\n            currentlyUploadingFiles.indexOf(fileID) === -1\n          ) {\n            waitingFileIDs.push(file.id)\n          }\n        })\n\n        const uploadID = this.#createUpload(waitingFileIDs)\n        return this.#runUpload(uploadID)\n      })\n      .catch((err) => {\n        this.emit('error', err)\n        this.log(err, 'error')\n        throw err\n      })\n  }\n}\n\nexport default Uppy\n"],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/getFilePlugins.d.ts b/lib/getFilePlugins.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..a1dc38ed1aabe80a4bfe6b72f89eab27bd0d0390
--- /dev/null
+++ b/lib/getFilePlugins.d.ts
@@ -0,0 +1,4 @@
+export default function getFilePlugins(fileDescriptor: {
+    plugins?: string[];
+}): string[];
+//# sourceMappingURL=getFilePlugins.d.ts.map
\ No newline at end of file
diff --git a/lib/getFilePlugins.d.ts.map b/lib/getFilePlugins.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..cfc88d68816a59bac7805f3fe13cc4afc417c93a
--- /dev/null
+++ b/lib/getFilePlugins.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"getFilePlugins.d.ts","sourceRoot":"","sources":["../src/getFilePlugins.ts"],"names":[],"mappings":"AAAA,MAAM,CAAC,OAAO,UAAU,cAAc,CAAC,cAAc,EAAE;IACrD,OAAO,CAAC,EAAE,MAAM,EAAE,CAAA;CACnB,GAAG,MAAM,EAAE,CAEX"}
\ No newline at end of file
diff --git a/lib/getFilePlugins.js b/lib/getFilePlugins.js
new file mode 100644
index 0000000000000000000000000000000000000000..f5adfd2cc79037e74601d01722402e35044f5e42
--- /dev/null
+++ b/lib/getFilePlugins.js
@@ -0,0 +1,3 @@
+export default function getFilePlugins(fileDescriptor) {
+  return fileDescriptor.plugins || [];
+}
\ No newline at end of file
diff --git a/lib/getFilePlugins.js.map b/lib/getFilePlugins.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..ad7ddb584ea70430d75eb17a36405c1e397c0a75
--- /dev/null
+++ b/lib/getFilePlugins.js.map
@@ -0,0 +1 @@
+{"version":3,"names":["getFilePlugins","fileDescriptor","plugins"],"sources":["getFilePlugins.ts"],"sourcesContent":["export default function getFilePlugins(fileDescriptor: {\n  plugins?: string[]\n}): string[] {\n  return fileDescriptor.plugins || []\n}\n"],"mappings":"AAAA,eAAe,SAASA,cAAcA,CAACC,cAEtC,EAAY;EACX,OAAOA,cAAc,CAACC,OAAO,IAAI,EAAE;AACrC","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/mocks/acquirerPlugin1.d.ts b/lib/mocks/acquirerPlugin1.d.ts
index b7a7f1446f24949a7738c792743d00607ccb7c50..570274333139c3c469f01291cebbabc4d6a05a2f 100644
--- a/lib/mocks/acquirerPlugin1.d.ts
+++ b/lib/mocks/acquirerPlugin1.d.ts
@@ -1,6 +1,6 @@
 import { vi } from 'vitest';
 import UIPlugin from '../UIPlugin.ts';
-import type Uppy from '../Uppy.js';
+import type Uppy from '../Uppy.ts';
 type mock = ReturnType<typeof vi.fn>;
 export default class TestSelector1 extends UIPlugin<any, any, any> {
     name: string;
diff --git a/lib/mocks/acquirerPlugin1.js.map b/lib/mocks/acquirerPlugin1.js.map
index 4b0b7c5f5b5b25f65e807b939e48e18d1f24db04..05afacaae928676577e89d8a541d2345e685957d 100644
--- a/lib/mocks/acquirerPlugin1.js.map
+++ b/lib/mocks/acquirerPlugin1.js.map
@@ -1 +1 @@
-{"version":3,"names":["vi","UIPlugin","TestSelector1","constructor","uppy","opts","type","id","name","mocks","run","fn","update","uninstall","results","log","class","method","Promise","resolve","state"],"sources":["acquirerPlugin1.ts"],"sourcesContent":["import { vi } from 'vitest' // eslint-disable-line import/no-extraneous-dependencies\nimport UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.js'\n\ntype mock = ReturnType<typeof vi.fn>\n\nexport default class TestSelector1 extends UIPlugin<any, any, any> {\n  name: string\n\n  mocks: { run: mock; update: mock; uninstall: mock }\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.id = 'TestSelector1'\n    this.name = this.constructor.name\n\n    this.mocks = {\n      run: vi.fn(),\n      update: vi.fn(),\n      uninstall: vi.fn(),\n    }\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n    this.mocks.run(results)\n    return Promise.resolve('success')\n  }\n\n  update(state: any) {\n    this.mocks.update(state)\n  }\n\n  uninstall() {\n    this.mocks.uninstall()\n  }\n}\n"],"mappings":"AAAA,SAASA,EAAE,QAAQ,QAAQ,EAAC;AAC5B,OAAOC,QAAQ,MAAM,gBAAgB;AAKrC,eAAe,MAAMC,aAAa,SAASD,QAAQ,CAAgB;EAKjEE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,IAAI,GAAG,UAAU;IACtB,IAAI,CAACC,EAAE,GAAG,eAAe;IACzB,IAAI,CAACC,IAAI,GAAG,IAAI,CAACL,WAAW,CAACK,IAAI;IAEjC,IAAI,CAACC,KAAK,GAAG;MACXC,GAAG,EAAEV,EAAE,CAACW,EAAE,CAAC,CAAC;MACZC,MAAM,EAAEZ,EAAE,CAACW,EAAE,CAAC,CAAC;MACfE,SAAS,EAAEb,EAAE,CAACW,EAAE,CAAC;IACnB,CAAC;EACH;EAEAD,GAAGA,CAACI,OAAY,EAAE;IAChB,IAAI,CAACV,IAAI,CAACW,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACb,WAAW,CAACK,IAAI;MAC5BS,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IACF,IAAI,CAACL,KAAK,CAACC,GAAG,CAACI,OAAO,CAAC;IACvB,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;EAEAP,MAAMA,CAACQ,KAAU,EAAE;IACjB,IAAI,CAACX,KAAK,CAACG,MAAM,CAACQ,KAAK,CAAC;EAC1B;EAEAP,SAASA,CAAA,EAAG;IACV,IAAI,CAACJ,KAAK,CAACI,SAAS,CAAC,CAAC;EACxB;AACF","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["vi","UIPlugin","TestSelector1","constructor","uppy","opts","type","id","name","mocks","run","fn","update","uninstall","results","log","class","method","Promise","resolve","state"],"sources":["acquirerPlugin1.ts"],"sourcesContent":["import { vi } from 'vitest' // eslint-disable-line import/no-extraneous-dependencies\nimport UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.ts'\n\ntype mock = ReturnType<typeof vi.fn>\n\nexport default class TestSelector1 extends UIPlugin<any, any, any> {\n  name: string\n\n  mocks: { run: mock; update: mock; uninstall: mock }\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.id = 'TestSelector1'\n    this.name = this.constructor.name\n\n    this.mocks = {\n      run: vi.fn(),\n      update: vi.fn(),\n      uninstall: vi.fn(),\n    }\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n    this.mocks.run(results)\n    return Promise.resolve('success')\n  }\n\n  update(state: any) {\n    this.mocks.update(state)\n  }\n\n  uninstall() {\n    this.mocks.uninstall()\n  }\n}\n"],"mappings":"AAAA,SAASA,EAAE,QAAQ,QAAQ,EAAC;AAC5B,OAAOC,QAAQ,MAAM,gBAAgB;AAKrC,eAAe,MAAMC,aAAa,SAASD,QAAQ,CAAgB;EAKjEE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,IAAI,GAAG,UAAU;IACtB,IAAI,CAACC,EAAE,GAAG,eAAe;IACzB,IAAI,CAACC,IAAI,GAAG,IAAI,CAACL,WAAW,CAACK,IAAI;IAEjC,IAAI,CAACC,KAAK,GAAG;MACXC,GAAG,EAAEV,EAAE,CAACW,EAAE,CAAC,CAAC;MACZC,MAAM,EAAEZ,EAAE,CAACW,EAAE,CAAC,CAAC;MACfE,SAAS,EAAEb,EAAE,CAACW,EAAE,CAAC;IACnB,CAAC;EACH;EAEAD,GAAGA,CAACI,OAAY,EAAE;IAChB,IAAI,CAACV,IAAI,CAACW,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACb,WAAW,CAACK,IAAI;MAC5BS,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IACF,IAAI,CAACL,KAAK,CAACC,GAAG,CAACI,OAAO,CAAC;IACvB,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;EAEAP,MAAMA,CAACQ,KAAU,EAAE;IACjB,IAAI,CAACX,KAAK,CAACG,MAAM,CAACQ,KAAK,CAAC;EAC1B;EAEAP,SAASA,CAAA,EAAG;IACV,IAAI,CAACJ,KAAK,CAACI,SAAS,CAAC,CAAC;EACxB;AACF","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/mocks/acquirerPlugin2.d.ts b/lib/mocks/acquirerPlugin2.d.ts
index ef1d366edf2cc94151f5e1871da1746167f90c14..01d971022e3bff0b644c7a4112a1db9c40029326 100644
--- a/lib/mocks/acquirerPlugin2.d.ts
+++ b/lib/mocks/acquirerPlugin2.d.ts
@@ -1,6 +1,6 @@
 import { vi } from 'vitest';
 import UIPlugin from '../UIPlugin.ts';
-import type Uppy from '../Uppy.js';
+import type Uppy from '../Uppy.ts';
 type mock = ReturnType<typeof vi.fn>;
 export default class TestSelector2 extends UIPlugin<any, any, any> {
     name: string;
diff --git a/lib/mocks/acquirerPlugin2.js.map b/lib/mocks/acquirerPlugin2.js.map
index 8a97ea919a04fa6b9184cfd3373f71815b15a4e9..dbacf34fbb3779b170430c9e1970ba5b32551e24 100644
--- a/lib/mocks/acquirerPlugin2.js.map
+++ b/lib/mocks/acquirerPlugin2.js.map
@@ -1 +1 @@
-{"version":3,"names":["vi","UIPlugin","TestSelector2","constructor","uppy","opts","type","id","name","mocks","run","fn","update","uninstall","results","log","class","method","Promise","resolve","state"],"sources":["acquirerPlugin2.ts"],"sourcesContent":["import { vi } from 'vitest' // eslint-disable-line import/no-extraneous-dependencies\nimport UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.js'\n\ntype mock = ReturnType<typeof vi.fn>\n\nexport default class TestSelector2 extends UIPlugin<any, any, any> {\n  name: string\n\n  mocks: { run: mock; update: mock; uninstall: mock }\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.id = 'TestSelector2'\n    this.name = this.constructor.name\n\n    this.mocks = {\n      run: vi.fn(),\n      update: vi.fn(),\n      uninstall: vi.fn(),\n    }\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n    this.mocks.run(results)\n    return Promise.resolve('success')\n  }\n\n  update(state: any) {\n    this.mocks.update(state)\n  }\n\n  uninstall() {\n    this.mocks.uninstall()\n  }\n}\n"],"mappings":"AAAA,SAASA,EAAE,QAAQ,QAAQ,EAAC;AAC5B,OAAOC,QAAQ,MAAM,gBAAgB;AAKrC,eAAe,MAAMC,aAAa,SAASD,QAAQ,CAAgB;EAKjEE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,IAAI,GAAG,UAAU;IACtB,IAAI,CAACC,EAAE,GAAG,eAAe;IACzB,IAAI,CAACC,IAAI,GAAG,IAAI,CAACL,WAAW,CAACK,IAAI;IAEjC,IAAI,CAACC,KAAK,GAAG;MACXC,GAAG,EAAEV,EAAE,CAACW,EAAE,CAAC,CAAC;MACZC,MAAM,EAAEZ,EAAE,CAACW,EAAE,CAAC,CAAC;MACfE,SAAS,EAAEb,EAAE,CAACW,EAAE,CAAC;IACnB,CAAC;EACH;EAEAD,GAAGA,CAACI,OAAY,EAAE;IAChB,IAAI,CAACV,IAAI,CAACW,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACb,WAAW,CAACK,IAAI;MAC5BS,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IACF,IAAI,CAACL,KAAK,CAACC,GAAG,CAACI,OAAO,CAAC;IACvB,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;EAEAP,MAAMA,CAACQ,KAAU,EAAE;IACjB,IAAI,CAACX,KAAK,CAACG,MAAM,CAACQ,KAAK,CAAC;EAC1B;EAEAP,SAASA,CAAA,EAAG;IACV,IAAI,CAACJ,KAAK,CAACI,SAAS,CAAC,CAAC;EACxB;AACF","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["vi","UIPlugin","TestSelector2","constructor","uppy","opts","type","id","name","mocks","run","fn","update","uninstall","results","log","class","method","Promise","resolve","state"],"sources":["acquirerPlugin2.ts"],"sourcesContent":["import { vi } from 'vitest' // eslint-disable-line import/no-extraneous-dependencies\nimport UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.ts'\n\ntype mock = ReturnType<typeof vi.fn>\n\nexport default class TestSelector2 extends UIPlugin<any, any, any> {\n  name: string\n\n  mocks: { run: mock; update: mock; uninstall: mock }\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.id = 'TestSelector2'\n    this.name = this.constructor.name\n\n    this.mocks = {\n      run: vi.fn(),\n      update: vi.fn(),\n      uninstall: vi.fn(),\n    }\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n    this.mocks.run(results)\n    return Promise.resolve('success')\n  }\n\n  update(state: any) {\n    this.mocks.update(state)\n  }\n\n  uninstall() {\n    this.mocks.uninstall()\n  }\n}\n"],"mappings":"AAAA,SAASA,EAAE,QAAQ,QAAQ,EAAC;AAC5B,OAAOC,QAAQ,MAAM,gBAAgB;AAKrC,eAAe,MAAMC,aAAa,SAASD,QAAQ,CAAgB;EAKjEE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,IAAI,GAAG,UAAU;IACtB,IAAI,CAACC,EAAE,GAAG,eAAe;IACzB,IAAI,CAACC,IAAI,GAAG,IAAI,CAACL,WAAW,CAACK,IAAI;IAEjC,IAAI,CAACC,KAAK,GAAG;MACXC,GAAG,EAAEV,EAAE,CAACW,EAAE,CAAC,CAAC;MACZC,MAAM,EAAEZ,EAAE,CAACW,EAAE,CAAC,CAAC;MACfE,SAAS,EAAEb,EAAE,CAACW,EAAE,CAAC;IACnB,CAAC;EACH;EAEAD,GAAGA,CAACI,OAAY,EAAE;IAChB,IAAI,CAACV,IAAI,CAACW,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACb,WAAW,CAACK,IAAI;MAC5BS,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IACF,IAAI,CAACL,KAAK,CAACC,GAAG,CAACI,OAAO,CAAC;IACvB,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;EAEAP,MAAMA,CAACQ,KAAU,EAAE;IACjB,IAAI,CAACX,KAAK,CAACG,MAAM,CAACQ,KAAK,CAAC;EAC1B;EAEAP,SAASA,CAAA,EAAG;IACV,IAAI,CAACJ,KAAK,CAACI,SAAS,CAAC,CAAC;EACxB;AACF","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/mocks/invalidPluginWithoutId.d.ts b/lib/mocks/invalidPluginWithoutId.d.ts
index 5229dd0777444f92366eae1fc0f66190395be009..8e6d0dd148f8cb6edb5d1c51d1772ae19cd3b877 100644
--- a/lib/mocks/invalidPluginWithoutId.d.ts
+++ b/lib/mocks/invalidPluginWithoutId.d.ts
@@ -1,5 +1,5 @@
 import UIPlugin from '../UIPlugin.ts';
-import type Uppy from '../Uppy.js';
+import type Uppy from '../Uppy.ts';
 export default class InvalidPluginWithoutName extends UIPlugin<any, any, any> {
     type: string;
     name: string;
diff --git a/lib/mocks/invalidPluginWithoutId.js.map b/lib/mocks/invalidPluginWithoutId.js.map
index 41787e3bcbd99ca508a7ab7d01003abef4c91f20..3954c87bb91ccda12167aa3227fbd78c6759f2bd 100644
--- a/lib/mocks/invalidPluginWithoutId.js.map
+++ b/lib/mocks/invalidPluginWithoutId.js.map
@@ -1 +1 @@
-{"version":3,"names":["UIPlugin","InvalidPluginWithoutName","constructor","uppy","opts","type","name","run","results","log","class","method","Promise","resolve"],"sources":["invalidPluginWithoutId.ts"],"sourcesContent":["import UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.js'\n\nexport default class InvalidPluginWithoutName extends UIPlugin<any, any, any> {\n  public type: string\n\n  public name: string\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.name = this.constructor.name\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n\n    return Promise.resolve('success')\n  }\n}\n"],"mappings":"AAAA,OAAOA,QAAQ,MAAM,gBAAgB;AAGrC,eAAe,MAAMC,wBAAwB,SAASD,QAAQ,CAAgB;EAK5EE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,IAAI,GAAG,UAAU;IACtB,IAAI,CAACC,IAAI,GAAG,IAAI,CAACJ,WAAW,CAACI,IAAI;EACnC;EAEAC,GAAGA,CAACC,OAAY,EAAE;IAChB,IAAI,CAACL,IAAI,CAACM,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACR,WAAW,CAACI,IAAI;MAC5BK,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IAEF,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;AACF","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["UIPlugin","InvalidPluginWithoutName","constructor","uppy","opts","type","name","run","results","log","class","method","Promise","resolve"],"sources":["invalidPluginWithoutId.ts"],"sourcesContent":["import UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.ts'\n\nexport default class InvalidPluginWithoutName extends UIPlugin<any, any, any> {\n  public type: string\n\n  public name: string\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.name = this.constructor.name\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n\n    return Promise.resolve('success')\n  }\n}\n"],"mappings":"AAAA,OAAOA,QAAQ,MAAM,gBAAgB;AAGrC,eAAe,MAAMC,wBAAwB,SAASD,QAAQ,CAAgB;EAK5EE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,IAAI,GAAG,UAAU;IACtB,IAAI,CAACC,IAAI,GAAG,IAAI,CAACJ,WAAW,CAACI,IAAI;EACnC;EAEAC,GAAGA,CAACC,OAAY,EAAE;IAChB,IAAI,CAACL,IAAI,CAACM,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACR,WAAW,CAACI,IAAI;MAC5BK,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IAEF,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;AACF","ignoreList":[]}
\ No newline at end of file
diff --git a/lib/mocks/invalidPluginWithoutType.d.ts b/lib/mocks/invalidPluginWithoutType.d.ts
index 17cdc8a07c37cd1a92ce4eda01e1d85889191e3d..18005bf89cfd2dca7900dc090604dca097bc1bce 100644
--- a/lib/mocks/invalidPluginWithoutType.d.ts
+++ b/lib/mocks/invalidPluginWithoutType.d.ts
@@ -1,5 +1,5 @@
 import UIPlugin from '../UIPlugin.ts';
-import type Uppy from '../Uppy.js';
+import type Uppy from '../Uppy.ts';
 export default class InvalidPluginWithoutType extends UIPlugin<any, any, any> {
     id: string;
     name: string;
diff --git a/lib/mocks/invalidPluginWithoutType.js.map b/lib/mocks/invalidPluginWithoutType.js.map
index 101e10715c3fecaf152ac54f0975e5038448ae60..aac43deb7f18619320a66e33a418809cafb987b7 100644
--- a/lib/mocks/invalidPluginWithoutType.js.map
+++ b/lib/mocks/invalidPluginWithoutType.js.map
@@ -1 +1 @@
-{"version":3,"names":["UIPlugin","InvalidPluginWithoutType","constructor","uppy","opts","id","name","run","results","log","class","method","Promise","resolve"],"sources":["invalidPluginWithoutType.ts"],"sourcesContent":["import UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.js'\n\nexport default class InvalidPluginWithoutType extends UIPlugin<any, any, any> {\n  public id: string\n\n  public name: string\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.id = 'InvalidPluginWithoutType'\n    this.name = this.constructor.name\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n\n    return Promise.resolve('success')\n  }\n}\n"],"mappings":"AAAA,OAAOA,QAAQ,MAAM,gBAAgB;AAGrC,eAAe,MAAMC,wBAAwB,SAASD,QAAQ,CAAgB;EAK5EE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,EAAE,GAAG,0BAA0B;IACpC,IAAI,CAACC,IAAI,GAAG,IAAI,CAACJ,WAAW,CAACI,IAAI;EACnC;EAEAC,GAAGA,CAACC,OAAY,EAAE;IAChB,IAAI,CAACL,IAAI,CAACM,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACR,WAAW,CAACI,IAAI;MAC5BK,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IAEF,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;AACF","ignoreList":[]}
\ No newline at end of file
+{"version":3,"names":["UIPlugin","InvalidPluginWithoutType","constructor","uppy","opts","id","name","run","results","log","class","method","Promise","resolve"],"sources":["invalidPluginWithoutType.ts"],"sourcesContent":["import UIPlugin from '../UIPlugin.ts'\nimport type Uppy from '../Uppy.ts'\n\nexport default class InvalidPluginWithoutType extends UIPlugin<any, any, any> {\n  public id: string\n\n  public name: string\n\n  constructor(uppy: Uppy<any, any>, opts?: any) {\n    super(uppy, opts)\n    this.id = 'InvalidPluginWithoutType'\n    this.name = this.constructor.name\n  }\n\n  run(results: any) {\n    this.uppy.log({\n      class: this.constructor.name,\n      method: 'run',\n      results,\n    })\n\n    return Promise.resolve('success')\n  }\n}\n"],"mappings":"AAAA,OAAOA,QAAQ,MAAM,gBAAgB;AAGrC,eAAe,MAAMC,wBAAwB,SAASD,QAAQ,CAAgB;EAK5EE,WAAWA,CAACC,IAAoB,EAAEC,IAAU,EAAE;IAC5C,KAAK,CAACD,IAAI,EAAEC,IAAI,CAAC;IACjB,IAAI,CAACC,EAAE,GAAG,0BAA0B;IACpC,IAAI,CAACC,IAAI,GAAG,IAAI,CAACJ,WAAW,CAACI,IAAI;EACnC;EAEAC,GAAGA,CAACC,OAAY,EAAE;IAChB,IAAI,CAACL,IAAI,CAACM,GAAG,CAAC;MACZC,KAAK,EAAE,IAAI,CAACR,WAAW,CAACI,IAAI;MAC5BK,MAAM,EAAE,KAAK;MACbH;IACF,CAAC,CAAC;IAEF,OAAOI,OAAO,CAACC,OAAO,CAAC,SAAS,CAAC;EACnC;AACF","ignoreList":[]}
\ No newline at end of file
diff --git a/package.json b/package.json
index 6ca09869788b9317bdd4f523049c24846f62eaf7..9337a036bd724e6b340fca6d00c1a1d515b0b33c 100644
--- a/package.json
+++ b/package.json
@@ -24,8 +24,8 @@
   },
   "dependencies": {
     "@transloadit/prettier-bytes": "^0.3.4",
-    "@uppy/store-default": "^4.1.0",
-    "@uppy/utils": "^6.0.1",
+    "@uppy/store-default": "workspace:^",
+    "@uppy/utils": "workspace:^",
     "lodash": "^4.17.21",
     "mime-match": "^1.0.2",
     "namespace-emitter": "^2.0.1",
diff --git a/src/BasePlugin.ts b/src/BasePlugin.ts
index 708865be8028b720617b116a4adbd8c7f2e426be..8713e6ee49eca6f4c6b4698a15c9b4cff9c58153 100644
--- a/src/BasePlugin.ts
+++ b/src/BasePlugin.ts
@@ -16,7 +16,7 @@ import type {
   OptionalPluralizeLocale,
 } from '@uppy/utils/lib/Translator'
 import type { Body, Meta } from '@uppy/utils/lib/UppyFile'
-import type { State, UnknownPlugin, Uppy } from './Uppy.js'
+import type { State, UnknownPlugin, Uppy } from './Uppy.ts'

 export type PluginOpts = {
   locale?: Locale
diff --git a/src/EventManager.ts b/src/EventManager.ts
index bb556a9cfe079dfbe42493a67ad4ee2d4f39ad6b..529c38fe62e481ed000ec0bd40ec97d79997beef 100644
--- a/src/EventManager.ts
+++ b/src/EventManager.ts
@@ -1,5 +1,5 @@
 import type { Meta, Body, UppyFile } from '@uppy/utils/lib/UppyFile'
-import type { Uppy, UppyEventMap, _UppyEventMap } from './Uppy.js'
+import type { Uppy, UppyEventMap, _UppyEventMap } from './Uppy.ts'

 /**
  * Create a wrapper around an event emitter with a `remove` method to remove
diff --git a/src/Restricter.ts b/src/Restricter.ts
index a0a490890aa0445c8f1d2a39a94b8b1dcfff3868..09c8622a20c5c9e67f9cce60a79295ccc01aee57 100644
--- a/src/Restricter.ts
+++ b/src/Restricter.ts
@@ -5,7 +5,7 @@ import prettierBytes from '@transloadit/prettier-bytes'
 import match from 'mime-match'
 import type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile'
 import type { I18n } from '@uppy/utils/lib/Translator'
-import type { State, NonNullableUppyOptions } from './Uppy.js'
+import type { State, NonNullableUppyOptions } from './Uppy.ts'

 export type Restrictions = {
   maxFileSize: number | null
diff --git a/src/UIPlugin.ts b/src/UIPlugin.ts
index 74a68fccba6ca0a3ce927e35be3174512e0b91e4..8ea1a490ca32c5671d14d34b3119b230909ae3e4 100644
--- a/src/UIPlugin.ts
+++ b/src/UIPlugin.ts
@@ -5,8 +5,8 @@ import getTextDirection from '@uppy/utils/lib/getTextDirection'

 import type { Body, Meta } from '@uppy/utils/lib/UppyFile'
 import BasePlugin from './BasePlugin.ts'
-import type { PluginOpts } from './BasePlugin.js'
-import type { State } from './Uppy.js'
+import type { PluginOpts } from './BasePlugin.ts'
+import type { State } from './Uppy.ts'

 /**
  * Defer a frequent call to the microtask queue.
diff --git a/src/Uppy.ts b/src/Uppy.ts
index f41356f3de8acd17b6497bbae40f7090dbff454e..da469a99b9f1284a47a0366dbf88b07c7348e456 100644
--- a/src/Uppy.ts
+++ b/src/Uppy.ts
@@ -34,6 +34,7 @@ import type {
 } from '@uppy/utils/lib/Translator'
 import supportsUploadProgress from './supportsUploadProgress.ts'
 import getFileName from './getFileName.ts'
+import getFilePlugins from './getFilePlugins.ts'
 import { justErrorsLogger, debugLogger } from './loggers.ts'
 import {
   Restricter,
@@ -45,8 +46,8 @@ import {
 import packageJson from '../package.json'
 import locale from './locale.ts'

-import type BasePlugin from './BasePlugin.js'
-import type { Restrictions, ValidateableFile } from './Restricter.js'
+import type BasePlugin from './BasePlugin.ts'
+import type { Restrictions, ValidateableFile } from './Restricter.ts'

 type Processor = (
   fileIDs: string[],
@@ -334,6 +335,18 @@ export interface _UppyEventMap<M extends Meta, B extends Body> {
     response?:
       | Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'>
       | undefined,
+  ) => void,
+  'modify-upload-error': (
+    file: UppyFile<M, B> | undefined,
+    error: {
+      name: string
+      message: string
+      request: XMLHttpRequest
+      details?: string
+    },
+    response?:
+      | Omit<NonNullable<UppyFile<M, B>['response']>, 'uploadURL'>
+      | undefined,
   ) => void
   'upload-pause': (file: UppyFile<M, B> | undefined, isPaused: boolean) => void
   'upload-progress': (
@@ -387,10 +400,12 @@ export class Uppy<

   #preProcessors: Set<Processor> = new Set()

-  #uploaders: Set<Processor> = new Set()
+  #uploaders: Map<Processor, string> = new Map()

   #postProcessors: Set<Processor> = new Set()

+  #installingPlugin?: string
+
   defaultLocale: Locale

   locale!: Locale
@@ -676,7 +691,7 @@ export class Uppy<
   }

   addUploader(fn: Processor): void {
-    this.#uploaders.add(fn)
+    this.#uploaders.set(fn, this.#installingPlugin ?? '')
   }

   removeUploader(fn: Processor): boolean {
@@ -956,6 +971,7 @@ export class Uppy<

     const fileType = getFileType(file)
     const fileName = getFileName(fileType, file)
+    const filePlugins = getFilePlugins(file)
     const fileExtension = getFileNameAndExtension(fileName).extension
     const id = getSafeFileId(file, this.getID())

@@ -971,6 +987,7 @@ export class Uppy<
       source: file.source || '',
       id,
       name: fileName,
+      plugins: filePlugins,
       extension: fileExtension || '',
       meta: {
         ...this.getState().meta,
@@ -1534,7 +1551,7 @@ export class Uppy<
     ) => {
       let errorMsg = error.message || 'Unknown error'
       if (error.details) {
-        errorMsg += ` ${error.details}`
+        errorMsg += `: ${error.details}`
       }

       this.setState({ error: errorMsg })
@@ -1550,8 +1567,6 @@ export class Uppy<
     this.on('error', errorHandler)

     this.on('upload-error', (file, error, response) => {
-      errorHandler(error, file, response)
-
       if (typeof error === 'object' && error.message) {
         this.log(error.message, 'error')
         const newError = new Error(
@@ -1562,9 +1577,17 @@ export class Uppy<
         if (error.details) {
           newError.details += ` ${error.details}`
         }
+
+        // @ts-expect-error
+        newError.request = error.request
+
+        this.emit('modify-upload-error', file, newError, response)
         this.#informAndEmit([newError])
+        errorHandler(newError, file, response)
       } else {
+        this.emit('modify-upload-error', file, error as any, response)
         this.#informAndEmit([error])
+        errorHandler(error, file, response)
       }
     })

@@ -1814,8 +1837,13 @@ export class Uppy<
     } else {
       this.#plugins[plugin.type] = [plugin]
     }
+
+    this.#installingPlugin = pluginId
+
     plugin.install()

+    this.#installingPlugin = undefined
+
     this.emit('plugin-added', plugin)

     return this
@@ -2099,7 +2127,7 @@ export class Uppy<

     const steps = [
       ...this.#preProcessors,
-      ...this.#uploaders,
+      ...this.#uploaders.keys(),
       ...this.#postProcessors,
     ]
     try {
@@ -2120,12 +2148,22 @@ export class Uppy<
         })

         const { fileIDs } = currentUpload
-
+        let uploaderFileIds = fileIDs
+        const uploaderPlugin = this.#uploaders.get(fn)
+        if (uploaderPlugin) {
+          const files = this.getFilesByIds(uploaderFileIds)
+          uploaderFileIds = files
+            .filter(
+              (file) =>
+                file.plugins?.includes(uploaderPlugin) ||
+                file.plugins?.length === 0,
+            )
+            .map((file) => file.id)
+        }
         // TODO give this the `updatedUpload` object as its only parameter maybe?
         // Otherwise when more metadata may be added to the upload this would keep getting more parameters
-        await fn(fileIDs, uploadID)
+        await fn(uploaderFileIds, uploadID)

-        // Update currentUpload value in case it was modified asynchronously.
         currentUpload = getCurrentUpload()
       }
     } catch (err) {
diff --git a/src/getFilePlugins.ts b/src/getFilePlugins.ts
new file mode 100644
index 0000000000000000000000000000000000000000..84b17bfd243f834911cc8a7fc172f735d2257467
--- /dev/null
+++ b/src/getFilePlugins.ts
@@ -0,0 +1,5 @@
+export default function getFilePlugins(fileDescriptor: {
+  plugins?: string[]
+}): string[] {
+  return fileDescriptor.plugins || []
+}
diff --git a/src/mocks/acquirerPlugin1.ts b/src/mocks/acquirerPlugin1.ts
index 6d0b96724068e9d9e0ce4b8a284a9b9363d71b01..0f3516690d8af73ca59887835f39851ca3018502 100644
--- a/src/mocks/acquirerPlugin1.ts
+++ b/src/mocks/acquirerPlugin1.ts
@@ -1,6 +1,6 @@
 import { vi } from 'vitest' // eslint-disable-line import/no-extraneous-dependencies
 import UIPlugin from '../UIPlugin.ts'
-import type Uppy from '../Uppy.js'
+import type Uppy from '../Uppy.ts'

 type mock = ReturnType<typeof vi.fn>

diff --git a/src/mocks/acquirerPlugin2.ts b/src/mocks/acquirerPlugin2.ts
index d841bdeb72a39104bd0f76662cb20af37c2de73a..9d2290b69da633ac708b1b5c8673f1b580b3b623 100644
--- a/src/mocks/acquirerPlugin2.ts
+++ b/src/mocks/acquirerPlugin2.ts
@@ -1,6 +1,6 @@
 import { vi } from 'vitest' // eslint-disable-line import/no-extraneous-dependencies
 import UIPlugin from '../UIPlugin.ts'
-import type Uppy from '../Uppy.js'
+import type Uppy from '../Uppy.ts'

 type mock = ReturnType<typeof vi.fn>

diff --git a/src/mocks/invalidPluginWithoutId.ts b/src/mocks/invalidPluginWithoutId.ts
index 8d6789eff058dac8656952081ba6528a2a60684a..d2c02e30dcfbaf7aa8f9ad5f1621a1118850d691 100644
--- a/src/mocks/invalidPluginWithoutId.ts
+++ b/src/mocks/invalidPluginWithoutId.ts
@@ -1,5 +1,5 @@
 import UIPlugin from '../UIPlugin.ts'
-import type Uppy from '../Uppy.js'
+import type Uppy from '../Uppy.ts'

 export default class InvalidPluginWithoutName extends UIPlugin<any, any, any> {
   public type: string
diff --git a/src/mocks/invalidPluginWithoutType.ts b/src/mocks/invalidPluginWithoutType.ts
index 8485f491edc4acc75c97720938f2fa7d76230258..4baeb573c97e2d3130213dc1ecae12594708b01b 100644
--- a/src/mocks/invalidPluginWithoutType.ts
+++ b/src/mocks/invalidPluginWithoutType.ts
@@ -1,5 +1,5 @@
 import UIPlugin from '../UIPlugin.ts'
-import type Uppy from '../Uppy.js'
+import type Uppy from '../Uppy.ts'

 export default class InvalidPluginWithoutType extends UIPlugin<any, any, any> {
   public id: string
